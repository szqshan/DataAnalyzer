<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ (å¤šç”¨æˆ·ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- æ·»åŠ CORSç­–ç•¥å…ƒæ ‡ç­¾ -->
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' http://localhost:5000 ws://localhost:5000 http://127.0.0.1:5000 ws://127.0.0.1:5000;">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1400px;
        }
        
        .chat-container {
            height: 600px;
            background: #f8f9fa;
            border-radius: 15px;
            overflow-y: auto;
            padding: 20px;
            border: 2px solid #e9ecef;
        }
        
        .message {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            text-align: right;
        }
        
        .user-message .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 5px 20px;
            padding: 15px 20px;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .ai-message .message-bubble {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 20px 20px 20px 5px;
            padding: 15px 20px;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .system-message {
            text-align: center;
            margin: 10px 0;
        }
        
        .system-message .message-bubble {
            background: var(--warning-gradient);
            color: white;
            border-radius: 15px;
            padding: 8px 15px;
            display: inline-block;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(250, 112, 154, 0.3);
        }
        
        .status-card {
            background: var(--success-gradient);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            height: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-outline-gradient {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-gradient:hover {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
        }
        
        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .file-upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.15);
            transform: scale(1.02);
        }
        
        .sql-display {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .memory-card {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar {
            height: calc(100vh - 100px);
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            height: calc(100vh - 100px);
        }
        
        .tab-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            border-radius: 10px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .progress-custom .progress-bar {
            background: var(--primary-gradient);
            border-radius: 4px;
        }
        
        .connection-indicator {
            position: relative;
            display: inline-block;
        }
        
        .connection-indicator::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .connection-indicator.connected::before {
            background: #28a745;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* æµå¼æ˜¾ç¤ºæ ·å¼ */
        .streaming-content {
            position: relative;
        }
        
        .status-indicators {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .typing-indicator .dot {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .ai-response-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .sql-display code {
            color: #e2e8f0;
            background: transparent;
        }
        
        .badge {
            font-size: 0.75em;
        }
        
        .status-indicators .badge {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-custom {
            height: 6px;
            border-radius: 3px;
            background-color: rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        /* æ¸å…¥åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨å®¹å™¨ */
        .status-indicators {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        /* æ‰“å­—æŒ‡ç¤ºå™¨æ ·å¼å¢å¼º */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin-top: 5px;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            width: fit-content;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            opacity: 0.4;
        }
        
        .typing-indicator span:nth-child(1) {
            animation: pulse 1s infinite 0.1s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation: pulse 1s infinite 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation: pulse 1s infinite 0.3s;
        }
        
        .typing-indicator span:nth-child(4) {
            animation: pulse 1s infinite 0.4s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 0.4; }
        }
        
        /* SQLæ˜¾ç¤ºåŒºåŸŸå¢å¼º */
        .sql-display {
            background-color: rgba(0,0,0,0.02);
            border-radius: 5px;
            padding: 8px;
            border-left: 3px solid #6c757d;
        }
        
        .sql-display code {
            display: block;
            white-space: pre-wrap;
            padding: 5px;
            background-color: rgba(0,0,0,0.03);
            border-radius: 3px;
            font-size: 0.85rem;
            color: #333;
        }
        
        /* è­¦å‘Šæ¡†æ ·å¼å¢å¼º */
        .alert-custom {
            border-radius: 5px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸ¤– æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ (å¤šç”¨æˆ·ç‰ˆ)</span>
            <div class="navbar-nav ms-auto">
                <span class="nav-link text-white" id="user-display">
                    <i class="bi bi-person-circle"></i> æ­£åœ¨è¯†åˆ«ç”¨æˆ·...
                </span>
                <span class="nav-link text-white">
                    <i class="bi bi-database"></i> 
                    <span id="connection-status" class="connection-indicator">æ£€æŸ¥ä¸­...</span>
                </span>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="userManager.switchUser()" title="åˆ‡æ¢ç”¨æˆ·">
                    <i class="bi bi-person-gear"></i>
                </button>
                <button class="btn btn-outline-light btn-sm ms-1" onclick="userManager.logout()" title="é€€å‡ºç™»å½•">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- å·¦ä¾§è¾¹æ  -->
            <div class="col-md-3">
                <div class="sidebar">
                    <!-- ç”¨æˆ·çŠ¶æ€å’Œæ•°æ®åº“çŠ¶æ€åˆå¹¶å¡ç‰‡ -->
                    <div class="status-card">
                        <!-- ç”¨æˆ·ä¿¡æ¯å°†ç”± userManager åŠ¨æ€æ·»åŠ  -->
                        <h6><i class="bi bi-database-fill"></i> æ•°æ®åº“çŠ¶æ€</h6>
                        <div id="db-status">
                            <small>æ•°æ®åº“: <span id="db-path">æ£€æŸ¥ä¸­...</span></small><br>
                            <small>è¡¨å: <span id="table-name">N/A</span></small><br>
                            <small>è®°å½•æ•°: <span id="record-count">0</span></small>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="card feature-card mb-3">
                        <h6><i class="bi bi-lightning-fill"></i> å¿«é€Ÿæ“ä½œ</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-gradient btn-sm" onclick="showTab('upload')">
                                <i class="bi bi-upload"></i> ä¸Šä¼ æ•°æ®
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showTab('analysis')">
                                <i class="bi bi-chat-dots"></i> æ™ºèƒ½åˆ†æ
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showComingSoon('æŸ¥çœ‹è®°å¿†')">
                                <i class="bi bi-journal-text"></i> æŸ¥çœ‹è®°å¿†
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showComingSoon('æ¸…ç©ºè®°å¿†')">
                                <i class="bi bi-trash"></i> æ¸…ç©ºè®°å¿†
                            </button>
                        </div>
                    </div>

                    <!-- åˆ†æç»Ÿè®¡ -->
                    <div class="card feature-card mb-3">
                        <h6><i class="bi bi-graph-up"></i> åˆ†æç»Ÿè®¡</h6>
                        <div id="memory-stats">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 text-primary mb-0" id="conversation-count">0</div>
                                    <small class="text-muted">å¯¹è¯æ•°</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 text-success mb-0" id="sql-count">0</div>
                                    <small class="text-muted">SQLæŸ¥è¯¢</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ·ç®¡ç†å·¥å…· -->
                    <div class="card feature-card">
                        <h6><i class="bi bi-people"></i> ç”¨æˆ·ç®¡ç†</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-gradient btn-sm" onclick="showUsersList()">
                                <i class="bi bi-list"></i> æ‰€æœ‰ç”¨æˆ·
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="userManager.switchUser()">
                                <i class="bi bi-person-plus"></i> åˆ‡æ¢ç”¨æˆ·
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showUserStats()">
                                <i class="bi bi-pie-chart"></i> ç”¨æˆ·ç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-md-9">
                <div class="main-content">
                    <!-- é€‰é¡¹å¡å¯¼èˆª -->
                    <ul class="nav nav-pills mb-3" id="main-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-tab="upload" href="#upload-tab">
                                <i class="bi bi-upload"></i> æ•°æ®ä¸Šä¼ 
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="analysis" href="#analysis-tab">
                                <i class="bi bi-chat-dots"></i> æ™ºèƒ½åˆ†æ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="memory" href="#memory-tab">
                                <i class="bi bi-journal-text"></i> åˆ†æè®°å¿† <span class="badge bg-warning">å¼€å‘ä¸­</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="results" href="#results-tab">
                                <i class="bi bi-file-earmark-text"></i> ç»“æœæŠ¥å‘Š <span class="badge bg-warning">å¼€å‘ä¸­</span>
                            </a>
                        </li>
                    </ul>

                    <!-- é€‰é¡¹å¡å†…å®¹ -->
                    <div class="tab-content">
                        <!-- æ•°æ®ä¸Šä¼ æ ‡ç­¾é¡µ -->
                        <div id="upload-tab" class="tab-pane active">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="file-upload-area" id="file-upload-area">
                                        <i class="bi bi-cloud-upload display-1 text-primary mb-3"></i>
                                        <h5>æ‹–æ‹½CSVæ–‡ä»¶åˆ°è¿™é‡Œ</h5>
                                        <p class="text-muted">æˆ–è€…ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                        <p class="text-muted"><small>æ¯ä¸ªç”¨æˆ·çš„æ•°æ®å°†ç‹¬ç«‹å­˜å‚¨</small></p>
                                        <input type="file" id="csv-file" accept=".csv" style="display: none;">
                                        <button class="btn btn-gradient mt-2" onclick="document.getElementById('csv-file').click()">
                                            é€‰æ‹©æ–‡ä»¶
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card feature-card">
                                        <h6><i class="bi bi-gear"></i> å¯¼å…¥è®¾ç½®</h6>
                                        <div class="mb-3">
                                            <label class="form-label">è¡¨å</label>
                                            <input type="text" class="form-control" id="table-name-input" value="data_table" placeholder="è¾“å…¥è¡¨å">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">æ•°æ®åº“åç§°</label>
                                            <input type="text" class="form-control" id="db-path-input" value="analysis.db" placeholder="æ•°æ®åº“æ–‡ä»¶å">
                                            <small class="text-muted">å°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„ä¸“å±ç›®å½•</small>
                                        </div>
                                        <button class="btn btn-gradient w-100" id="upload-btn" disabled>
                                            <i class="bi bi-upload"></i> å¼€å§‹å¯¼å…¥
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸Šä¼ è¿›åº¦ -->
                            <div id="upload-progress" class="mt-4" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h6><i class="bi bi-hourglass-split"></i> æ­£åœ¨å¤„ç†...</h6>
                                        <div class="progress progress-custom">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-2 d-block" id="upload-status">å‡†å¤‡ä¸Šä¼ ...</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ™ºèƒ½åˆ†ææ ‡ç­¾é¡µ -->
                        <div id="analysis-tab" class="tab-pane">
                            <div class="row h-100">
                                <div class="col-12">
                                    <!-- åˆ†æèŠå¤©ç•Œé¢ -->
                                    <div class="chat-container" id="chat-container">
                                        <div class="message system-message">
                                            <div class="message-bubble">
                                                ğŸ¤– æ™ºèƒ½åˆ†æåŠ©æ‰‹å·²å°±ç»ªï¼Œæ”¯æŒå¤šç”¨æˆ·æ•°æ®éš”ç¦»
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- è¾“å…¥åŒºåŸŸ -->
                                    <div class="mt-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="analysis-input" 
                                                   placeholder="è¯·æè¿°æ‚¨çš„åˆ†æéœ€æ±‚..." style="border-radius: 10px 0 0 10px;">
                                            <button class="btn btn-gradient" id="send-analysis" style="border-radius: 0 10px 10px 0;">
                                                <i class="bi bi-send"></i> å‘é€
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                ğŸ’¡ ç¤ºä¾‹: "åˆ†ææ•°æ®åŸºæœ¬æƒ…å†µ" | "ç”Ÿæˆé”€å”®æŠ¥å‘Š" | "æ£€æŸ¥å¼‚å¸¸å€¼"
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- åŠ è½½çŠ¶æ€ -->
                                    <div class="loading-spinner" id="analysis-loading">
                                        <div class="spinner-border spinner-border-custom text-primary" role="status">
                                            <span class="visually-hidden">åˆ†æä¸­...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Claudeæ­£åœ¨ä¸ºæ‚¨è¿›è¡Œä¸“å±åˆ†æ...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åˆ†æè®°å¿†æ ‡ç­¾é¡µ -->
                        <div id="memory-tab" class="tab-pane">
                            <div class="alert alert-info alert-custom">
                                <h6><i class="bi bi-info-circle"></i> åŠŸèƒ½å¼€å‘ä¸­</h6>
                                <p class="mb-0">å¤šç”¨æˆ·è®°å¿†ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
                                <small class="text-muted">å°†åœ¨P1é˜¶æ®µå®Œæˆæ­¤åŠŸèƒ½</small>
                            </div>
                        </div>

                        <!-- ç»“æœæŠ¥å‘Šæ ‡ç­¾é¡µ -->
                        <div id="results-tab" class="tab-pane">
                            <div class="alert alert-info alert-custom">
                                <h6><i class="bi bi-info-circle"></i> åŠŸèƒ½å¼€å‘ä¸­</h6>
                                <p class="mb-0">å¤šç”¨æˆ·æŠ¥å‘Šç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
                                <small class="text-muted">å°†åœ¨P1é˜¶æ®µå®Œæˆæ­¤åŠŸèƒ½</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ç”¨æˆ·ç®¡ç†è„šæœ¬ -->
    <script src="user_manager.js"></script>
    
    <!-- APIç±»è„šæœ¬ -->
    <script src="api.js"></script>
    
    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let currentState = {
            dbConnected: false,
            dbPath: '',
            tableName: '',
            recordCount: 0,
            conversationCount: 0,
            sqlCount: 0,
            backendConnected: false,
            currentAnalysisId: null,
            isAnalyzing: false
        };

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        async function checkSystemStatus() {
            const connectionIndicator = document.getElementById('connection-status');
            
            try {
                connectionIndicator.textContent = 'è¿æ¥ä¸­...';
                connectionIndicator.className = 'connection-indicator';
                
                const status = await api.getSystemStatus();
                
                // æ›´æ–°è¿æ¥çŠ¶æ€
                currentState.backendConnected = true;
                connectionIndicator.textContent = 'å·²è¿æ¥';
                connectionIndicator.className = 'connection-indicator connected';
                
                // æ›´æ–°æ•°æ®åº“çŠ¶æ€
                if (status.database_connected) {
                    updateDBStatus(
                        status.database_path,
                        status.table_name,
                        status.record_count
                    );
                } else {
                    document.getElementById('db-path').textContent = 'æœªè¿æ¥';
                    document.getElementById('table-name').textContent = 'N/A';
                    document.getElementById('record-count').textContent = '0';
                }
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                if (status.memory_stats) {
                    currentState.conversationCount = status.memory_stats.conversation_count || 0;
                    currentState.sqlCount = status.memory_stats.total_sql_calls || 0;
                    updateStats();
                }
                
                return status;
                
            } catch (error) {
                currentState.backendConnected = false;
                connectionIndicator.textContent = 'è¿æ¥å¤±è´¥';
                connectionIndicator.className = 'connection-indicator';
                
                console.error('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                return null;
            }
        }

        // æ›´æ–°æ•°æ®åº“çŠ¶æ€
        function updateDBStatus(dbPath, tableName, recordCount) {
            currentState.dbConnected = true;
            currentState.dbPath = dbPath;
            currentState.tableName = tableName;
            currentState.recordCount = recordCount;

            document.getElementById('db-path').textContent = dbPath || 'æœªçŸ¥';
            document.getElementById('table-name').textContent = tableName || 'N/A';
            document.getElementById('record-count').textContent = recordCount.toLocaleString();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('conversation-count').textContent = currentState.conversationCount;
            document.getElementById('sql-count').textContent = currentState.sqlCount;
        }

        // é€‰é¡¹å¡åˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // å¯¼èˆªç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.getAttribute('data-tab');
                showTab(tabName);
            });
        });

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const fileUploadArea = document.getElementById('file-upload-area');
        const csvFileInput = document.getElementById('csv-file');
        const uploadBtn = document.getElementById('upload-btn');

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                handleFileSelection(files[0]);
            }
        });

        fileUploadArea.addEventListener('click', () => {
            csvFileInput.click();
        });

        csvFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name);
            uploadBtn.disabled = false;
            
            const user = userManager.getCurrentUser();
            const userInfo = user ? `ç”¨æˆ·: ${user.username}` : 'æœªç™»å½•ç”¨æˆ·';
            
            fileUploadArea.innerHTML = `
                <i class="bi bi-file-earmark-check display-1 text-success mb-3"></i>
                <h5>æ–‡ä»¶å·²é€‰æ‹©: ${file.name}</h5>
                <p class="text-muted">å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <p class="text-muted">${userInfo}</p>
                <button class="btn btn-outline-gradient mt-2" onclick="document.getElementById('csv-file').click()">
                    é‡æ–°é€‰æ‹©
                </button>
            `;
        }

        // æ–‡ä»¶ä¸Šä¼ å‡½æ•°
        async function uploadFile(file, tableName, dbPath) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const statusText = document.getElementById('upload-status');
            
            progressDiv.style.display = 'block';
            uploadBtn.disabled = true;
            
            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
                if (!userManager.isLoggedIn()) {
                    throw new Error('è¯·å…ˆå®Œæˆç”¨æˆ·èº«ä»½è¯†åˆ«');
                }
                
                // æ£€æŸ¥åç«¯è¿æ¥
                if (!currentState.backendConnected) {
                    throw new Error('åç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨');
                }
                
                const user = userManager.getCurrentUser();
                statusText.textContent = `ç”¨æˆ· ${user.username} æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...`;
                console.log(`å¼€å§‹ä¸Šä¼ æ–‡ä»¶: ${file.name}, å¤§å°: ${file.size} å­—èŠ‚`);
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `ç”¨æˆ· ${user.username} ä¸Šä¼ ä¸­... ${Math.round(progress)}%`;
                }, 300);
                
                // è°ƒç”¨çœŸå®API
                try {
                    console.log(`è°ƒç”¨APIä¸Šä¼ æ–‡ä»¶: ${file.name}, è¡¨å: ${tableName}`);
                    const result = await api.uploadCSV(file, tableName, dbPath);
                    console.log("ä¸Šä¼ æˆåŠŸï¼ŒæœåŠ¡å™¨è¿”å›:", result);
                    
                    // æ¸…é™¤è¿›åº¦åŠ¨ç”»
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    statusText.textContent = 'ä¸Šä¼ æˆåŠŸï¼æ•°æ®å·²ä¿å­˜åˆ°ç”¨æˆ·ä¸“å±ç›®å½•';
                    
                    // æ›´æ–°æ•°æ®åº“çŠ¶æ€
                    updateDBStatus(
                        result.data.db_path,
                        result.data.table_name,
                        result.data.rows_imported
                    );
                    
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        uploadBtn.disabled = false;
                        showSuccessMessage(`${result.message} (ç”¨æˆ·: ${user.username})`);
                        showTab('analysis');
                    }, 1000);
                } catch (apiError) {
                    clearInterval(progressInterval);
                    console.error("APIè°ƒç”¨å¤±è´¥:", apiError);
                    statusText.textContent = `ä¸Šä¼ å¤±è´¥: ${apiError.message}`;
                    progressBar.style.width = '0%';
                    progressBar.className = 'progress-bar bg-danger';
                    uploadBtn.disabled = false;
                    showErrorMessage(`ä¸Šä¼ å¤±è´¥: ${apiError.message}`);
                    
                    // å°è¯•é‡æ–°æ£€æŸ¥è¿æ¥
                    setTimeout(async () => {
                        try {
                            await api.healthCheck();
                            progressBar.className = 'progress-bar';
                            statusText.textContent = 'æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼Œè¯·é‡è¯•ä¸Šä¼ ';
                        } catch (e) {
                            statusText.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨';
                        }
                    }, 2000);
                }
                
            } catch (error) {
                statusText.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                progressBar.style.width = '0%';
                progressBar.className = 'progress-bar bg-danger';
                uploadBtn.disabled = false;
                showErrorMessage('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        uploadBtn.addEventListener('click', async () => {
            const file = csvFileInput.files[0];
            if (!file) {
                showErrorMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const tableName = document.getElementById('table-name-input').value.trim();
            const dbPath = document.getElementById('db-path-input').value.trim();

            if (!tableName || !dbPath) {
                showErrorMessage('è¯·å¡«å†™è¡¨åå’Œæ•°æ®åº“è·¯å¾„');
                return;
            }
            
            console.log(`å‡†å¤‡ä¸Šä¼ æ–‡ä»¶: ${file.name}, è¡¨å: ${tableName}, æ•°æ®åº“: ${dbPath}`);
            await uploadFile(file, tableName, dbPath);
        });

        // æµå¼æ™ºèƒ½åˆ†æå¤„ç†
        const analysisInput = document.getElementById('analysis-input');
        const sendAnalysisBtn = document.getElementById('send-analysis');
        const chatContainer = document.getElementById('chat-container');
        const analysisLoading = document.getElementById('analysis-loading');

        sendAnalysisBtn.addEventListener('click', sendAnalysisStream);
        analysisInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !currentState.isAnalyzing) {
                sendAnalysisStream();
            }
        });

        // å‘é€æµå¼åˆ†æè¯·æ±‚
        async function sendAnalysisStream() {
            const user = userManager.getCurrentUser();
            
            if (!user) {
                showErrorMessage("è¯·å…ˆç™»å½•å†è¿›è¡Œåˆ†æ");
                return;
            }
            
            if (!currentState.backendConnected) {
                showErrorMessage("åç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·ç¨åå†è¯•");
                return;
            }
            
            if (!currentState.dbConnected) {
                showErrorMessage("æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆä¸Šä¼ æˆ–é€‰æ‹©æ•°æ®");
                return;
            }
            
            const query = analysisInput.value.trim();
            if (!query) {
                showErrorMessage("è¯·è¾“å…¥åˆ†æéœ€æ±‚");
                return;
            }
            
            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            analysisInput.disabled = true;
            sendAnalysisBtn.disabled = true;
            
            try {
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
                const messageId = 'message-' + Date.now();
                const messageDiv = createStreamingMessageContainer(messageId, query);
                chatContainer.appendChild(messageDiv);
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // è·å–æ¶ˆæ¯å®¹å™¨ä¸­çš„çŠ¶æ€æŒ‡ç¤ºå™¨å’ŒAIå“åº”å†…å®¹
                const statusIndicators = messageDiv.querySelector('.status-indicators');
                const aiResponseContent = messageDiv.querySelector('.ai-response-content');
                const typingIndicator = messageDiv.querySelector('.typing-indicator');
                
                // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
                statusIndicators.innerHTML = `
                    <div class="alert alert-info alert-custom py-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">è¿æ¥ä¸­...</span>
                            </div>
                            <small>æ­£åœ¨è¿æ¥åˆ†ææœåŠ¡...</small>
                        </div>
                    </div>`;
                
                // æ·»åŠ è¿›åº¦æ¡
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress progress-custom mt-2';
                progressDiv.innerHTML = `<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 5%"></div>`;
                progressDiv.id = `${messageId}-progress`;
                statusIndicators.appendChild(progressDiv);
                
                // æ·»åŠ çŠ¶æ€æ–‡æœ¬
                const statusDiv = document.createElement('div');
                statusDiv.className = 'text-center mt-1';
                statusDiv.innerHTML = `<small class="text-muted" id="${messageId}-status">åˆå§‹åŒ–åˆ†æè¯·æ±‚...</small>`;
                statusIndicators.appendChild(statusDiv);
                
                // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
                typingIndicator.style.display = 'flex';
                
                // å‘èµ·æµå¼è¯·æ±‚
                const response = await api.analyzeStream(query);
                
                // å¤„ç†æµå¼å“åº”
                processStreamingResponse(response, messageId);
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats();
                
            } catch (error) {
                console.error('æµå¼åˆ†æè¯·æ±‚å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMsg = error.message || 'è¿æ¥åˆ†ææœåŠ¡å¤±è´¥';
                handleStreamingData({
                    type: 'error',
                    message: errorMsg
                }, messageId);
                
                showErrorMessage(`åˆ†æè¯·æ±‚å¤±è´¥: ${errorMsg}`);
            } finally {
                // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                analysisInput.disabled = false;
                sendAnalysisBtn.disabled = false;
                analysisInput.focus();
            }
        }

        // å¤„ç†æµå¼å“åº”
        function processStreamingResponse(response, messageId) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            console.log('å¼€å§‹å¤„ç†æµå¼å“åº”');
            
            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            handleStreamingData({
                type: 'start',
                message: 'æ­£åœ¨è¿æ¥åˆ†ææœåŠ¡...'
            }, messageId);
            
            // å¤„ç†æ•°æ®æµ
            function processStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        console.log('æµå¼å“åº”å®Œæˆ');
                        
                        // å¤„ç†ç¼“å†²åŒºä¸­çš„æœ€åæ•°æ®
                        if (buffer.trim()) {
                            try {
                                processBufferData(buffer, messageId);
                            } catch (e) {
                                console.error('å¤„ç†æœ€ç»ˆç¼“å†²æ•°æ®å¤±è´¥:', e);
                            }
                        }
                        
                        // ç¡®ä¿æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                        handleStreamingData({
                            type: 'complete',
                            message: 'åˆ†æå®Œæˆ'
                        }, messageId);
                        
                        return;
                    }
                    
                    // è§£ç å¹¶æ·»åŠ åˆ°ç¼“å†²åŒº
                    const chunk = decoder.decode(value, { stream: true });
                    console.log(`æ¥æ”¶åˆ°æ•°æ®å—: ${chunk.length} å­—ç¬¦`);
                    buffer += chunk;
                    
                    // å¤„ç†ç¼“å†²åŒºæ•°æ®
                    try {
                        processBufferData(buffer, messageId);
                        
                        // æ¸…ç†å·²å¤„ç†çš„æ•°æ®ï¼Œä¿ç•™å¯èƒ½ä¸å®Œæ•´çš„æœ€åä¸€è¡Œ
                        const lastNewlineIndex = buffer.lastIndexOf('\n');
                        if (lastNewlineIndex !== -1) {
                            buffer = buffer.substring(lastNewlineIndex + 1);
                        }
                        
                        // é˜²æ­¢ç¼“å†²åŒºè¿‡å¤§
                        if (buffer.length > 10000) {
                            buffer = buffer.substring(buffer.length - 5000);
                            console.warn('ç¼“å†²åŒºè¿‡å¤§ï¼Œå·²æˆªæ–­');
                        }
                    } catch (e) {
                        console.error('å¤„ç†ç¼“å†²æ•°æ®å¤±è´¥:', e);
                    }
                    
                    // ç»§ç»­å¤„ç†æµ
                    processStream();
                }).catch(error => {
                    console.error('è¯»å–æµå¤±è´¥:', error);
                    handleStreamingData({
                        type: 'error',
                        message: 'è¯»å–æ•°æ®æµå¤±è´¥: ' + error.message
                    }, messageId);
                });
            }
            
            // å¼€å§‹å¤„ç†æµ
            processStream();
        }
        
        // å¤„ç†ç¼“å†²åŒºæ•°æ®
        function processBufferData(buffer, messageId) {
            // æŒ‰è¡Œåˆ†å‰²
            const lines = buffer.split('\n');
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼æ•°æ®
                if (line.startsWith('data: ')) {
                    const jsonStr = line.substring(6);
                    try {
                        const data = JSON.parse(jsonStr);
                        handleStreamingData(data, messageId);
                    } catch (e) {
                        console.warn('è§£æJSONå¤±è´¥ (SSEæ ¼å¼):', jsonStr, e);
                    }
                } else {
                    // å°è¯•ç›´æ¥è§£æJSON
                    try {
                        const data = JSON.parse(line);
                        handleStreamingData(data, messageId);
                    } catch (e) {
                        // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå¯èƒ½æ˜¯éƒ¨åˆ†æ•°æ®æˆ–å…¶ä»–æ ¼å¼
                        console.debug('è¡Œä¸æ˜¯æœ‰æ•ˆJSON:', line.substring(0, 100) + (line.length > 100 ? '...' : ''));
                    }
                }
            }
        }

        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        function createStreamingMessageContainer(messageId, userMessage) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container mb-4';
            messageDiv.id = messageId;
            
            // ç”¨æˆ·æ¶ˆæ¯éƒ¨åˆ†
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message mb-2';
            userMessageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="user-avatar me-2">
                        <img src="assets/img/user-avatar.png" alt="User" width="32" height="32" class="rounded-circle">
                    </div>
                    <div class="user-message-content">
                        <div class="mb-1"><strong>æ‚¨</strong> <small class="text-muted">${new Date().toLocaleTimeString()}</small></div>
                        <div>${userMessage}</div>
                    </div>
                </div>
            `;
            
            // AIå›å¤éƒ¨åˆ†
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'ai-message mt-2';
            aiMessageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="ai-avatar me-2">
                        <img src="assets/img/ai-avatar.png" alt="AI" width="32" height="32" class="rounded-circle">
                    </div>
                    <div class="ai-message-content flex-grow-1">
                        <div class="mb-1"><strong>æ™ºèƒ½åˆ†æåŠ©æ‰‹</strong> <small class="text-muted">${new Date().toLocaleTimeString()}</small></div>
                        <div class="status-indicators"></div>
                        <div class="ai-response-content"></div>
                        <div class="typing-indicator" style="display: none;">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(userMessageDiv);
            messageDiv.appendChild(aiMessageDiv);
            
            return messageDiv;
        }

        // å¤„ç†æµå¼æ•°æ®
        function handleStreamingData(data, messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const statusIndicators = messageDiv.querySelector('.status-indicators');
            const aiResponseContent = messageDiv.querySelector('.ai-response-content');
            const typingIndicator = messageDiv.querySelector('.typing-indicator');
            
            console.log('å¤„ç†æ•°æ®ç±»å‹:', data.type);
            
            // ç¡®ä¿æ‰“å­—æŒ‡ç¤ºå™¨æ˜¾ç¤º
            if (data.type !== 'complete' && data.type !== 'error') {
                typingIndicator.style.display = 'flex';
            }
            
            switch (data.type) {
                case 'start':
                    statusIndicators.innerHTML = `
                        <div class="alert alert-info alert-custom py-2">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <small>${data.message}</small>
                            </div>
                        </div>`;
                    
                    // æ·»åŠ è¿›åº¦æ¡
                    const progressDiv = document.createElement('div');
                    progressDiv.className = 'progress progress-custom mt-2';
                    progressDiv.innerHTML = `<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 5%"></div>`;
                    progressDiv.id = `${messageId}-progress`;
                    statusIndicators.appendChild(progressDiv);
                    
                    // æ·»åŠ çŠ¶æ€æ–‡æœ¬
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'text-center mt-1';
                    statusDiv.innerHTML = `<small class="text-muted" id="${messageId}-status">æ­£åœ¨å¯åŠ¨åˆ†æå¼•æ“...</small>`;
                    statusIndicators.appendChild(statusDiv);
                    break;
                    
                case 'status':
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    const statusText = document.getElementById(`${messageId}-status`);
                    if (statusText) {
                        statusText.textContent = data.message;
                    }
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge bg-secondary me-1 mb-1 fade-in';
                    statusBadge.innerHTML = `<small>${data.message}</small>`;
                    statusIndicators.appendChild(statusBadge);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    updateProgressBar(messageId, 10, 20);
                    break;
                    
                case 'ai_response':
                    // å®æ—¶æ˜¾ç¤ºAIå›å¤å†…å®¹
                    if (data.content) {
                        aiResponseContent.innerHTML += data.content;
                        
                        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                        const responseStatus = document.getElementById(`${messageId}-status`);
                        if (responseStatus) {
                            responseStatus.textContent = `æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...`;
                        }
                        
                        // æ›´æ–°è¿›åº¦æ¡ - å½“æœ‰AIå“åº”æ—¶ï¼Œè¿›åº¦è‡³å°‘è¾¾åˆ°70%
                        updateProgressBar(messageId, 70, 85);
                        
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    break;
                    
                case 'complete':
                    typingIndicator.style.display = 'none';
                    const completeBadge = document.createElement('div');
                    completeBadge.className = 'alert alert-success alert-custom py-2 mt-2 fade-in';
                    completeBadge.innerHTML = `<small><strong>${data.message}</strong></small>`;
                    statusIndicators.appendChild(completeBadge);
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    const completeStatus = document.getElementById(`${messageId}-status`);
                    if (completeStatus) {
                        completeStatus.textContent = `åˆ†æå®Œæˆï¼`;
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡åˆ°100%
                    updateProgressBar(messageId, 100);
                    break;
                    
                case 'error':
                    typingIndicator.style.display = 'none';
                    const errorBadge = document.createElement('div');
                    errorBadge.className = 'alert alert-danger alert-custom py-2 mt-2 fade-in';
                    errorBadge.innerHTML = `<small><strong>âŒ ${data.message}</strong></small>`;
                    statusIndicators.appendChild(errorBadge);
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    const errorStatus = document.getElementById(`${messageId}-status`);
                    if (errorStatus) {
                        errorStatus.textContent = `åˆ†æå‡ºé”™: ${data.message}`;
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤ºé”™è¯¯
                    const errorProgressBar = document.querySelector(`#${messageId}-progress .progress-bar`);
                    if (errorProgressBar) {
                        errorProgressBar.className = 'progress-bar bg-danger';
                        errorProgressBar.style.width = '100%';
                    }
                    break;
                
                default:
                    console.log('æœªå¤„ç†çš„æ•°æ®ç±»å‹:', data.type, data);
                    break;
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(messageId, progress, maxProgress = null) {
            const progressBar = document.querySelector(`#${messageId}-progress .progress-bar`);
            if (progressBar) {
                // å¦‚æœæä¾›äº†æœ€å¤§è¿›åº¦ï¼Œåˆ™éšæœºç”Ÿæˆä¸€ä¸ªåœ¨å½“å‰è¿›åº¦å’Œæœ€å¤§è¿›åº¦ä¹‹é—´çš„å€¼
                if (maxProgress !== null) {
                    const currentWidth = parseFloat(progressBar.style.width) || 0;
                    if (currentWidth < progress) {
                        progress = currentWidth + Math.random() * (maxProgress - currentWidth);
                    }
                }
                
                progressBar.style.width = `${progress}%`;
            }
        }

        // æ·»åŠ æ™®é€šæ¶ˆæ¯
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = content;
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ç”¨æˆ·ç®¡ç†ç›¸å…³å‡½æ•°
        async function showUsersList() {
            try {
                const result = await api.getAllUsers();
                
                let html = `
                    <h6>ğŸ‘¥ æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ (${result.total_users}ä¸ª)</h6>
                    <small class="text-muted">æ´»è·ƒåˆ†æå™¨: ${result.active_analyzers}ä¸ª</small>
                    <hr>
                `;
                
                if (result.users.length === 0) {
                    html += '<p class="text-muted">æš‚æ— ç”¨æˆ·è®°å½•</p>';
                } else {
                    result.users.forEach(user => {
                        const isCurrentUser = userManager.getCurrentUser()?.userId === user.user_id;
                        html += `
                            <div class="border rounded p-3 mb-2 ${isCurrentUser ? 'bg-light' : ''}">
                                <div class="d-flex justify-content-between">
                                    <strong>${user.username} ${isCurrentUser ? '(å½“å‰ç”¨æˆ·)' : ''}</strong>
                                    <small class="text-muted">${user.user_id}</small>
                                </div>
                                <div class="row mt-2 text-center">
                                    <div class="col-3">
                                        <small class="text-muted">æ•°æ®åº“</small><br>
                                        <span class="badge bg-${user.stats.has_database ? 'success' : 'secondary'}">
                                            ${user.stats.has_database ? 'âœ…' : 'âŒ'}
                                        </span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">è®°å¿†</small><br>
                                        <span class="badge bg-${user.stats.has_memory ? 'success' : 'secondary'}">
                                            ${user.stats.has_memory ? 'âœ…' : 'âŒ'}
                                        </span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">æŠ¥å‘Š</small><br>
                                        <span class="badge bg-info">${user.stats.reports_count}</span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">å¤§å°</small><br>
                                        <span class="badge bg-warning">${(user.stats.total_size / 1024).toFixed(1)}KB</span>
                                    </div>
                                </div>
                                <small class="text-muted">æœ€åæ´»åŠ¨: ${user.last_activity}</small>
                            </div>
                        `;
                    });
                }
                
                showInfoModal('ç”¨æˆ·åˆ—è¡¨', html);
                
            } catch (error) {
                showErrorMessage('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        async function showUserStats() {
            try {
                const currentUser = userManager.getCurrentUser();
                if (!currentUser) {
                    showErrorMessage('è¯·å…ˆå®Œæˆç”¨æˆ·èº«ä»½è¯†åˆ«');
                    return;
                }
                
                const result = await api.getUserStatus();
                
                const html = `
                    <h6>ğŸ“Š ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</h6>
                            <ul class="list-unstyled">
                                <li><strong>ç”¨æˆ·å:</strong> ${result.user_info.username}</li>
                                <li><strong>ç”¨æˆ·ID:</strong> ${result.user_info.user_id}</li>
                                <li><strong>ç±»å‹:</strong> ${result.user_info.is_guest ? 'è®¿å®¢' : 'æ³¨å†Œç”¨æˆ·'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡</h6>
                            <ul class="list-unstyled">
                                <li><strong>æ•°æ®åº“:</strong> ${result.user_stats.has_database ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'}</li>
                                <li><strong>æ•°æ®åº“å¤§å°:</strong> ${(result.user_stats.database_size / 1024).toFixed(1)}KB</li>
                                <li><strong>è®°å¿†å¤§å°:</strong> ${(result.user_stats.memory_size / 1024).toFixed(1)}KB</li>
                                <li><strong>æŠ¥å‘Šæ•°é‡:</strong> ${result.user_stats.reports_count}ä¸ª</li>
                                <li><strong>æ€»å ç”¨:</strong> ${(result.user_stats.total_size / 1024).toFixed(1)}KB</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                showInfoModal('ç”¨æˆ·ç»Ÿè®¡', html);
                
            } catch (error) {
                showErrorMessage('è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'error');
        }

        function showComingSoon(feature) {
            showToast(`${feature}åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`, 'info');
        }

        function showInfoModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toastContainer.removeChild(toast);
            });
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ¤– æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ– (å¤šç”¨æˆ·ç‰ˆ)...');
            
            // ç«‹å³æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
            try {
                const healthResponse = await api.healthCheck();
                if (healthResponse && healthResponse.status === 'healthy') {
                    console.log('âœ… åç«¯å¥åº·æ£€æŸ¥æˆåŠŸ:', healthResponse);
                    currentState.backendConnected = true;
                    document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                    document.getElementById('connection-status').className = 'connection-indicator connected';
                } else {
                    throw new Error('å¥åº·æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ åç«¯è¿æ¥å¤±è´¥:', error);
                currentState.backendConnected = false;
                document.getElementById('connection-status').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('connection-status').className = 'connection-indicator';
                addMessage('âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨', 'system');
            }
            
            // ç­‰å¾…ç”¨æˆ·ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ
            userManager.addUserChangeListener(async (user) => {
                if (user) {
                    console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user);
                    
                    // ç”¨æˆ·ç™»å½•åæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
                    setTimeout(async () => {
                        try {
                            const status = await checkSystemStatus();
                            if (status && status.system_ready) {
                                addMessage(`âœ… æ¬¢è¿ ${user.username}ï¼ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ”¯æŒå®æ—¶æµå¼åˆ†æã€‚`, 'system');
                                
                                if (status.database_connected) {
                                    addMessage('ğŸ“Š æ£€æµ‹åˆ°æ‚¨çš„ä¸“å±æ•°æ®åº“ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œåˆ†æã€‚', 'system');
                                } else {
                                    addMessage('ğŸ’¡ è¯·å…ˆä¸Šä¼ CSVæ–‡ä»¶åˆ›å»ºæ‚¨çš„ä¸“å±æ•°æ®åº“ã€‚', 'system');
                                }
                            } else {
                                addMessage('âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨', 'system');
                            }
                        } catch (error) {
                            addMessage('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'system');
                        }
                    }, 1000);
                }
            });
            
            // åˆå§‹æ¶ˆæ¯
            addMessage('ğŸ”„ æ­£åœ¨è¿›è¡Œç”¨æˆ·èº«ä»½è¯†åˆ«...', 'system');
        });

        // å®šæœŸçŠ¶æ€æ£€æŸ¥
        setInterval(async () => {
            if (userManager.isLoggedIn()) {
                try {
                    await api.healthCheck();
                    if (!currentState.backendConnected) {
                        currentState.backendConnected = true;
                        document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                        document.getElementById('connection-status').className = 'connection-indicator connected';
                        addMessage('âœ… åç«¯æœåŠ¡è¿æ¥å·²æ¢å¤', 'system');
                    }
                } catch (error) {
                    if (currentState.backendConnected) {
                        currentState.backendConnected = false;
                        document.getElementById('connection-status').textContent = 'è¿æ¥ä¸­æ–­';
                        document.getElementById('connection-status').className = 'connection-indicator';
                        addMessage('âš ï¸ åç«¯æœåŠ¡è¿æ¥ä¸­æ–­', 'system');
                    }
                }
            }
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

        // è°ƒè¯•è„šæœ¬ - æµ‹è¯•åç«¯è¿æ¥
        console.log('ğŸ” å¼€å§‹APIè¿æ¥æµ‹è¯•...');
        
        async function testBackendConnection() {
            // å°è¯•å¤šä¸ªå¯èƒ½çš„ç«¯ç‚¹
            const endpoints = [
                'http://localhost:5000/health',
                'http://localhost:5000/api/health',
                'http://127.0.0.1:5000/health',
                '/health',
                '/api/health'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`å°è¯•è¿æ¥: ${endpoint}`);
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`âœ… è¿æ¥æˆåŠŸ (${endpoint}):`, data);
                        return {success: true, endpoint, data};
                    } else {
                        console.log(`âŒ è¿æ¥å¤±è´¥ (${endpoint}): ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`âŒ è¿æ¥é”™è¯¯ (${endpoint}):`, error.message);
                }
            }
            
            // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥
            return {success: false, message: 'æ‰€æœ‰è¿æ¥å°è¯•å‡å¤±è´¥'};
        }
        
        // é¡µé¢åŠ è½½åæ‰§è¡Œæµ‹è¯•
        setTimeout(() => {
            testBackendConnection().then(result => {
                console.log('APIè¿æ¥æµ‹è¯•ç»“æœ:', result);
                if (result.success) {
                    // å¦‚æœæµ‹è¯•æˆåŠŸï¼Œå°è¯•æ‰‹åŠ¨åˆå§‹åŒ–API
                    if (window.api) {
                        window.api.baseURL = result.endpoint.replace('/health', '');
                        console.log('âœ… å·²æ›´æ–°APIåŸºç¡€URL:', window.api.baseURL);
                    }
                } else {
                    // æ·»åŠ ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯
                    if (typeof addMessage === 'function') {
                        addMessage('âš ï¸ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨', 'system');
                    }
                }
            });
        }, 2000);
    </script>
</body>
</html>