<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Êô∫ËÉΩÊï∞ÊçÆÂ∫ìÂàÜÊûêÁ≥ªÁªü (Â§öÁî®Êà∑Áâà)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Ê∑ªÂä†CORSÁ≠ñÁï•ÂÖÉÊ†áÁ≠æ -->
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' http://localhost:5000 ws://localhost:5000 http://127.0.0.1:5000 ws://127.0.0.1:5000;">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1400px;
        }
        
        .chat-container {
            height: 600px;
            background: #f8f9fa;
            border-radius: 15px;
            overflow-y: auto;
            padding: 20px;
            border: 2px solid #e9ecef;
        }
        
        .message {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            text-align: right;
        }
        
        .user-message .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 5px 20px;
            padding: 15px 20px;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .ai-message .message-bubble {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 20px 20px 20px 5px;
            padding: 15px 20px;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .system-message {
            text-align: center;
            margin: 10px 0;
        }
        
        .system-message .message-bubble {
            background: var(--warning-gradient);
            color: white;
            border-radius: 15px;
            padding: 8px 15px;
            display: inline-block;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(250, 112, 154, 0.3);
        }
        
        .status-card {
            background: var(--success-gradient);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            height: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-outline-gradient {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-gradient:hover {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
        }
        
        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .file-upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.15);
            transform: scale(1.02);
        }
        
        .sql-display {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .memory-card {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar {
            height: calc(100vh - 100px);
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            height: calc(100vh - 100px);
        }
        
        .tab-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            border-radius: 10px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .progress-custom .progress-bar {
            background: var(--primary-gradient);
            border-radius: 4px;
        }
        
        .connection-indicator {
            position: relative;
            display: inline-block;
        }
        
        .connection-indicator::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .connection-indicator.connected::before {
            background: #28a745;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ÊµÅÂºèÊòæÁ§∫Ê†∑Âºè */
        .streaming-content {
            position: relative;
        }
        
        .status-indicators {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .typing-indicator .dot {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .ai-response-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .sql-display code {
            color: #e2e8f0;
            background: transparent;
        }
        
        .badge {
            font-size: 0.75em;
        }
        
        .status-indicators .badge {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-custom {
            height: 6px;
            border-radius: 3px;
            background-color: rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        /* Ê∏êÂÖ•Âä®Áîª */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Áä∂ÊÄÅÊåáÁ§∫Âô®ÂÆπÂô® */
        .status-indicators {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        /* ÊâìÂ≠óÊåáÁ§∫Âô®Ê†∑ÂºèÂ¢ûÂº∫ */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin-top: 5px;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            width: fit-content;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            opacity: 0.4;
        }
        
        .typing-indicator span:nth-child(1) {
            animation: pulse 1s infinite 0.1s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation: pulse 1s infinite 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation: pulse 1s infinite 0.3s;
        }
        
        .typing-indicator span:nth-child(4) {
            animation: pulse 1s infinite 0.4s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 0.4; }
        }
        
        /* SQLÊòæÁ§∫Âå∫ÂüüÂ¢ûÂº∫ */
        .sql-display {
            background-color: rgba(0,0,0,0.02);
            border-radius: 5px;
            padding: 8px;
            border-left: 3px solid #6c757d;
        }
        
        .sql-display code {
            display: block;
            white-space: pre-wrap;
            padding: 5px;
            background-color: rgba(0,0,0,0.03);
            border-radius: 3px;
            font-size: 0.85rem;
            color: #333;
        }
        
        /* Ë≠¶ÂëäÊ°ÜÊ†∑ÂºèÂ¢ûÂº∫ */
        .alert-custom {
            border-radius: 5px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
        <div class="container-fluid">
            <span class="navbar-brand">ü§ñ Êô∫ËÉΩÊï∞ÊçÆÂ∫ìÂàÜÊûêÁ≥ªÁªü (Â§öÁî®Êà∑Áâà)</span>
            <div class="navbar-nav ms-auto">
                <span class="nav-link text-white" id="user-display">
                    <i class="bi bi-person-circle"></i> Ê≠£Âú®ËØÜÂà´Áî®Êà∑...
                </span>
                <span class="nav-link text-white">
                    <i class="bi bi-database"></i> 
                    <span id="connection-status" class="connection-indicator">Ê£ÄÊü•‰∏≠...</span>
                </span>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="userManager.switchUser()" title="ÂàáÊç¢Áî®Êà∑">
                    <i class="bi bi-person-gear"></i>
                </button>
                <button class="btn btn-outline-light btn-sm ms-1" onclick="userManager.logout()" title="ÈÄÄÂá∫ÁôªÂΩï">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- Â∑¶‰æßËæπÊ†è -->
            <div class="col-md-3">
                <div class="sidebar">
                    <!-- Áî®Êà∑Áä∂ÊÄÅÂíåÊï∞ÊçÆÂ∫ìÁä∂ÊÄÅÂêàÂπ∂Âç°Áâá -->
                    <div class="status-card">
                        <!-- Áî®Êà∑‰ø°ÊÅØÂ∞ÜÁî± userManager Âä®ÊÄÅÊ∑ªÂä† -->
                        <h6><i class="bi bi-database-fill"></i> Êï∞ÊçÆÂ∫ìÁä∂ÊÄÅ</h6>
                        <div id="db-status">
                            <small>Êï∞ÊçÆÂ∫ì: <span id="db-path">Ê£ÄÊü•‰∏≠...</span></small><br>
                            <small>Ë°®Âêç: <span id="table-name">N/A</span></small><br>
                            <small>ËÆ∞ÂΩïÊï∞: <span id="record-count">0</span></small>
                        </div>
                    </div>

                    <!-- Âø´ÈÄüÊìç‰Ωú -->
                    <div class="card feature-card mb-3">
                        <h6><i class="bi bi-lightning-fill"></i> Âø´ÈÄüÊìç‰Ωú</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-gradient btn-sm" onclick="showTab('upload')">
                                <i class="bi bi-upload"></i> ‰∏ä‰º†Êï∞ÊçÆ
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showTab('analysis')">
                                <i class="bi bi-chat-dots"></i> Êô∫ËÉΩÂàÜÊûê
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showComingSoon('Êü•ÁúãËÆ∞ÂøÜ')">
                                <i class="bi bi-journal-text"></i> Êü•ÁúãËÆ∞ÂøÜ
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showComingSoon('Ê∏ÖÁ©∫ËÆ∞ÂøÜ')">
                                <i class="bi bi-trash"></i> Ê∏ÖÁ©∫ËÆ∞ÂøÜ
                            </button>
                        </div>
                    </div>

                    <!-- ÂàÜÊûêÁªüËÆ° -->
                    <div class="card feature-card mb-3">
                        <h6><i class="bi bi-graph-up"></i> ÂàÜÊûêÁªüËÆ°</h6>
                        <div id="memory-stats">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 text-primary mb-0" id="conversation-count">0</div>
                                    <small class="text-muted">ÂØπËØùÊï∞</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 text-success mb-0" id="sql-count">0</div>
                                    <small class="text-muted">SQLÊü•ËØ¢</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Áî®Êà∑ÁÆ°ÁêÜÂ∑•ÂÖ∑ -->
                    <div class="card feature-card">
                        <h6><i class="bi bi-people"></i> Áî®Êà∑ÁÆ°ÁêÜ</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-gradient btn-sm" onclick="showUsersList()">
                                <i class="bi bi-list"></i> ÊâÄÊúâÁî®Êà∑
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="userManager.switchUser()">
                                <i class="bi bi-person-plus"></i> ÂàáÊç¢Áî®Êà∑
                            </button>
                            <button class="btn btn-outline-gradient btn-sm" onclick="showUserStats()">
                                <i class="bi bi-pie-chart"></i> Áî®Êà∑ÁªüËÆ°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
            <div class="col-md-9">
                <div class="main-content">
                    <!-- ÈÄâÈ°πÂç°ÂØºËà™ -->
                    <ul class="nav nav-pills mb-3" id="main-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-tab="upload" href="#upload-tab">
                                <i class="bi bi-upload"></i> Êï∞ÊçÆ‰∏ä‰º†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="analysis" href="#analysis-tab">
                                <i class="bi bi-chat-dots"></i> Êô∫ËÉΩÂàÜÊûê
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="memory" href="#memory-tab">
                                <i class="bi bi-journal-text"></i> ÂàÜÊûêËÆ∞ÂøÜ <span class="badge bg-warning">ÂºÄÂèë‰∏≠</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="results" href="#results-tab">
                                <i class="bi bi-file-earmark-text"></i> ÁªìÊûúÊä•Âëä <span class="badge bg-warning">ÂºÄÂèë‰∏≠</span>
                            </a>
                        </li>
                    </ul>

                    <!-- ÈÄâÈ°πÂç°ÂÜÖÂÆπ -->
                    <div class="tab-content">
                        <!-- Êï∞ÊçÆ‰∏ä‰º†Ê†áÁ≠æÈ°µ -->
                        <div id="upload-tab" class="tab-pane active">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="file-upload-area" id="file-upload-area">
                                        <i class="bi bi-cloud-upload display-1 text-primary mb-3"></i>
                                        <h5>ÊãñÊãΩCSVÊñá‰ª∂Âà∞ËøôÈáå</h5>
                                        <p class="text-muted">ÊàñËÄÖÁÇπÂáªÈÄâÊã©Êñá‰ª∂</p>
                                        <p class="text-muted"><small>ÊØè‰∏™Áî®Êà∑ÁöÑÊï∞ÊçÆÂ∞ÜÁã¨Á´ãÂ≠òÂÇ®</small></p>
                                        <input type="file" id="csv-file" accept=".csv" style="display: none;">
                                        <button class="btn btn-gradient mt-2" onclick="document.getElementById('csv-file').click()">
                                            ÈÄâÊã©Êñá‰ª∂
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card feature-card">
                                        <h6><i class="bi bi-gear"></i> ÂØºÂÖ•ËÆæÁΩÆ</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Ë°®Âêç</label>
                                            <input type="text" class="form-control" id="table-name-input" value="data_table" placeholder="ËæìÂÖ•Ë°®Âêç">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Êï∞ÊçÆÂ∫ìÂêçÁß∞</label>
                                            <input type="text" class="form-control" id="db-path-input" value="analysis.db" placeholder="Êï∞ÊçÆÂ∫ìÊñá‰ª∂Âêç">
                                            <small class="text-muted">Â∞ÜËá™Âä®‰øùÂ≠òÂà∞ÊÇ®ÁöÑ‰∏ìÂ±ûÁõÆÂΩï</small>
                                        </div>
                                        <button class="btn btn-gradient w-100" id="upload-btn" disabled>
                                            <i class="bi bi-upload"></i> ÂºÄÂßãÂØºÂÖ•
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
                            <div id="upload-progress" class="mt-4" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h6><i class="bi bi-hourglass-split"></i> Ê≠£Âú®Â§ÑÁêÜ...</h6>
                                        <div class="progress progress-custom">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-2 d-block" id="upload-status">ÂáÜÂ§á‰∏ä‰º†...</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Êô∫ËÉΩÂàÜÊûêÊ†áÁ≠æÈ°µ -->
                        <div id="analysis-tab" class="tab-pane">
                            <div class="row h-100">
                                <div class="col-12">
                                    <!-- ÂàÜÊûêËÅäÂ§©ÁïåÈù¢ -->
                                    <div class="chat-container" id="chat-container">
                                        <div class="message system-message">
                                            <div class="message-bubble">
                                                ü§ñ Êô∫ËÉΩÂàÜÊûêÂä©ÊâãÂ∑≤Â∞±Áª™ÔºåÊîØÊåÅÂ§öÁî®Êà∑Êï∞ÊçÆÈöîÁ¶ª
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ËæìÂÖ•Âå∫Âüü -->
                                    <div class="mt-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="analysis-input" 
                                                   placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÂàÜÊûêÈúÄÊ±Ç..." style="border-radius: 10px 0 0 10px;">
                                            <button class="btn btn-gradient" id="send-analysis" style="border-radius: 0 10px 10px 0;">
                                                <i class="bi bi-send"></i> ÂèëÈÄÅ
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                üí° Á§∫‰æã: "ÂàÜÊûêÊï∞ÊçÆÂü∫Êú¨ÊÉÖÂÜµ" | "ÁîüÊàêÈîÄÂîÆÊä•Âëä" | "Ê£ÄÊü•ÂºÇÂ∏∏ÂÄº"
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                                    <div class="loading-spinner" id="analysis-loading">
                                        <div class="spinner-border spinner-border-custom text-primary" role="status">
                                            <span class="visually-hidden">ÂàÜÊûê‰∏≠...</span>
                                        </div>
                                        <p class="mt-2 text-muted">ClaudeÊ≠£Âú®‰∏∫ÊÇ®ËøõË°å‰∏ìÂ±ûÂàÜÊûê...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂàÜÊûêËÆ∞ÂøÜÊ†áÁ≠æÈ°µ -->
                        <div id="memory-tab" class="tab-pane">
                            <div class="alert alert-info alert-custom">
                                <h6><i class="bi bi-info-circle"></i> ÂäüËÉΩÂºÄÂèë‰∏≠</h6>
                                <p class="mb-0">Â§öÁî®Êà∑ËÆ∞ÂøÜÁÆ°ÁêÜÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ</p>
                                <small class="text-muted">Â∞ÜÂú®P1Èò∂ÊÆµÂÆåÊàêÊ≠§ÂäüËÉΩ</small>
                            </div>
                        </div>

                        <!-- ÁªìÊûúÊä•ÂëäÊ†áÁ≠æÈ°µ -->
                        <div id="results-tab" class="tab-pane">
                            <div class="alert alert-info alert-custom">
                                <h6><i class="bi bi-info-circle"></i> ÂäüËÉΩÂºÄÂèë‰∏≠</h6>
                                <p class="mb-0">Â§öÁî®Êà∑Êä•ÂëäÁÆ°ÁêÜÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ</p>
                                <small class="text-muted">Â∞ÜÂú®P1Èò∂ÊÆµÂÆåÊàêÊ≠§ÂäüËÉΩ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Áî®Êà∑ÁÆ°ÁêÜËÑöÊú¨ -->
    <script src="user_manager.js"></script>
    
    <!-- APIÁ±ªËÑöÊú¨ -->
    <script src="api.js"></script>
    
    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
        let currentState = {
            dbConnected: false,
            dbPath: '',
            tableName: '',
            recordCount: 0,
            conversationCount: 0,
            sqlCount: 0,
            backendConnected: false,
            currentAnalysisId: null,
            isAnalyzing: false
        };

        // Á≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•
        async function checkSystemStatus() {
            const connectionIndicator = document.getElementById('connection-status');
            
            try {
                connectionIndicator.textContent = 'ËøûÊé•‰∏≠...';
                connectionIndicator.className = 'connection-indicator';
                
                const status = await api.getSystemStatus();
                
                // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
                currentState.backendConnected = true;
                connectionIndicator.textContent = 'Â∑≤ËøûÊé•';
                connectionIndicator.className = 'connection-indicator connected';
                
                // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÁä∂ÊÄÅ
                if (status.database_connected) {
                    updateDBStatus(
                        status.database_path,
                        status.table_name,
                        status.record_count
                    );
                } else {
                    document.getElementById('db-path').textContent = 'Êú™ËøûÊé•';
                    document.getElementById('table-name').textContent = 'N/A';
                    document.getElementById('record-count').textContent = '0';
                }
                
                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                if (status.memory_stats) {
                    currentState.conversationCount = status.memory_stats.conversation_count || 0;
                    currentState.sqlCount = status.memory_stats.total_sql_calls || 0;
                    updateStats();
                }
                
                return status;
                
            } catch (error) {
                currentState.backendConnected = false;
                connectionIndicator.textContent = 'ËøûÊé•Â§±Ë¥•';
                connectionIndicator.className = 'connection-indicator';
                
                console.error('Á≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•:', error);
                return null;
            }
        }

        // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÁä∂ÊÄÅ
        function updateDBStatus(dbPath, tableName, recordCount) {
            currentState.dbConnected = true;
            currentState.dbPath = dbPath;
            currentState.tableName = tableName;
            currentState.recordCount = recordCount;

            document.getElementById('db-path').textContent = dbPath || 'Êú™Áü•';
            document.getElementById('table-name').textContent = tableName || 'N/A';
            document.getElementById('record-count').textContent = recordCount.toLocaleString();
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            document.getElementById('conversation-count').textContent = currentState.conversationCount;
            document.getElementById('sql-count').textContent = currentState.sqlCount;
        }

        // ÈÄâÈ°πÂç°ÂàáÊç¢
        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // ÂØºËà™ÁÇπÂáª‰∫ã‰ª∂
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.getAttribute('data-tab');
                showTab(tabName);
            });
        });

        // Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        const fileUploadArea = document.getElementById('file-upload-area');
        const csvFileInput = document.getElementById('csv-file');
        const uploadBtn = document.getElementById('upload-btn');

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                handleFileSelection(files[0]);
            }
        });

        fileUploadArea.addEventListener('click', () => {
            csvFileInput.click();
        });

        csvFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            console.log('ÈÄâÊã©ÁöÑÊñá‰ª∂:', file.name);
            uploadBtn.disabled = false;
            
            const user = userManager.getCurrentUser();
            const userInfo = user ? `Áî®Êà∑: ${user.username}` : 'Êú™ÁôªÂΩïÁî®Êà∑';
            
            fileUploadArea.innerHTML = `
                <i class="bi bi-file-earmark-check display-1 text-success mb-3"></i>
                <h5>Êñá‰ª∂Â∑≤ÈÄâÊã©: ${file.name}</h5>
                <p class="text-muted">Â§ßÂ∞è: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <p class="text-muted">${userInfo}</p>
                <button class="btn btn-outline-gradient mt-2" onclick="document.getElementById('csv-file').click()">
                    ÈáçÊñ∞ÈÄâÊã©
                </button>
            `;
        }

        // Êñá‰ª∂‰∏ä‰º†ÂáΩÊï∞
        async function uploadFile(file, tableName, dbPath) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const statusText = document.getElementById('upload-status');
            
            progressDiv.style.display = 'block';
            uploadBtn.disabled = true;
            
            try {
                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
                if (!userManager.isLoggedIn()) {
                    throw new Error('ËØ∑ÂÖàÂÆåÊàêÁî®Êà∑Ë∫´‰ªΩËØÜÂà´');
                }
                
                // Ê£ÄÊü•ÂêéÁ´ØËøûÊé•
                if (!currentState.backendConnected) {
                    throw new Error('ÂêéÁ´ØÊúçÂä°Êú™ËøûÊé•ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶ÂêØÂä®');
                }
                
                const user = userManager.getCurrentUser();
                statusText.textContent = `Áî®Êà∑ ${user.username} Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...`;
                console.log(`ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ${file.name}, Â§ßÂ∞è: ${file.size} Â≠óËäÇ`);
                
                // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `Áî®Êà∑ ${user.username} ‰∏ä‰º†‰∏≠... ${Math.round(progress)}%`;
                }, 300);
                
                // Ë∞ÉÁî®ÁúüÂÆûAPI
                try {
                    console.log(`Ë∞ÉÁî®API‰∏ä‰º†Êñá‰ª∂: ${file.name}, Ë°®Âêç: ${tableName}`);
                    const result = await api.uploadCSV(file, tableName, dbPath);
                    console.log("‰∏ä‰º†ÊàêÂäüÔºåÊúçÂä°Âô®ËøîÂõû:", result);
                    
                    // Ê∏ÖÈô§ËøõÂ∫¶Âä®Áîª
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    statusText.textContent = '‰∏ä‰º†ÊàêÂäüÔºÅÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Áî®Êà∑‰∏ìÂ±ûÁõÆÂΩï';
                    
                    // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÁä∂ÊÄÅ
                    updateDBStatus(
                        result.data.db_path,
                        result.data.table_name,
                        result.data.rows_imported
                    );
                    
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        uploadBtn.disabled = false;
                        showSuccessMessage(`${result.message} (Áî®Êà∑: ${user.username})`);
                        showTab('analysis');
                    }, 1000);
                } catch (apiError) {
                    clearInterval(progressInterval);
                    console.error("APIË∞ÉÁî®Â§±Ë¥•:", apiError);
                    statusText.textContent = `‰∏ä‰º†Â§±Ë¥•: ${apiError.message}`;
                    progressBar.style.width = '0%';
                    progressBar.className = 'progress-bar bg-danger';
                    uploadBtn.disabled = false;
                    showErrorMessage(`‰∏ä‰º†Â§±Ë¥•: ${apiError.message}`);
                    
                    // Â∞ùËØïÈáçÊñ∞Ê£ÄÊü•ËøûÊé•
                    setTimeout(async () => {
                        try {
                            await api.healthCheck();
                            progressBar.className = 'progress-bar';
                            statusText.textContent = 'ÊúçÂä°Âô®ËøûÊé•Ê≠£Â∏∏ÔºåËØ∑ÈáçËØï‰∏ä‰º†';
                        } catch (e) {
                            statusText.textContent = 'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶ÂêØÂä®';
                        }
                    }, 2000);
                }
                
            } catch (error) {
                statusText.textContent = '‰∏ä‰º†Â§±Ë¥•: ' + error.message;
                progressBar.style.width = '0%';
                progressBar.className = 'progress-bar bg-danger';
                uploadBtn.disabled = false;
                showErrorMessage('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
            }
        }

        uploadBtn.addEventListener('click', async () => {
            const file = csvFileInput.files[0];
            if (!file) {
                showErrorMessage('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
                return;
            }

            const tableName = document.getElementById('table-name-input').value.trim();
            const dbPath = document.getElementById('db-path-input').value.trim();

            if (!tableName || !dbPath) {
                showErrorMessage('ËØ∑Â°´ÂÜôË°®ÂêçÂíåÊï∞ÊçÆÂ∫ìË∑ØÂæÑ');
                return;
            }
            
            console.log(`ÂáÜÂ§á‰∏ä‰º†Êñá‰ª∂: ${file.name}, Ë°®Âêç: ${tableName}, Êï∞ÊçÆÂ∫ì: ${dbPath}`);
            await uploadFile(file, tableName, dbPath);
        });

        // ÊµÅÂºèÊô∫ËÉΩÂàÜÊûêÂ§ÑÁêÜ
        const analysisInput = document.getElementById('analysis-input');
        const sendAnalysisBtn = document.getElementById('send-analysis');
        const chatContainer = document.getElementById('chat-container');
        const analysisLoading = document.getElementById('analysis-loading');

        sendAnalysisBtn.addEventListener('click', sendAnalysisStream);
        analysisInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !currentState.isAnalyzing) {
                sendAnalysisStream();
            }
        });

        // ÂèëÈÄÅÊµÅÂºèÂàÜÊûêËØ∑Ê±Ç
        async function sendAnalysisStream() {
            const user = userManager.getCurrentUser();
            
            if (!user) {
                showErrorMessage("ËØ∑ÂÖàÁôªÂΩïÂÜçËøõË°åÂàÜÊûê");
                return;
            }
            
            if (!currentState.backendConnected) {
                showErrorMessage("ÂêéÁ´ØÊúçÂä°Êú™ËøûÊé•ÔºåËØ∑Á®çÂêéÂÜçËØï");
                return;
            }
            
            if (!currentState.dbConnected) {
                showErrorMessage("Êï∞ÊçÆÂ∫ìÊú™ËøûÊé•ÔºåËØ∑ÂÖà‰∏ä‰º†ÊàñÈÄâÊã©Êï∞ÊçÆ");
                return;
            }
            
            const query = analysisInput.value.trim();
            if (!query) {
                showErrorMessage("ËØ∑ËæìÂÖ•ÂàÜÊûêÈúÄÊ±Ç");
                return;
            }
            
            // Á¶ÅÁî®ËæìÂÖ•ÂíåÊåâÈíÆ
            analysisInput.disabled = true;
            sendAnalysisBtn.disabled = true;
            
            try {
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
                const messageId = 'message-' + Date.now();
                const messageDiv = createStreamingMessageContainer(messageId, query);
                chatContainer.appendChild(messageDiv);
                
                // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Ëé∑ÂèñÊ∂àÊÅØÂÆπÂô®‰∏≠ÁöÑÁä∂ÊÄÅÊåáÁ§∫Âô®ÂíåAIÂìçÂ∫îÂÜÖÂÆπ
                const statusIndicators = messageDiv.querySelector('.status-indicators');
                const aiResponseContent = messageDiv.querySelector('.ai-response-content');
                const typingIndicator = messageDiv.querySelector('.typing-indicator');
                
                // ÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅ
                statusIndicators.innerHTML = `
                    <div class="alert alert-info alert-custom py-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">ËøûÊé•‰∏≠...</span>
                            </div>
                            <small>Ê≠£Âú®ËøûÊé•ÂàÜÊûêÊúçÂä°...</small>
                        </div>
                    </div>`;
                
                // Ê∑ªÂä†ËøõÂ∫¶Êù°
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress progress-custom mt-2';
                progressDiv.innerHTML = `<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 5%"></div>`;
                progressDiv.id = `${messageId}-progress`;
                statusIndicators.appendChild(progressDiv);
                
                // Ê∑ªÂä†Áä∂ÊÄÅÊñáÊú¨
                const statusDiv = document.createElement('div');
                statusDiv.className = 'text-center mt-1';
                statusDiv.innerHTML = `<small class="text-muted" id="${messageId}-status">ÂàùÂßãÂåñÂàÜÊûêËØ∑Ê±Ç...</small>`;
                statusIndicators.appendChild(statusDiv);
                
                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                typingIndicator.style.display = 'flex';
                
                // ÂèëËµ∑ÊµÅÂºèËØ∑Ê±Ç
                const response = await api.analyzeStream(query);
                
                // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
                processStreamingResponse(response, messageId);
                
                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                updateStats();
                
            } catch (error) {
                console.error('ÊµÅÂºèÂàÜÊûêËØ∑Ê±ÇÂ§±Ë¥•:', error);
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                const errorMsg = error.message || 'ËøûÊé•ÂàÜÊûêÊúçÂä°Â§±Ë¥•';
                handleStreamingData({
                    type: 'error',
                    message: errorMsg
                }, messageId);
                
                showErrorMessage(`ÂàÜÊûêËØ∑Ê±ÇÂ§±Ë¥•: ${errorMsg}`);
            } finally {
                // ÊÅ¢Â§çËæìÂÖ•ÂíåÊåâÈíÆ
                analysisInput.disabled = false;
                sendAnalysisBtn.disabled = false;
                analysisInput.focus();
            }
        }

        // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
        function processStreamingResponse(response, messageId) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            console.log('ÂºÄÂßãÂ§ÑÁêÜÊµÅÂºèÂìçÂ∫î');
            
            // ÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅ
            handleStreamingData({
                type: 'start',
                message: 'Ê≠£Âú®ËøûÊé•ÂàÜÊûêÊúçÂä°...'
            }, messageId);
            
            // Â§ÑÁêÜÊï∞ÊçÆÊµÅ
            function processStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        console.log('ÊµÅÂºèÂìçÂ∫îÂÆåÊàê');
                        
                        // Â§ÑÁêÜÁºìÂÜ≤Âå∫‰∏≠ÁöÑÊúÄÂêéÊï∞ÊçÆ
                        if (buffer.trim()) {
                            try {
                                processBufferData(buffer, messageId);
                            } catch (e) {
                                console.error('Â§ÑÁêÜÊúÄÁªàÁºìÂÜ≤Êï∞ÊçÆÂ§±Ë¥•:', e);
                            }
                        }
                        
                        // Á°Æ‰øùÊòæÁ§∫ÂÆåÊàêÁä∂ÊÄÅ
                        handleStreamingData({
                            type: 'complete',
                            message: 'ÂàÜÊûêÂÆåÊàê'
                        }, messageId);
                        
                        return;
                    }
                    
                    // Ëß£Á†ÅÂπ∂Ê∑ªÂä†Âà∞ÁºìÂÜ≤Âå∫
                    const chunk = decoder.decode(value, { stream: true });
                    console.log(`Êé•Êî∂Âà∞Êï∞ÊçÆÂùó: ${chunk.length} Â≠óÁ¨¶`);
                    buffer += chunk;
                    
                    // Â§ÑÁêÜÁºìÂÜ≤Âå∫Êï∞ÊçÆ
                    try {
                        processBufferData(buffer, messageId);
                        
                        // Ê∏ÖÁêÜÂ∑≤Â§ÑÁêÜÁöÑÊï∞ÊçÆÔºå‰øùÁïôÂèØËÉΩ‰∏çÂÆåÊï¥ÁöÑÊúÄÂêé‰∏ÄË°å
                        const lastNewlineIndex = buffer.lastIndexOf('\n');
                        if (lastNewlineIndex !== -1) {
                            buffer = buffer.substring(lastNewlineIndex + 1);
                        }
                        
                        // Èò≤Ê≠¢ÁºìÂÜ≤Âå∫ËøáÂ§ß
                        if (buffer.length > 10000) {
                            buffer = buffer.substring(buffer.length - 5000);
                            console.warn('ÁºìÂÜ≤Âå∫ËøáÂ§ßÔºåÂ∑≤Êà™Êñ≠');
                        }
                    } catch (e) {
                        console.error('Â§ÑÁêÜÁºìÂÜ≤Êï∞ÊçÆÂ§±Ë¥•:', e);
                    }
                    
                    // ÁªßÁª≠Â§ÑÁêÜÊµÅ
                    processStream();
                }).catch(error => {
                    console.error('ËØªÂèñÊµÅÂ§±Ë¥•:', error);
                    handleStreamingData({
                        type: 'error',
                        message: 'ËØªÂèñÊï∞ÊçÆÊµÅÂ§±Ë¥•: ' + error.message
                    }, messageId);
                });
            }
            
            // ÂºÄÂßãÂ§ÑÁêÜÊµÅ
            processStream();
        }
        
        // Â§ÑÁêÜÁºìÂÜ≤Âå∫Êï∞ÊçÆ
        function processBufferData(buffer, messageId) {
            // ÊåâË°åÂàÜÂâ≤
            const lines = buffer.split('\n');
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØSSEÊ†ºÂºèÊï∞ÊçÆ
                if (line.startsWith('data: ')) {
                    const jsonStr = line.substring(6);
                    try {
                        const data = JSON.parse(jsonStr);
                        handleStreamingData(data, messageId);
                    } catch (e) {
                        console.warn('Ëß£ÊûêJSONÂ§±Ë¥• (SSEÊ†ºÂºè):', jsonStr, e);
                    }
                } else {
                    // Â∞ùËØïÁõ¥Êé•Ëß£ÊûêJSON
                    try {
                        const data = JSON.parse(line);
                        handleStreamingData(data, messageId);
                    } catch (e) {
                        // ‰∏çÊòØÊúâÊïàÁöÑJSONÔºåÂèØËÉΩÊòØÈÉ®ÂàÜÊï∞ÊçÆÊàñÂÖ∂‰ªñÊ†ºÂºè
                        console.debug('Ë°å‰∏çÊòØÊúâÊïàJSON:', line.substring(0, 100) + (line.length > 100 ? '...' : ''));
                    }
                }
            }
        }

        // ÂàõÂª∫Ê∂àÊÅØÂÆπÂô®
        function createStreamingMessageContainer(messageId, userMessage) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container mb-4';
            messageDiv.id = messageId;
            
            // Áî®Êà∑Ê∂àÊÅØÈÉ®ÂàÜ
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message mb-2';
            userMessageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="user-avatar me-2">
                        <img src="assets/img/user-avatar.png" alt="User" width="32" height="32" class="rounded-circle">
                    </div>
                    <div class="user-message-content">
                        <div class="mb-1"><strong>ÊÇ®</strong> <small class="text-muted">${new Date().toLocaleTimeString()}</small></div>
                        <div>${userMessage}</div>
                    </div>
                </div>
            `;
            
            // AIÂõûÂ§çÈÉ®ÂàÜ
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'ai-message mt-2';
            aiMessageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="ai-avatar me-2">
                        <img src="assets/img/ai-avatar.png" alt="AI" width="32" height="32" class="rounded-circle">
                    </div>
                    <div class="ai-message-content flex-grow-1">
                        <div class="mb-1"><strong>Êô∫ËÉΩÂàÜÊûêÂä©Êâã</strong> <small class="text-muted">${new Date().toLocaleTimeString()}</small></div>
                        <div class="status-indicators"></div>
                        <div class="ai-response-content"></div>
                        <div class="typing-indicator" style="display: none;">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(userMessageDiv);
            messageDiv.appendChild(aiMessageDiv);
            
            return messageDiv;
        }

        // Â§ÑÁêÜÊµÅÂºèÊï∞ÊçÆ
        function handleStreamingData(data, messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const statusIndicators = messageDiv.querySelector('.status-indicators');
            const aiResponseContent = messageDiv.querySelector('.ai-response-content');
            const typingIndicator = messageDiv.querySelector('.typing-indicator');
            
            console.log('Â§ÑÁêÜÊï∞ÊçÆÁ±ªÂûã:', data.type);
            
            // Á°Æ‰øùÊâìÂ≠óÊåáÁ§∫Âô®ÊòæÁ§∫
            if (data.type !== 'complete' && data.type !== 'error') {
                typingIndicator.style.display = 'flex';
            }
            
            switch (data.type) {
                case 'start':
                    statusIndicators.innerHTML = `
                        <div class="alert alert-info alert-custom py-2">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Âä†ËΩΩ‰∏≠...</span>
                                </div>
                                <small>${data.message}</small>
                            </div>
                        </div>`;
                    
                    // Ê∑ªÂä†ËøõÂ∫¶Êù°
                    const progressDiv = document.createElement('div');
                    progressDiv.className = 'progress progress-custom mt-2';
                    progressDiv.innerHTML = `<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 5%"></div>`;
                    progressDiv.id = `${messageId}-progress`;
                    statusIndicators.appendChild(progressDiv);
                    
                    // Ê∑ªÂä†Áä∂ÊÄÅÊñáÊú¨
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'text-center mt-1';
                    statusDiv.innerHTML = `<small class="text-muted" id="${messageId}-status">Ê≠£Âú®ÂêØÂä®ÂàÜÊûêÂºïÊìé...</small>`;
                    statusIndicators.appendChild(statusDiv);
                    break;
                    
                case 'status':
                    // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                    const statusText = document.getElementById(`${messageId}-status`);
                    if (statusText) {
                        statusText.textContent = data.message;
                    }
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge bg-secondary me-1 mb-1 fade-in';
                    statusBadge.innerHTML = `<small>${data.message}</small>`;
                    statusIndicators.appendChild(statusBadge);
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                    updateProgressBar(messageId, 10, 20);
                    break;
                    
                case 'ai_response':
                    // ÂÆûÊó∂ÊòæÁ§∫AIÂõûÂ§çÂÜÖÂÆπ
                    if (data.content) {
                        aiResponseContent.innerHTML += data.content;
                        
                        // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                        const responseStatus = document.getElementById(`${messageId}-status`);
                        if (responseStatus) {
                            responseStatus.textContent = `Ê≠£Âú®ÁîüÊàêÂàÜÊûêÊä•Âëä...`;
                        }
                        
                        // Êõ¥Êñ∞ËøõÂ∫¶Êù° - ÂΩìÊúâAIÂìçÂ∫îÊó∂ÔºåËøõÂ∫¶Ëá≥Â∞ëËææÂà∞70%
                        updateProgressBar(messageId, 70, 85);
                        
                        // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    break;
                    
                case 'complete':
                    typingIndicator.style.display = 'none';
                    const completeBadge = document.createElement('div');
                    completeBadge.className = 'alert alert-success alert-custom py-2 mt-2 fade-in';
                    completeBadge.innerHTML = `<small><strong>${data.message}</strong></small>`;
                    statusIndicators.appendChild(completeBadge);
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                    const completeStatus = document.getElementById(`${messageId}-status`);
                    if (completeStatus) {
                        completeStatus.textContent = `ÂàÜÊûêÂÆåÊàêÔºÅ`;
                    }
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶Êù°Âà∞100%
                    updateProgressBar(messageId, 100);
                    break;
                    
                case 'error':
                    typingIndicator.style.display = 'none';
                    const errorBadge = document.createElement('div');
                    errorBadge.className = 'alert alert-danger alert-custom py-2 mt-2 fade-in';
                    errorBadge.innerHTML = `<small><strong>‚ùå ${data.message}</strong></small>`;
                    statusIndicators.appendChild(errorBadge);
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                    const errorStatus = document.getElementById(`${messageId}-status`);
                    if (errorStatus) {
                        errorStatus.textContent = `ÂàÜÊûêÂá∫Èîô: ${data.message}`;
                    }
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÊòæÁ§∫ÈîôËØØ
                    const errorProgressBar = document.querySelector(`#${messageId}-progress .progress-bar`);
                    if (errorProgressBar) {
                        errorProgressBar.className = 'progress-bar bg-danger';
                        errorProgressBar.style.width = '100%';
                    }
                    break;
                
                default:
                    console.log('Êú™Â§ÑÁêÜÁöÑÊï∞ÊçÆÁ±ªÂûã:', data.type, data);
                    break;
            }
            
            // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgressBar(messageId, progress, maxProgress = null) {
            const progressBar = document.querySelector(`#${messageId}-progress .progress-bar`);
            if (progressBar) {
                // Â¶ÇÊûúÊèê‰æõ‰∫ÜÊúÄÂ§ßËøõÂ∫¶ÔºåÂàôÈöèÊú∫ÁîüÊàê‰∏Ä‰∏™Âú®ÂΩìÂâçËøõÂ∫¶ÂíåÊúÄÂ§ßËøõÂ∫¶‰πãÈó¥ÁöÑÂÄº
                if (maxProgress !== null) {
                    const currentWidth = parseFloat(progressBar.style.width) || 0;
                    if (currentWidth < progress) {
                        progress = currentWidth + Math.random() * (maxProgress - currentWidth);
                    }
                }
                
                progressBar.style.width = `${progress}%`;
            }
        }

        // Ê∑ªÂä†ÊôÆÈÄöÊ∂àÊÅØ
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = content;
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Áî®Êà∑ÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        async function showUsersList() {
            try {
                const result = await api.getAllUsers();
                
                let html = `
                    <h6>üë• ÊâÄÊúâÁî®Êà∑ÂàóË°® (${result.total_users}‰∏™)</h6>
                    <small class="text-muted">Ê¥ªË∑ÉÂàÜÊûêÂô®: ${result.active_analyzers}‰∏™</small>
                    <hr>
                `;
                
                if (result.users.length === 0) {
                    html += '<p class="text-muted">ÊöÇÊó†Áî®Êà∑ËÆ∞ÂΩï</p>';
                } else {
                    result.users.forEach(user => {
                        const isCurrentUser = userManager.getCurrentUser()?.userId === user.user_id;
                        html += `
                            <div class="border rounded p-3 mb-2 ${isCurrentUser ? 'bg-light' : ''}">
                                <div class="d-flex justify-content-between">
                                    <strong>${user.username} ${isCurrentUser ? '(ÂΩìÂâçÁî®Êà∑)' : ''}</strong>
                                    <small class="text-muted">${user.user_id}</small>
                                </div>
                                <div class="row mt-2 text-center">
                                    <div class="col-3">
                                        <small class="text-muted">Êï∞ÊçÆÂ∫ì</small><br>
                                        <span class="badge bg-${user.stats.has_database ? 'success' : 'secondary'}">
                                            ${user.stats.has_database ? '‚úÖ' : '‚ùå'}
                                        </span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">ËÆ∞ÂøÜ</small><br>
                                        <span class="badge bg-${user.stats.has_memory ? 'success' : 'secondary'}">
                                            ${user.stats.has_memory ? '‚úÖ' : '‚ùå'}
                                        </span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Êä•Âëä</small><br>
                                        <span class="badge bg-info">${user.stats.reports_count}</span>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Â§ßÂ∞è</small><br>
                                        <span class="badge bg-warning">${(user.stats.total_size / 1024).toFixed(1)}KB</span>
                                    </div>
                                </div>
                                <small class="text-muted">ÊúÄÂêéÊ¥ªÂä®: ${user.last_activity}</small>
                            </div>
                        `;
                    });
                }
                
                showInfoModal('Áî®Êà∑ÂàóË°®', html);
                
            } catch (error) {
                showErrorMessage('Ëé∑ÂèñÁî®Êà∑ÂàóË°®Â§±Ë¥•: ' + error.message);
            }
        }

        async function showUserStats() {
            try {
                const currentUser = userManager.getCurrentUser();
                if (!currentUser) {
                    showErrorMessage('ËØ∑ÂÖàÂÆåÊàêÁî®Êà∑Ë∫´‰ªΩËØÜÂà´');
                    return;
                }
                
                const result = await api.getUserStatus();
                
                const html = `
                    <h6>üìä Áî®Êà∑ÁªüËÆ°‰ø°ÊÅØ</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üë§ Âü∫Êú¨‰ø°ÊÅØ</h6>
                            <ul class="list-unstyled">
                                <li><strong>Áî®Êà∑Âêç:</strong> ${result.user_info.username}</li>
                                <li><strong>Áî®Êà∑ID:</strong> ${result.user_info.user_id}</li>
                                <li><strong>Á±ªÂûã:</strong> ${result.user_info.is_guest ? 'ËÆøÂÆ¢' : 'Ê≥®ÂÜåÁî®Êà∑'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>üìà ‰ΩøÁî®ÁªüËÆ°</h6>
                            <ul class="list-unstyled">
                                <li><strong>Êï∞ÊçÆÂ∫ì:</strong> ${result.user_stats.has_database ? 'Â∑≤ÂàõÂª∫' : 'Êú™ÂàõÂª∫'}</li>
                                <li><strong>Êï∞ÊçÆÂ∫ìÂ§ßÂ∞è:</strong> ${(result.user_stats.database_size / 1024).toFixed(1)}KB</li>
                                <li><strong>ËÆ∞ÂøÜÂ§ßÂ∞è:</strong> ${(result.user_stats.memory_size / 1024).toFixed(1)}KB</li>
                                <li><strong>Êä•ÂëäÊï∞Èáè:</strong> ${result.user_stats.reports_count}‰∏™</li>
                                <li><strong>ÊÄªÂç†Áî®:</strong> ${(result.user_stats.total_size / 1024).toFixed(1)}KB</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                showInfoModal('Áî®Êà∑ÁªüËÆ°', html);
                
            } catch (error) {
                showErrorMessage('Ëé∑ÂèñÁî®Êà∑ÁªüËÆ°Â§±Ë¥•: ' + error.message);
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'error');
        }

        function showComingSoon(feature) {
            showToast(`${feature}ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ`, 'info');
        }

        function showInfoModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂÖ≥Èó≠</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toastContainer.removeChild(toast);
            });
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ü§ñ Êô∫ËÉΩÊï∞ÊçÆÂ∫ìÂàÜÊûêÁ≥ªÁªüÊ≠£Âú®ÂàùÂßãÂåñ (Â§öÁî®Êà∑Áâà)...');
            
            // Á´ãÂç≥Ê£ÄÊü•ÂêéÁ´ØËøûÊé•Áä∂ÊÄÅ
            try {
                const healthResponse = await api.healthCheck();
                if (healthResponse && healthResponse.status === 'healthy') {
                    console.log('‚úÖ ÂêéÁ´ØÂÅ•Â∫∑Ê£ÄÊü•ÊàêÂäü:', healthResponse);
                    currentState.backendConnected = true;
                    document.getElementById('connection-status').textContent = 'Â∑≤ËøûÊé•';
                    document.getElementById('connection-status').className = 'connection-indicator connected';
                } else {
                    throw new Error('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•');
                }
            } catch (error) {
                console.error('‚ùå ÂêéÁ´ØËøûÊé•Â§±Ë¥•:', error);
                currentState.backendConnected = false;
                document.getElementById('connection-status').textContent = 'ËøûÊé•Â§±Ë¥•';
                document.getElementById('connection-status').className = 'connection-indicator';
                addMessage('‚ùå ÂêéÁ´ØÊúçÂä°ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶ÂêØÂä®', 'system');
            }
            
            // Á≠âÂæÖÁî®Êà∑ÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàê
            userManager.addUserChangeListener(async (user) => {
                if (user) {
                    console.log('‚úÖ Áî®Êà∑Â∑≤ÁôªÂΩï:', user);
                    
                    // Áî®Êà∑ÁôªÂΩïÂêéÊ£ÄÊü•Á≥ªÁªüÁä∂ÊÄÅ
                    setTimeout(async () => {
                        try {
                            const status = await checkSystemStatus();
                            if (status && status.system_ready) {
                                addMessage(`‚úÖ Ê¨¢Ëøé ${user.username}ÔºÅÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºåÊîØÊåÅÂÆûÊó∂ÊµÅÂºèÂàÜÊûê„ÄÇ`, 'system');
                                
                                if (status.database_connected) {
                                    addMessage('üìä Ê£ÄÊµãÂà∞ÊÇ®ÁöÑ‰∏ìÂ±ûÊï∞ÊçÆÂ∫ìÔºåÂèØ‰ª•Áõ¥Êé•ËøõË°åÂàÜÊûê„ÄÇ', 'system');
                                } else {
                                    addMessage('üí° ËØ∑ÂÖà‰∏ä‰º†CSVÊñá‰ª∂ÂàõÂª∫ÊÇ®ÁöÑ‰∏ìÂ±ûÊï∞ÊçÆÂ∫ì„ÄÇ', 'system');
                                }
                            } else {
                                addMessage('‚ùå ÂêéÁ´ØÊúçÂä°ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶ÂêØÂä®', 'system');
                            }
                        } catch (error) {
                            addMessage('‚ùå Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•: ' + error.message, 'system');
                        }
                    }, 1000);
                }
            });
            
            // ÂàùÂßãÊ∂àÊÅØ
            addMessage('üîÑ Ê≠£Âú®ËøõË°åÁî®Êà∑Ë∫´‰ªΩËØÜÂà´...', 'system');
        });

        // ÂÆöÊúüÁä∂ÊÄÅÊ£ÄÊü•
        setInterval(async () => {
            if (userManager.isLoggedIn()) {
                try {
                    await api.healthCheck();
                    if (!currentState.backendConnected) {
                        currentState.backendConnected = true;
                        document.getElementById('connection-status').textContent = 'Â∑≤ËøûÊé•';
                        document.getElementById('connection-status').className = 'connection-indicator connected';
                        addMessage('‚úÖ ÂêéÁ´ØÊúçÂä°ËøûÊé•Â∑≤ÊÅ¢Â§ç', 'system');
                    }
                } catch (error) {
                    if (currentState.backendConnected) {
                        currentState.backendConnected = false;
                        document.getElementById('connection-status').textContent = 'ËøûÊé•‰∏≠Êñ≠';
                        document.getElementById('connection-status').className = 'connection-indicator';
                        addMessage('‚ö†Ô∏è ÂêéÁ´ØÊúçÂä°ËøûÊé•‰∏≠Êñ≠', 'system');
                    }
                }
            }
        }, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

        // Ë∞ÉËØïËÑöÊú¨ - ÊµãËØïÂêéÁ´ØËøûÊé•
        console.log('üîç ÂºÄÂßãAPIËøûÊé•ÊµãËØï...');
        
        async function testBackendConnection() {
            // Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑÁ´ØÁÇπ
            const endpoints = [
                'http://localhost:5000/health',
                'http://localhost:5000/api/health',
                'http://127.0.0.1:5000/health',
                '/health',
                '/api/health'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`Â∞ùËØïËøûÊé•: ${endpoint}`);
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`‚úÖ ËøûÊé•ÊàêÂäü (${endpoint}):`, data);
                        return {success: true, endpoint, data};
                    } else {
                        console.log(`‚ùå ËøûÊé•Â§±Ë¥• (${endpoint}): ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`‚ùå ËøûÊé•ÈîôËØØ (${endpoint}):`, error.message);
                }
            }
            
            // ÊâÄÊúâÂ∞ùËØïÈÉΩÂ§±Ë¥•
            return {success: false, message: 'ÊâÄÊúâËøûÊé•Â∞ùËØïÂùáÂ§±Ë¥•'};
        }
        
        // È°µÈù¢Âä†ËΩΩÂêéÊâßË°åÊµãËØï
        setTimeout(() => {
            testBackendConnection().then(result => {
                console.log('APIËøûÊé•ÊµãËØïÁªìÊûú:', result);
                if (result.success) {
                    // Â¶ÇÊûúÊµãËØïÊàêÂäüÔºåÂ∞ùËØïÊâãÂä®ÂàùÂßãÂåñAPI
                    if (window.api) {
                        window.api.baseURL = result.endpoint.replace('/health', '');
                        console.log('‚úÖ Â∑≤Êõ¥Êñ∞APIÂü∫Á°ÄURL:', window.api.baseURL);
                    }
                } else {
                    // Ê∑ªÂä†‰∏Ä‰∏™Á≥ªÁªüÊ∂àÊÅØ
                    if (typeof addMessage === 'function') {
                        addMessage('‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºåËØ∑Á°Æ‰øùÊúçÂä°Âô®Â∑≤ÂêØÂä®', 'system');
                    }
                }
            });
        }, 2000);
    </script>
</body>
</html>