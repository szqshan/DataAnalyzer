<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“åˆ†æç³»ç»Ÿæµ‹è¯•é¡µé¢</title>
</head>
<body>
    <h1>æ•°æ®åº“åˆ†æç³»ç»Ÿ - æ¥å£æµ‹è¯•é¡µé¢</h1>
    
    <!-- ç”¨æˆ·ä¿¡æ¯è®¾ç½® -->
    <div>
        <h2>1. ç”¨æˆ·ä¿¡æ¯è®¾ç½®</h2>
        <label>ç”¨æˆ·ID: <input type="text" id="userId" value="test_user_001" placeholder="ç”¨æˆ·ID"></label><br><br>
        <label>ç”¨æˆ·å: <input type="text" id="username" value="TestUser" placeholder="ç”¨æˆ·å"></label><br><br>
        <label>APIå¯†é’¥: <input type="password" id="apiKey" value="" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥ (å¦‚: sk-ant-api...)" style="width: 400px;"></label><br>
        <small style="color: #666; margin-left: 80px;">ğŸ’¡ æ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‹¬ç«‹çš„APIå¯†é’¥ï¼Œç¡®ä¿æ•°æ®éš”ç¦»å’Œæˆæœ¬æ§åˆ¶</small><br><br>
        <button onclick="setUserInfo()">è®¾ç½®ç”¨æˆ·ä¿¡æ¯</button>
        <div id="currentUser">å½“å‰ç”¨æˆ·: æœªè®¾ç½®</div>
        <div id="apiKeyStatus" style="margin-top: 10px; color: #666;">APIå¯†é’¥çŠ¶æ€: æœªè®¾ç½®</div>
    </div>

    <hr>

    <!-- 2. å¥åº·æ£€æŸ¥ -->
    <div>
        <h2>2. å¥åº·æ£€æŸ¥</h2>
        <button onclick="checkHealth()">æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</button>
        <pre id="healthResult"></pre>
    </div>

    <hr>

    <!-- 3. ç³»ç»ŸçŠ¶æ€ -->
    <div>
        <h2>3. ç³»ç»ŸçŠ¶æ€</h2>
        <button onclick="getStatus()">è·å–ç³»ç»ŸçŠ¶æ€</button>
        <pre id="statusResult"></pre>
    </div>

    <hr>

    <!-- 4. å¯¹è¯ç®¡ç†åŠŸèƒ½æµ‹è¯• -->
    <div>
        <h2>4. å¯¹è¯ç®¡ç†åŠŸèƒ½æµ‹è¯•</h2>
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <h3>åˆ›å»ºæ–°å¯¹è¯</h3>
                <label>å¯¹è¯åç§°: <input type="text" id="newConversationName" placeholder="è¾“å…¥å¯¹è¯åç§°"></label><br><br>
                <label>å¯¹è¯æè¿°: <input type="text" id="newConversationDesc" placeholder="è¾“å…¥å¯¹è¯æè¿°"></label><br><br>
                <button onclick="createNewConversation()">åˆ›å»ºæ–°å¯¹è¯</button>
            </div>
            <div style="flex: 1;">
                <h3>å½“å‰å¯¹è¯</h3>
                <button onclick="getCurrentConversation()">è·å–å½“å‰å¯¹è¯</button>
                <button onclick="getConversationsList()">è·å–å¯¹è¯åˆ—è¡¨</button>
                <div id="currentConversationInfo" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #ccc; border-radius: 4px;">
                    æœªè·å–å½“å‰å¯¹è¯ä¿¡æ¯
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>å¯¹è¯åˆ—è¡¨</h3>
            <div id="conversationsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                ç‚¹å‡»"è·å–å¯¹è¯åˆ—è¡¨"æŸ¥çœ‹å¯¹è¯
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>åˆ‡æ¢å¯¹è¯</h3>
            <label>å¯¹è¯ID: <input type="text" id="switchConversationId" placeholder="è¾“å…¥è¦åˆ‡æ¢çš„å¯¹è¯ID"></label>
            <button onclick="switchConversation()">åˆ‡æ¢åˆ°è¯¥å¯¹è¯</button>
        </div>
        
        <pre id="conversationResult" style="background:#f8f8f8; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>
    </div>

    <hr>

    <!-- 5. CSVæ–‡ä»¶ä¸Šä¼  -->
    <div>
        <h2>5. CSVæ–‡ä»¶ä¸Šä¼ </h2>
        <input type="file" id="csvFile" accept=".csv"><br><br>
        <button onclick="uploadCSV()">ä¸Šä¼ CSVæ–‡ä»¶</button>
        <pre id="uploadResult"></pre>
        
        <h3>å½“å‰ä¼šè¯ä¸­çš„æ•°æ®è¡¨</h3>
        <button onclick="refreshTablesList()" id="refreshTablesBtn">ğŸ”„ åˆ·æ–°è¡¨åˆ—è¡¨</button>
        <div id="tablesList" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
            ç‚¹å‡»"åˆ·æ–°è¡¨åˆ—è¡¨"æŸ¥çœ‹å½“å‰ä¼šè¯ä¸­çš„æ•°æ®è¡¨
        </div>
    </div>

    <hr>

    <!-- 6. æµå¼æ•°æ®åˆ†æ (é‡ç‚¹æµ‹è¯•) -->
    <div>
        <h2>6. æµå¼æ•°æ®åˆ†æ (é‡ç‚¹æµ‹è¯•)</h2>
        <label>åˆ†ææŸ¥è¯¢: 
            <textarea id="analysisQuery" rows="3" cols="80" placeholder="è¾“å…¥ä½ çš„æ•°æ®åˆ†æéœ€æ±‚ï¼Œä¾‹å¦‚ï¼šåˆ†ææ•°æ®çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯å¹¶ç”Ÿæˆè¯¦ç»†çš„HTMLæŠ¥å‘Š">ç»™æˆ‘ä¸ªæŠ¥å‘Š</textarea>
        </label><br><br>
        <button onclick="startMultiTurnChat()" id="analyzeBtn">å¼€å§‹å¤šè½®å¯¹è¯ï¼ˆåŒ…å«å¯Œæ–‡æœ¬ï¼‰</button>
        <button onclick="stopAnalysis()" id="stopBtn" disabled>åœæ­¢åˆ†æ</button><br><br>
        
        <h3>æµå¼å“åº”æ—¥å¿—:</h3>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1; min-width: 0;">
                <strong>çŠ¶æ€(Status)</strong>
                <div id="streamStatusLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">ç­‰å¾…åˆ†æå¼€å§‹...</div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>AIå›å¤</strong>
                <div id="streamAIResponseLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">ç­‰å¾…AIå›å¤...</div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>å·¥å…·ç»“æœ</strong>
                <div id="streamToolLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">æ— </div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>é”™è¯¯/Error</strong>
                <div id="streamErrorLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #fff0f0; font-size: 13px; color: #b00;">æ— </div>
            </div>
        </div>
        <div style="margin-top:10px;">
            <strong>å…¨éƒ¨åŸå§‹æ—¥å¿—</strong>
            <div id="streamLog" style="border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 12px;"></div>
        </div>
        
        <h3>å¤šè½®å¯¹è¯çª—å£ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰:</h3>
        <div id="aiResponse" style="border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; background: #fff;">
            <div style="text-align: center; color: #666; padding: 40px;">
                <p>ğŸ“± å¤šè½®å¯¹è¯æ¨¡å¼</p>
                <p>è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œç‚¹å‡»"å¼€å§‹å¤šè½®å¯¹è¯"æŒ‰é’®å¼€å§‹èŠå¤©</p>
                <p>æ”¯æŒå¯Œæ–‡æœ¬æ¶ˆæ¯å’Œè¿ç»­å¯¹è¯</p>
            </div>
        </div>


    </div>

    <hr>

    <!-- 7. è®°å¿†ç®¡ç†åŠŸèƒ½ -->
    <div>
        <h2>7. è®°å¿†ç®¡ç†åŠŸèƒ½ ğŸ§ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p><strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š</strong>è®°å¿†ç®¡ç†å¯ä»¥åˆ†æå½“å‰å¯¹è¯çš„å†å²æ¶ˆæ¯ï¼Œåˆ é™¤å†—ä½™ä¿¡æ¯ï¼Œä¿ç•™å…³é”®å†…å®¹ï¼Œç”Ÿæˆç®€æ´çš„è®°å¿†æ€»ç»“ï¼Œä»è€Œå‡å°‘tokenæ¶ˆè€—ã€‚</p>
            <p><strong>âš ï¸ æ³¨æ„ï¼š</strong>è¯·ç¡®ä¿è®°å¿†ç®¡ç†æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£5002ï¼‰ï¼Œå¹¶ä¸”å·²è®¾ç½®æœ‰æ•ˆçš„APIå¯†é’¥ã€‚</p>
        </div>
        
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <h3>ğŸ“Š å½“å‰å¯¹è¯è®°å¿†ç»Ÿè®¡</h3>
                <button onclick="getMemoryStats()" id="getMemoryStatsBtn">è·å–è®°å¿†ç»Ÿè®¡</button>
                <button onclick="checkMemoryService()" id="checkMemoryServiceBtn">æ£€æŸ¥è®°å¿†æœåŠ¡</button>
                <div id="memoryStats" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #ccc; border-radius: 4px; min-height: 80px;">
                    ç‚¹å‡»"è·å–è®°å¿†ç»Ÿè®¡"æŸ¥çœ‹å½“å‰å¯¹è¯çš„è®°å¿†ä½¿ç”¨æƒ…å†µ
                </div>
            </div>
            <div style="flex: 1;">
                <h3>ğŸ§  è®°å¿†åˆ†æä¸ä¼˜åŒ–</h3>
                <button onclick="analyzeMemory()" id="analyzeMemoryBtn" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">å¼€å§‹è®°å¿†åˆ†æ</button>
                <button onclick="stopMemoryAnalysis()" id="stopMemoryBtn" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;" disabled>åœæ­¢åˆ†æ</button>
                <div id="memoryAnalysisResult" style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; min-height: 80px;">
                    è®°å¿†åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>ğŸ“‹ è®°å¿†åˆ†ææ—¥å¿—</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button onclick="clearMemoryLog()" style="padding: 4px 8px; font-size: 12px;">æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="exportMemoryLog()" style="padding: 4px 8px; font-size: 12px;">å¯¼å‡ºæ—¥å¿—</button>
            </div>
            <div id="memoryAnalysisLog" style="border: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 10px; font-family: monospace; background: #f5f5f5; font-size: 12px;">
                è®°å¿†åˆ†ææ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>âš™ï¸ è®°å¿†ç®¡ç†è®¾ç½®</h3>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="autoOptimize" checked> è‡ªåŠ¨åº”ç”¨ä¼˜åŒ–å»ºè®®
                </label>
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="confirmBeforeDelete" checked> åˆ é™¤å‰ç¡®è®¤
                </label>
                <label style="display: block; margin-bottom: 8px;">
                    è®°å¿†æœåŠ¡åœ°å€: <input type="text" id="memoryServiceUrl" value="http://localhost:5002" style="margin-left: 10px; width: 200px;">
                </label>
            </div>
        </div>
        
        <pre id="memoryResult" style="background:#f8f8f8; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>
    </div>

    <hr>

    <!-- 8. å†å²è®°å½•æ¥å£æµ‹è¯• -->
    <div>
        <h2>8. å†å²è®°å½•æ¥å£æµ‹è¯•</h2>
        <button onclick="getHistoryList()">è·å–å†å²åˆ—è¡¨</button>
        <button onclick="getHistoryStats()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
        <button onclick="getRecentHistory()">è·å–æœ€è¿‘5æ¡</button>
        <br><br>
        <label>å¯¹è¯ID: <input type="text" id="historyDetailId" placeholder="è¾“å…¥å¯¹è¯ID"></label>
        <button onclick="getHistoryDetail()">è·å–è¯¦æƒ…</button>
        <button onclick="deleteHistoryDetail()">åˆ é™¤è¯¥è®°å½•</button>
        <br><br>
        <pre id="historyResult" style="background:#f8f8f8; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>
    </div>

    <!-- æ·»åŠ å¿…è¦çš„åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">

    <style>
        /* æ‰“å­—æœºæ•ˆæœæ ·å¼ */
        .typing-text {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        /* Markdown æ ·å¼ */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
        }
        
        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
        }
        
        .markdown-content code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            background-color: rgba(27, 31, 35, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
        
        .markdown-content p {
            margin: 0 0 16px;
        }
        
        .markdown-content ul, .markdown-content ol {
            padding-left: 2em;
            margin: 0 0 16px;
        }
        
        /* æ¶ˆæ¯æ“ä½œæŒ‰é’®æ ·å¼ */
        .message-actions button {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .message-actions button:active {
            transform: translateY(0);
        }
        
        /* æ¶ˆæ¯å®¹å™¨æ‚¬åœæ•ˆæœ */
        .user-message > div:hover,
        .ai-message > div:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s ease;
        }
    </style>

    <script>
        // å…¨å±€å˜é‡
        let currentReader = null;
        let currentUserId = 'test_user_001';
        let currentUsername = 'TestUser';
        let currentApiKey = '';
        let latestReportHtml = '';
        let currentConversationId = null;
        let memoryAnalysisInProgress = false;

        // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
        function setUserInfo() {
            currentUserId = document.getElementById('userId').value || 'test_user_001';
            currentUsername = document.getElementById('username').value || 'TestUser';
            currentApiKey = document.getElementById('apiKey').value || '';
            
            document.getElementById('currentUser').textContent = `å½“å‰ç”¨æˆ·: ${currentUsername} (${currentUserId})`;
            
            // æ›´æ–°APIå¯†é’¥çŠ¶æ€æ˜¾ç¤º
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (currentApiKey) {
                const maskedKey = currentApiKey.substring(0, 8) + '***' + currentApiKey.substring(currentApiKey.length - 4);
                apiKeyStatus.textContent = `APIå¯†é’¥çŠ¶æ€: å·²è®¾ç½® (${maskedKey})`;
                apiKeyStatus.style.color = '#4CAF50';
            } else {
                apiKeyStatus.textContent = 'APIå¯†é’¥çŠ¶æ€: æœªè®¾ç½®';
                apiKeyStatus.style.color = '#f44336';
            }
            
            log('ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®: ' + currentUsername);
        }

        // è·å–è¯·æ±‚å¤´
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json',
                'X-User-ID': currentUserId,
                'X-Username': encodeURIComponent(currentUsername)
            };
            
            // åªæœ‰åœ¨APIå¯†é’¥å­˜åœ¨æ—¶æ‰æ·»åŠ 
            if (currentApiKey) {
                headers['X-API-Key'] = currentApiKey;
            }
            
            return headers;
        }

        // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å·²è®¾ç½®
        function checkApiKey() {
            if (!currentApiKey) {
                alert('è¯·å…ˆè®¾ç½®APIå¯†é’¥ï¼');
                return false;
            }
            return true;
        }

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('streamLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br/>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // åˆ†ç±»æ—¥å¿—è®°å½•å‡½æ•°
        function logByType(type, message) {
            const map = {
                'status': 'streamStatusLog',
                'ai_response': 'streamAIResponseLog',
                'tool_result': 'streamToolLog',
                'error': 'streamErrorLog',
                'html_ready': 'streamStatusLog', // ä¹Ÿå½’ä¸ºçŠ¶æ€
                'default': 'streamLog'
            };
            const divId = map[type] || map['default'];
            const div = document.getElementById(divId);
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML += `[${timestamp}] ${message}<br/>`;
            div.scrollTop = div.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—ï¼ˆä¸æ¸…ç©ºå¤šè½®å¯¹è¯çª—å£ï¼‰
        function clearLog() {
            document.getElementById('streamLog').innerHTML = '';
            document.getElementById('streamStatusLog').innerHTML = '';
            document.getElementById('streamAIResponseLog').innerHTML = '';
            document.getElementById('streamToolLog').innerHTML = '';
            document.getElementById('streamErrorLog').innerHTML = '';
        }

        // 1. å¥åº·æ£€æŸ¥
        async function checkHealth() {
            try {
                log('æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€...');
                const response = await fetch('http://localhost:5000/api/health');
                const data = await response.json();
                document.getElementById('healthResult').textContent = JSON.stringify(data, null, 2);
                log('å¥åº·æ£€æŸ¥å®Œæˆ');
            } catch (error) {
                log('å¥åº·æ£€æŸ¥å¤±è´¥: ' + error.message);
                document.getElementById('healthResult').textContent = 'Error: ' + error.message;
            }
        }

        // 2. è·å–ç³»ç»ŸçŠ¶æ€
        async function getStatus() {
            if (!checkApiKey()) return;
            
            try {
                log('æ­£åœ¨è·å–ç³»ç»ŸçŠ¶æ€...');
                const response = await fetch('http://localhost:5000/api/status', {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);
                log('ç³»ç»ŸçŠ¶æ€è·å–å®Œæˆ');
            } catch (error) {
                log('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥: ' + error.message);
                document.getElementById('statusResult').textContent = 'Error: ' + error.message;
            }
        }

        // 3. ä¸Šä¼ CSVæ–‡ä»¶
        async function uploadCSV() {
            if (!checkApiKey()) return;
            
            const fileInput = document.getElementById('csvFile');
            
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userId', currentUserId);
            formData.append('username', currentUsername);

            try {
                log('æ­£åœ¨ä¸Šä¼ CSVæ–‡ä»¶: ' + file.name);
                
                const uploadHeaders = {
                    'X-User-ID': currentUserId,
                    'X-Username-B64': btoa(unescape(encodeURIComponent(currentUsername)))
                };
                
                // æ·»åŠ APIå¯†é’¥åˆ°è¯·æ±‚å¤´
                if (currentApiKey) {
                    uploadHeaders['X-API-Key'] = currentApiKey;
                }
                
                const response = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    headers: uploadHeaders,
                    body: formData
                });

                const data = await response.json();
                document.getElementById('uploadResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    log(`CSVä¸Šä¼ æˆåŠŸ: ${data.data.rows_imported} è¡Œæ•°æ®å·²å¯¼å…¥`);
                    // ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨åˆ·æ–°è¡¨åˆ—è¡¨
                    refreshTablesList();
                } else {
                    log('CSVä¸Šä¼ å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('CSVä¸Šä¼ å‡ºé”™: ' + error.message);
                document.getElementById('uploadResult').textContent = 'Error: ' + error.message;
            }
        }

        // åˆ·æ–°è¡¨åˆ—è¡¨
        async function refreshTablesList() {
            if (!checkApiKey()) return;
            
            try {
                log('æ­£åœ¨è·å–è¡¨åˆ—è¡¨...');
                
                const headers = {
                    'X-User-ID': currentUserId,
                    'X-Username-B64': btoa(unescape(encodeURIComponent(currentUsername)))
                };
                
                if (currentApiKey) {
                    headers['X-API-Key'] = currentApiKey;
                }
                
                const response = await fetch('http://localhost:5000/api/tables-info', {
                    method: 'GET',
                    headers: headers
                });

                const data = await response.json();
                
                if (data.success) {
                    displayTablesList(data.data);
                    log(`âœ… è·å–è¡¨åˆ—è¡¨æˆåŠŸï¼Œå…± ${data.data.total_tables} ä¸ªè¡¨`);
                } else {
                    log('âŒ è·å–è¡¨åˆ—è¡¨å¤±è´¥: ' + data.message);
                    document.getElementById('tablesList').innerHTML = '<p style="color: red;">è·å–è¡¨åˆ—è¡¨å¤±è´¥: ' + data.message + '</p>';
                }
            } catch (error) {
                log('âŒ è·å–è¡¨åˆ—è¡¨å‡ºé”™: ' + error.message);
                document.getElementById('tablesList').innerHTML = '<p style="color: red;">è·å–è¡¨åˆ—è¡¨å‡ºé”™: ' + error.message + '</p>';
            }
        }

        // æ˜¾ç¤ºè¡¨åˆ—è¡¨
        function displayTablesList(data) {
            const tablesDiv = document.getElementById('tablesList');
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('displayTablesList æ¥æ”¶åˆ°çš„æ•°æ®:', data);
            console.log('data.tables ç±»å‹:', typeof data.tables);
            console.log('data.tables æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(data.tables));
            
            if (!data.tables || !Array.isArray(data.tables) || data.tables.length === 0) {
                tablesDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">å½“å‰ä¼šè¯ä¸­æ²¡æœ‰æ•°æ®è¡¨<br>è¯·å…ˆä¸Šä¼ æ–‡ä»¶</p>';
                return;
            }
            
            let html = '<div>';
            html += `<p><strong>å½“å‰ä¼šè¯ä¸­å…±æœ‰ ${data.tables.length} ä¸ªæ•°æ®è¡¨:</strong></p>`;
            
            data.tables.forEach((table, index) => {
                html += `
                    <div style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fff;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">
                            ğŸ“Š è¡¨ ${index + 1}: ${table.table_name}
                        </h4>
                        <div style="margin-left: 20px; color: #666; font-size: 14px;">
                            <p><strong>åŸå§‹æ–‡ä»¶å:</strong> ${table.original_filename}</p>
                            <p><strong>æ•°æ®è§„æ¨¡:</strong> ${table.row_count} è¡Œ Ã— ${table.column_count} åˆ—</p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(table.created_at).toLocaleString()}</p>
                            <p><strong>åˆ—å:</strong> ${table.columns.join(', ')}</p>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            tablesDiv.innerHTML = html;
        }

        // é…ç½® marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // æ‰“å­—æœºæ•ˆæœç±»
        class TypingText {
            constructor(element, options = {}) {
                this.element = element;
                this.options = {
                    speed: options.speed || 30,
                    cursor: options.cursor !== false,
                    onComplete: options.onComplete || (() => {})
                };
                
                this.queue = [];
                this.isTyping = false;
                this.currentText = '';
                
                if (this.options.cursor) {
                    this.cursor = document.createElement('span');
                    this.cursor.className = 'typing-cursor';
                    this.element.appendChild(this.cursor);
                }
            }
            
            type(text) {
                this.queue.push(text);
                if (!this.isTyping) {
                    this.startTyping();
                }
            }
            
            async startTyping() {
                this.isTyping = true;
                
                while (this.queue.length > 0) {
                    const text = this.queue.shift();
                    await this.typeText(text);
                }
                
                this.isTyping = false;
                this.options.onComplete();
            }
            
            async typeText(text) {
                const words = text.split(/(\s+)/);
                
                for (const word of words) {
                    this.currentText += word;
                    this.element.innerHTML = marked.parse(this.currentText);
                    if (this.options.cursor) {
                        this.element.appendChild(this.cursor);
                    }
                    await new Promise(resolve => setTimeout(resolve, this.options.speed));
                }
            }
            
            skip() {
                this.queue = [];
                if (this.isTyping) {
                    this.isTyping = false;
                    this.currentText += this.queue.join('');
                    this.element.innerHTML = marked.parse(this.currentText);
                    if (this.options.cursor) {
                        this.element.appendChild(this.cursor);
                    }
                    this.options.onComplete();
                }
            }
        }

        // 4. å¼€å§‹å¤šè½®å¯¹è¯ï¼ˆåŒ…å«å¯Œæ–‡æœ¬ï¼‰
        async function startMultiTurnChat() {
            if (!checkApiKey()) return;
            
            const query = document.getElementById('analysisQuery').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª
            if (!currentConversationId) {
                await createNewConversation();
            }

            // ä¸æ¸…ç©ºä»»ä½•å†…å®¹ï¼Œä¿æŒæ—¥å¿—å’Œå¯¹è¯å†å²
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            log('=== å¼€å§‹å¤šè½®å¯¹è¯ ===');
            log('ç”¨æˆ·æ¶ˆæ¯: ' + query);
            
            // åœ¨å¤šè½®å¯¹è¯çª—å£ä¸­æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessageToChat(query);
            
            // é‡ç½®AIæ¶ˆæ¯çŠ¶æ€ï¼Œå‡†å¤‡æ¥æ”¶æ–°çš„AIå›å¤
            const aiDiv = document.getElementById('aiResponse');
            aiDiv.currentAIMessage = null;
            aiDiv.typingText = null;

            try {
                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æµå¼è¯·æ±‚æ–¹å¼
                const streamHeaders = {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                    'Cache-Control': 'no-cache',
                    'X-User-ID': currentUserId,
                    'X-Username': encodeURIComponent(currentUsername)
                };
                
                // æ·»åŠ APIå¯†é’¥åˆ°è¯·æ±‚å¤´
                if (currentApiKey) {
                    streamHeaders['X-API-Key'] = currentApiKey;
                }
                
                const response = await fetch('http://localhost:5000/api/analyze-stream', {
                    method: 'POST',
                    headers: streamHeaders,
                                    body: JSON.stringify({ 
                    query: query,
                    userId: currentUserId,
                    username: currentUsername,
                    conversation_id: currentConversationId
                })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ReadableStreamæ­£ç¡®å¤„ç†æµå¼æ•°æ®
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                currentReader = reader;
                let buffer = '';

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            log('=== å¤šè½®å¯¹è¯å›å¤å®Œæˆ ===');
                            break;
                        }
                        
                        // è§£ç æ•°æ®å—
                        buffer += decoder.decode(value, { stream: true });
                        
                        // æŒ‰è¡Œå¤„ç†æ•°æ®
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                        
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            
                            if (trimmedLine === '') {
                                continue; // è·³è¿‡ç©ºè¡Œ
                            }
                            
                            // ğŸ”¥ å¤„ç†Server-Sent Eventsæ ¼å¼
                            if (trimmedLine.startsWith('data: ')) {
                                try {
                                    const jsonStr = trimmedLine.slice(6); // ç§»é™¤ 'data: '
                                    
                                    if (jsonStr === '[DONE]') {
                                        log('æ”¶åˆ°å®Œæˆä¿¡å·');
                                        break;
                                    }
                                    
                                    const data = JSON.parse(jsonStr);
                                    handleStreamMessage(data);
                                    
                                } catch (parseError) {
                                    log('è§£ææµæ•°æ®å¤±è´¥: ' + trimmedLine);
                                    console.error('Parse error:', parseError);
                                }
                            }
                        }
                    }
                } finally {
                    if (currentReader) {
                        currentReader.releaseLock();
                        currentReader = null;
                    }
                }

            } catch (error) {
                log('å¤šè½®å¯¹è¯å‡ºé”™: ' + error.message);
                console.error('Stream error:', error);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå‡†å¤‡ä¸‹ä¸€è½®å¯¹è¯
                document.getElementById('analysisQuery').value = '';
            }
        }

        // ä¿®æ”¹å¤„ç†æµå¼æ¶ˆæ¯çš„å‡½æ•°
        function handleStreamMessage(data) {
            const type = data.type;
            
            switch (type) {
                case 'status':
                    logByType('status', data.message);
                    log(`[çŠ¶æ€] ${data.message}`);
                    break;
                    
                case 'ai_response':
                    const aiDiv = document.getElementById('aiResponse');
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„AIå›å¤ï¼ˆæ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶éƒ½éœ€è¦åˆ›å»ºæ–°çš„AIæ¶ˆæ¯æ¡†ï¼‰
                    if (!aiDiv.currentAIMessage) {
                        // åˆ›å»ºæ–°çš„AIæ¶ˆæ¯
                        addAIMessageToChat('');
                        aiDiv.currentAIMessage = aiDiv.querySelector('.ai-message:last-child .message-content');
                        aiDiv.typingText = new TypingText(aiDiv.currentAIMessage, {
                            speed: 20,
                            cursor: true,
                            onComplete: () => {
                                aiDiv.scrollTop = aiDiv.scrollHeight;
                                // ä¸è¦ç«‹å³æ¸…ç©ºï¼Œç­‰å¾…ä¸‹æ¬¡æ–°æ¶ˆæ¯æ—¶å†åˆ›å»º
                            }
                        });
                    }
                    aiDiv.typingText.type(data.content);
                    logByType('ai_response', data.content);
                    log(`[AIå›å¤] æ”¶åˆ° ${data.content.length} å­—ç¬¦`);
                    break;
                    
                case 'tool_result':
                    logByType('tool_result', `${data.tool}: ${JSON.stringify(data.result).substring(0, 200)}...`);
                    log(`[å·¥å…·ç»“æœ] ${data.tool}: ${JSON.stringify(data.result).substring(0, 200)}...`);
                    break;
                    
                case 'html_ready':
                    logByType('status', `[HTMLå°±ç»ª] æŠ¥å‘Šæ–‡ä»¶: ${data.file_path}`);
                    log(`[HTMLå°±ç»ª] æŠ¥å‘Šæ–‡ä»¶: ${data.file_path}`);
                    setTimeout(() => {
                        getLatestReport();
                    }, 1000);
                    break;
                    
                case 'error':
                    logByType('error', data.message);
                    log(`[é”™è¯¯] ${data.message}`);
                    break;
                    
                case 'user_message_id':
                    // æ›´æ–°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ID
                    const tempUserMessage = document.querySelector('[data-message-id="temp"].user-message');
                    if (tempUserMessage) {
                        tempUserMessage.setAttribute('data-message-id', data.message_id);
                        // æ·»åŠ æ“ä½œæŒ‰é’®
                        const messageContainer = tempUserMessage.querySelector('div');
                        const actionsHTML = `
                            <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                                <button onclick="editMessage('${data.message_id}', 'user')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer;" title="ç¼–è¾‘æ¶ˆæ¯">âœï¸</button>
                                <button onclick="deleteMessage('${data.message_id}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="æ’¤é”€æ¶ˆæ¯">ğŸ—‘ï¸</button>
                            </div>
                        `;
                        messageContainer.insertAdjacentHTML('beforeend', actionsHTML);
                        
                        // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
                        const actionsDiv = messageContainer.querySelector('.message-actions');
                        messageContainer.addEventListener('mouseenter', () => {
                            actionsDiv.style.display = 'flex';
                        });
                        messageContainer.addEventListener('mouseleave', () => {
                            actionsDiv.style.display = 'none';
                        });
                    }
                    log(`[æ¶ˆæ¯ID] ç”¨æˆ·æ¶ˆæ¯ID: ${data.message_id}`);
                    break;
                    
                case 'ai_message_id':
                    // æ›´æ–°æœ€åä¸€æ¡AIæ¶ˆæ¯çš„ID
                    const tempAIMessage = document.querySelector('[data-message-id="temp"].ai-message');
                    if (tempAIMessage) {
                        tempAIMessage.setAttribute('data-message-id', data.message_id);
                        // æ·»åŠ æ“ä½œæŒ‰é’®
                        const messageContainer = tempAIMessage.querySelector('div');
                        const actionsHTML = `
                            <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                                <button onclick="editMessage('${data.message_id}', 'assistant')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #28a745; border: 1px solid #28a745; border-radius: 4px; cursor: pointer;" title="ç¼–è¾‘æ¶ˆæ¯">âœï¸</button>
                                <button onclick="deleteMessage('${data.message_id}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="æ’¤é”€æ¶ˆæ¯">ğŸ—‘ï¸</button>
                            </div>
                        `;
                        messageContainer.insertAdjacentHTML('beforeend', actionsHTML);
                        
                        // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
                        const actionsDiv = messageContainer.querySelector('.message-actions');
                        messageContainer.addEventListener('mouseenter', () => {
                            actionsDiv.style.display = 'flex';
                        });
                        messageContainer.addEventListener('mouseleave', () => {
                            actionsDiv.style.display = 'none';
                        });
                    }
                    log(`[æ¶ˆæ¯ID] AIæ¶ˆæ¯ID: ${data.message_id}`);
                    break;
                    
                default:
                    logByType('default', JSON.stringify(data));
                    log(`[æœªçŸ¥æ¶ˆæ¯] ${JSON.stringify(data)}`);
            }
        }

        // æ¸…ç©ºå¤šè½®å¯¹è¯çª—å£
        function clearMultiTurnChatWindow() {
            const chatDiv = document.getElementById('aiResponse');
            chatDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    <p>ğŸ“± å¤šè½®å¯¹è¯æ¨¡å¼</p>
                    <p>è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œç‚¹å‡»"å¼€å§‹å¤šè½®å¯¹è¯"æŒ‰é’®å¼€å§‹èŠå¤©</p>
                    <p>æ”¯æŒå¯Œæ–‡æœ¬æ¶ˆæ¯å’Œè¿ç»­å¯¹è¯</p>
                </div>
            `;
            // é‡ç½®çŠ¶æ€
            chatDiv.currentAIMessage = null;
            chatDiv.typingText = null;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¤šè½®å¯¹è¯çª—å£
        function addUserMessageToChat(message, messageId = null) {
            const chatDiv = document.getElementById('aiResponse');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…ç©ºæ¬¢è¿ä¿¡æ¯
            if (chatDiv.innerHTML.includes('å¤šè½®å¯¹è¯æ¨¡å¼')) {
                chatDiv.innerHTML = '';
            }
            
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.style.marginBottom = '16px';
            userDiv.style.display = 'flex';
            userDiv.style.justifyContent = 'flex-end';
            userDiv.setAttribute('data-message-id', messageId || 'temp');
            
            userDiv.innerHTML = `
                <div style="max-width: 70%; padding: 12px 16px; background: #007bff; color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; group;">
                    <div style="font-weight: 600; margin-bottom: 4px;">ğŸ‘¤ æˆ‘</div>
                    <div class="message-text" style="white-space: pre-wrap;">${message}</div>
                    ${messageId ? `
                    <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                        <button onclick="editMessage('${messageId}', 'user')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer;" title="ç¼–è¾‘æ¶ˆæ¯">âœï¸</button>
                        <button onclick="deleteMessage('${messageId}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="æ’¤é”€æ¶ˆæ¯">ğŸ—‘ï¸</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
            if (messageId) {
                const messageContainer = userDiv.querySelector('div');
                const actionsDiv = userDiv.querySelector('.message-actions');
                
                messageContainer.addEventListener('mouseenter', () => {
                    actionsDiv.style.display = 'flex';
                });
                messageContainer.addEventListener('mouseleave', () => {
                    actionsDiv.style.display = 'none';
                });
            }
            
            chatDiv.appendChild(userDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        // æ·»åŠ AIæ¶ˆæ¯åˆ°å¤šè½®å¯¹è¯çª—å£
        function addAIMessageToChat(content, messageId = null) {
            const chatDiv = document.getElementById('aiResponse');
            
            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-message';
            aiDiv.style.marginBottom = '16px';
            aiDiv.style.display = 'flex';
            aiDiv.style.justifyContent = 'flex-start';
            aiDiv.setAttribute('data-message-id', messageId || 'temp');
            
            aiDiv.innerHTML = `
                <div style="max-width: 70%; padding: 12px 16px; background: #f1f3f4; color: #333; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative;">
                    <div style="font-weight: 600; margin-bottom: 4px;">ğŸ¤– AIåŠ©æ‰‹</div>
                    <div class="message-content" style="white-space: pre-wrap;">${content}</div>
                    ${messageId ? `
                    <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                        <button onclick="editMessage('${messageId}', 'assistant')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #28a745; border: 1px solid #28a745; border-radius: 4px; cursor: pointer;" title="ç¼–è¾‘æ¶ˆæ¯">âœï¸</button>
                        <button onclick="deleteMessage('${messageId}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="æ’¤é”€æ¶ˆæ¯">ğŸ—‘ï¸</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
            if (messageId) {
                const messageContainer = aiDiv.querySelector('div');
                const actionsDiv = aiDiv.querySelector('.message-actions');
                
                messageContainer.addEventListener('mouseenter', () => {
                    actionsDiv.style.display = 'flex';
                });
                messageContainer.addEventListener('mouseleave', () => {
                    actionsDiv.style.display = 'none';
                });
            }
            
            chatDiv.appendChild(aiDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // ä»æ¶ˆæ¯å†…å®¹ä¸­æå–æ–‡æœ¬
        function extractTextContent(content) {
            if (typeof content === 'string') {
                return content;
            }
            if (Array.isArray(content)) {
                let text = '';
                content.forEach(block => {
                    if (block.type === 'text') {
                        text += block.text;
                    } else if (block.type === 'tool_use') {
                        text += `[ä½¿ç”¨å·¥å…·: ${block.name}]`;
                    } else if (block.type === 'tool_result') {
                        text += `[å·¥å…·ç»“æœ]`;
                    }
                });
                return text;
            }
            return String(content);
        }

        // æ¸²æŸ“å†å²æ¶ˆæ¯åˆ°å¤šè½®å¯¹è¯çª—å£
        function renderHistoryMessages(messages) {
            if (!messages || messages.length === 0) {
                log('ğŸ“š å½“å‰å¯¹è¯æš‚æ— å†å²æ¶ˆæ¯');
                return;
            }
            
            log(`ğŸ“š æ­£åœ¨åŠ è½½ ${messages.length} æ¡å†å²æ¶ˆæ¯...`);
            
            // æ¸…ç©ºçª—å£
            const chatDiv = document.getElementById('aiResponse');
            chatDiv.innerHTML = '';
            
            // æ¸²æŸ“æ¯æ¡æ¶ˆæ¯
            messages.forEach((msg, index) => {
                if (msg.role === 'user') {
                    const textContent = extractTextContent(msg.content);
                    if (textContent.trim()) {
                        addUserMessageToChat(textContent, msg.id);
                    }
                } else if (msg.role === 'assistant') {
                    const textContent = extractTextContent(msg.content);
                    if (textContent.trim()) {
                        addAIMessageToChat(textContent, msg.id);
                    }
                }
                // è·³è¿‡tool_resultæ¶ˆæ¯ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸åŒ…å«åœ¨assistantæ¶ˆæ¯ä¸­
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            log(`âœ… å†å²æ¶ˆæ¯åŠ è½½å®Œæˆï¼Œå…±æ˜¾ç¤º ${messages.length} æ¡æ¶ˆæ¯`);
        }

        // åœæ­¢åˆ†æ
        function stopAnalysis() {
            if (currentReader) {
                currentReader.cancel();
                currentReader = null;
            }
            log('åˆ†æå·²åœæ­¢');
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // 5. è·å–æœ€æ–°HTMLæŠ¥å‘Š (ä¿®å¤ç‰ˆæœ¬)
        async function getLatestReport() {
            try {
                log('æ­£åœ¨è·å–æœ€æ–°HTMLæŠ¥å‘Š...');
                
                const response = await fetch('http://localhost:5000/api/latest-report', {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                
                if (data.success && data.html_content) {
                    log('HTMLæŠ¥å‘Šè·å–æˆåŠŸ');
                    latestReportHtml = data.html_content;
                    
                    // æ˜¾ç¤ºæŠ¥å‘Šä¿¡æ¯
                    document.getElementById('reportInfo').innerHTML = `
                        <strong>æŠ¥å‘Šä¿¡æ¯:</strong><br>
                        æ–‡ä»¶è·¯å¾„: ${data.file_path}<br>
                        æœ€åä¿®æ”¹: ${data.last_modified}<br>
                        æ–‡ä»¶å¤§å°: ${data.file_size} å­—ç¬¦<br>
                        <button onclick="showReportInFrame()">åœ¨ä¸‹æ–¹é¢„è§ˆ</button>
                    `;
                    
                    // å¯ç”¨æŸ¥çœ‹æŒ‰é’®
                    document.getElementById('viewReportBtn').disabled = false;
                    
                    log(`HTMLæŠ¥å‘ŠåŠ è½½æˆåŠŸï¼Œå¤§å°: ${data.file_size} å­—ç¬¦`);
                } else {
                    log('è·å–HTMLæŠ¥å‘Šå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    document.getElementById('reportInfo').innerHTML = 'è·å–æŠ¥å‘Šå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                log('è·å–HTMLæŠ¥å‘Šå‡ºé”™: ' + error.message);
                document.getElementById('reportInfo').innerHTML = 'Error: ' + error.message;
            }
        }

        // åœ¨iframeä¸­æ˜¾ç¤ºæŠ¥å‘Š
        function showReportInFrame() {
            if (latestReportHtml) {
                const iframe = document.getElementById('reportFrame');
                iframe.style.display = 'block';
                iframe.srcdoc = latestReportHtml;
                log('HTMLæŠ¥å‘Šå·²åœ¨ä¸‹æ–¹æ˜¾ç¤º');
            }
        }

        // åœ¨æ–°æ ‡ç­¾é¡µæŸ¥çœ‹æŠ¥å‘Š
        function viewReportInNewTab() {
            if (latestReportHtml) {
                const newWindow = window.open();
                newWindow.document.write(latestReportHtml);
                newWindow.document.close();
                log('HTMLæŠ¥å‘Šå·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®é»˜è®¤ç”¨æˆ·ä¿¡æ¯
        window.addEventListener('load', function() {
            setUserInfo();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½å®Œæˆ');
            
            // è‡ªåŠ¨è¿›è¡Œè¿æ¥æµ‹è¯•
            setTimeout(() => {
                checkHealth();
            }, 500);
        });

        // ğŸ”¥ æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', event => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            log('å…¨å±€é”™è¯¯: ' + event.reason);
        });

        window.addEventListener('error', event => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            log('JavaScripté”™è¯¯: ' + event.error);
        });

        // å†å²è®°å½•ç›¸å…³API
        async function getHistoryList() {
            const limit = 10, offset = 0;
            const response = await fetch(`http://localhost:5000/api/conversations?limit=${limit}&offset=${offset}`, {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getHistoryStats() {
            const response = await fetch('http://localhost:5000/api/conversations/stats', {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getRecentHistory() {
            const response = await fetch('http://localhost:5000/api/conversations/recent?limit=5', {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getHistoryDetail() {
            const id = document.getElementById('historyDetailId').value.trim();
            if (!id) { alert('è¯·è¾“å…¥å¯¹è¯ID'); return; }
            const response = await fetch(`http://localhost:5000/api/conversations/${id}`, {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function deleteHistoryDetail() {
            const id = document.getElementById('historyDetailId').value.trim();
            if (!id) { alert('è¯·è¾“å…¥å¯¹è¯ID'); return; }
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å¯¹è¯è®°å½•å—ï¼Ÿ')) return;
            const response = await fetch(`http://localhost:5000/api/conversations/${id}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }

        // å¯¹è¯ç®¡ç†ç›¸å…³API
        async function createNewConversation() {
            try {
                const conversationName = document.getElementById('newConversationName').value.trim();
                const description = document.getElementById('newConversationDesc').value.trim();
                const response = await fetch('http://localhost:5000/api/conversations/create', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        conversation_name: conversationName || undefined,
                        description: description || undefined
                    })
                });
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                if (data.success) {
                    currentConversationId = data.conversation.conversation_id;
                    log('æ–°å¯¹è¯åˆ›å»ºæˆåŠŸ: ' + data.conversation.conversation_name);
                    
                    // æ¸…ç©ºå¤šè½®å¯¹è¯çª—å£ï¼Œæ˜¾ç¤ºæ–°å¯¹è¯çš„æ¬¢è¿ä¿¡æ¯
                    clearMultiTurnChatWindow();
                    
                    getConversationsList();
                    getCurrentConversation();
                } else {
                    log('åˆ›å»ºå¯¹è¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('åˆ›å»ºå¯¹è¯å‡ºé”™: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getConversationsList() {
            try {
                const response = await fetch('http://localhost:5000/api/conversations/list', {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    // æ›´æ–°å¯¹è¯åˆ—è¡¨æ˜¾ç¤º
                    const listDiv = document.getElementById('conversationsList');
                    if (data.conversations && data.conversations.length > 0) {
                        let html = '<div style="font-weight: bold; margin-bottom: 10px;">å¯¹è¯åˆ—è¡¨:</div>';
                        data.conversations.forEach(conv => {
                            const isCurrent = conv.conversation_id === data.current_conversation_id;
                            html += `
                                <div style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: ${isCurrent ? '#e6f3ff' : '#fff'};">
                                    <div><strong>${conv.conversation_name}</strong> ${isCurrent ? '(å½“å‰)' : ''}</div>
                                    <div style="font-size: 12px; color: #666;">ID: ${conv.conversation_id}</div>
                                    <div style="font-size: 12px; color: #666;">æè¿°: ${conv.description || 'æ— '}</div>
                                    <div style="font-size: 12px; color: #666;">åˆ›å»ºæ—¶é—´: ${conv.created_time}</div>
                                    <div style="font-size: 12px; color: #666;">æ¶ˆæ¯æ•°: ${conv.message_count}</div>
                                    <button onclick="switchToConversation('${conv.conversation_id}')" style="margin-top: 5px; padding: 2px 8px; font-size: 11px;">åˆ‡æ¢åˆ°æ­¤å¯¹è¯</button>
                                    <button onclick="deleteConversation('${conv.conversation_id}', '${conv.conversation_name}')" style="margin-top: 5px; margin-left: 5px; padding: 2px 8px; font-size: 11px; background-color: #ff4444; color: white; border: none; border-radius: 3px;">åˆ é™¤</button>
                                </div>
                            `;
                        });
                        listDiv.innerHTML = html;
                    } else {
                        listDiv.innerHTML = 'æš‚æ— å¯¹è¯';
                    }
                    
                    log('å¯¹è¯åˆ—è¡¨è·å–æˆåŠŸï¼Œå…± ' + (data.conversations ? data.conversations.length : 0) + ' ä¸ªå¯¹è¯');
                } else {
                    log('è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('è·å–å¯¹è¯åˆ—è¡¨å‡ºé”™: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getCurrentConversation() {
            try {
                const response = await fetch('http://localhost:5000/api/conversations/current', {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.current_conversation) {
                    const conv = data.current_conversation;
                    currentConversationId = conv.conversation_id;
                    const infoDiv = document.getElementById('currentConversationInfo');
                    infoDiv.innerHTML = `
                        <div><strong>å½“å‰å¯¹è¯:</strong> ${conv.conversation_name}</div>
                        <div><strong>å¯¹è¯ID:</strong> ${conv.conversation_id}</div>
                        <div><strong>æè¿°:</strong> ${conv.description || 'æ— '}</div>
                        <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${conv.created_time}</div>
                        <div><strong>æœ€åæ´»åŠ¨:</strong> ${conv.last_activity}</div>
                        <div><strong>æ¶ˆæ¯æ•°:</strong> ${conv.message_count}</div>
                    `;
                    
                    // åŠ è½½å†å²æ¶ˆæ¯åˆ°å¤šè½®å¯¹è¯çª—å£
                    if (conv.messages) {
                        renderHistoryMessages(conv.messages);
                    } else {
                        clearMultiTurnChatWindow();
                    }
                    
                    log('å½“å‰å¯¹è¯ä¿¡æ¯è·å–æˆåŠŸ: ' + conv.conversation_name);
                } else {
                    document.getElementById('currentConversationInfo').innerHTML = 'æœªè·å–åˆ°å½“å‰å¯¹è¯ä¿¡æ¯';
                    log('è·å–å½“å‰å¯¹è¯å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                log('è·å–å½“å‰å¯¹è¯å‡ºé”™: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function switchConversation() {
            try {
                const conversationId = document.getElementById('switchConversationId').value.trim();
                if (!conversationId) {
                    alert('è¯·è¾“å…¥å¯¹è¯ID');
                    return;
                }
                const response = await fetch('http://localhost:5000/api/conversations/switch', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        conversation_id: conversationId
                    })
                });
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                if (data.success) {
                    currentConversationId = data.current_conversation.conversation_id;
                    log('å¯¹è¯åˆ‡æ¢æˆåŠŸ: ' + data.current_conversation.conversation_name);
                    
                    // åŠ è½½å†å²æ¶ˆæ¯åˆ°å¤šè½®å¯¹è¯çª—å£
                    if (data.current_conversation.messages) {
                        renderHistoryMessages(data.current_conversation.messages);
                    } else {
                        clearMultiTurnChatWindow();
                    }
                    
                    getCurrentConversation();
                    getConversationsList();
                } else {
                    log('å¯¹è¯åˆ‡æ¢å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('åˆ‡æ¢å¯¹è¯å‡ºé”™: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        // ä¾¿æ·åˆ‡æ¢å¯¹è¯å‡½æ•°
        function switchToConversation(conversationId) {
            document.getElementById('switchConversationId').value = conversationId;
            switchConversation();
        }

        // åˆ é™¤å¯¹è¯å‡½æ•°
        async function deleteConversation(conversationId, conversationName) {
            try {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è¯"${conversationName}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`å¯¹è¯"${conversationName}"åˆ é™¤æˆåŠŸ`);
                    // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                    getConversationsList();
                    // åˆ·æ–°å½“å‰å¯¹è¯ä¿¡æ¯
                    getCurrentConversation();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    log('åˆ é™¤å¯¹è¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¯¹è¯å‡ºé”™: ' + error.message);
                log('åˆ é™¤å¯¹è¯å‡ºé”™: ' + error.message);
            }
        }

        // ç¼–è¾‘æ¶ˆæ¯å‡½æ•°
        async function editMessage(messageId, role) {
            try {
                if (!currentConversationId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯');
                    return;
                }
                
                // è·å–å½“å‰æ¶ˆæ¯å†…å®¹
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (!messageElement) {
                    alert('æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„æ¶ˆæ¯');
                    return;
                }
                
                const currentText = messageElement.querySelector('.message-text, .message-content').textContent;
                
                // å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†
                const newContent = prompt('ç¼–è¾‘æ¶ˆæ¯å†…å®¹:', currentText);
                if (newContent === null || newContent.trim() === '') {
                    return; // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©º
                }
                
                if (newContent === currentText) {
                    return; // å†…å®¹æœªå˜åŒ–
                }
                
                log(`ğŸ“ æ­£åœ¨ç¼–è¾‘æ¶ˆæ¯ ${messageId}...`);
                
                // å‘é€ç¼–è¾‘è¯·æ±‚
                const response = await fetch(`http://localhost:5000/api/conversations/${currentConversationId}/messages/${messageId}/edit`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        new_content: newContent
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`âœ… æ¶ˆæ¯ç¼–è¾‘æˆåŠŸ`);
                    
                    // æ›´æ–°å‰ç«¯æ˜¾ç¤º
                    const textElement = messageElement.querySelector('.message-text, .message-content');
                    textElement.textContent = newContent;
                    
                    // åˆ·æ–°å½“å‰å¯¹è¯ä¿¡æ¯
                    getCurrentConversation();
                } else {
                    alert('ç¼–è¾‘æ¶ˆæ¯å¤±è´¥: ' + data.message);
                    log('ç¼–è¾‘æ¶ˆæ¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('ç¼–è¾‘æ¶ˆæ¯å‡ºé”™: ' + error.message);
                log('ç¼–è¾‘æ¶ˆæ¯å‡ºé”™: ' + error.message);
            }
        }

        // åˆ é™¤æ¶ˆæ¯å‡½æ•°
        async function deleteMessage(messageId) {
            try {
                if (!currentConversationId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯');
                    return;
                }
                
                if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                    return;
                }
                
                log(`ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤æ¶ˆæ¯ ${messageId}...`);
                
                // å‘é€åˆ é™¤è¯·æ±‚
                const response = await fetch(`http://localhost:5000/api/conversations/${currentConversationId}/messages/${messageId}/delete`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`âœ… æ¶ˆæ¯åˆ é™¤æˆåŠŸ`);
                    
                    // ä»å‰ç«¯ç§»é™¤æ¶ˆæ¯
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                    
                    // åˆ·æ–°å½“å‰å¯¹è¯ä¿¡æ¯
                    getCurrentConversation();
                } else {
                    alert('åˆ é™¤æ¶ˆæ¯å¤±è´¥: ' + data.message);
                    log('åˆ é™¤æ¶ˆæ¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('åˆ é™¤æ¶ˆæ¯å‡ºé”™: ' + error.message);
                log('åˆ é™¤æ¶ˆæ¯å‡ºé”™: ' + error.message);
            }
        }

        // ==================== è®°å¿†ç®¡ç†åŠŸèƒ½ ====================

        // è®°å¿†ç®¡ç†æ—¥å¿—å‡½æ•°
        function logMemory(message, type = 'info') {
            const logDiv = document.getElementById('memoryAnalysisLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ',
                'analysis': 'ğŸ§ '
            }[type] || 'â„¹ï¸';
            
            logDiv.innerHTML += `[${timestamp}] ${typeIcon} ${message}<br/>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[Memory] ${message}`);
        }

        // æ¸…ç©ºè®°å¿†æ—¥å¿—
        function clearMemoryLog() {
            document.getElementById('memoryAnalysisLog').innerHTML = 'è®°å¿†åˆ†ææ—¥å¿—å·²æ¸…ç©º...<br/>';
        }

        // å¯¼å‡ºè®°å¿†æ—¥å¿—
        function exportMemoryLog() {
            const logContent = document.getElementById('memoryAnalysisLog').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `memory_analysis_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logMemory('è®°å¿†æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // è·å–è®°å¿†ç®¡ç†è¯·æ±‚å¤´
        function getMemoryHeaders() {
            if (!currentApiKey) {
                throw new Error('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
            }
            
            return {
                'Content-Type': 'application/json',
                'X-User-ID': currentUserId,
                'X-Username-B64': btoa(unescape(encodeURIComponent(currentUsername))),
                'X-API-Key': currentApiKey
            };
        }

        // è·å–è®°å¿†æœåŠ¡URL
        function getMemoryServiceUrl() {
            return document.getElementById('memoryServiceUrl').value || 'http://localhost:5002';
        }

        // æ£€æŸ¥è®°å¿†ç®¡ç†æœåŠ¡
        async function checkMemoryService() {
            try {
                logMemory('æ­£åœ¨æ£€æŸ¥è®°å¿†ç®¡ç†æœåŠ¡çŠ¶æ€...', 'info');
                
                const baseUrl = getMemoryServiceUrl();
                const response = await fetch(`${baseUrl}/memory/health`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    logMemory(`è®°å¿†æœåŠ¡è¿è¡Œæ­£å¸¸: ${data.service} v${data.version}`, 'success');
                    
                    // æ›´æ–°æœåŠ¡çŠ¶æ€æ˜¾ç¤º
                    const statsDiv = document.getElementById('memoryStats');
                    statsDiv.innerHTML = `
                        <div style="color: #28a745;">
                            <strong>âœ… è®°å¿†æœåŠ¡çŠ¶æ€ï¼šæ­£å¸¸</strong><br>
                            æœåŠ¡åç§°ï¼š${data.service}<br>
                            ç‰ˆæœ¬ï¼š${data.version}<br>
                            çŠ¶æ€ï¼š${data.status}
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                logMemory(`è®°å¿†æœåŠ¡æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                
                const statsDiv = document.getElementById('memoryStats');
                statsDiv.innerHTML = `
                    <div style="color: #dc3545;">
                        <strong>âŒ è®°å¿†æœåŠ¡çŠ¶æ€ï¼šä¸å¯ç”¨</strong><br>
                        é”™è¯¯ï¼š${error.message}<br>
                        <small>è¯·ç¡®ä¿è®°å¿†ç®¡ç†æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£5002ï¼‰</small>
                    </div>
                `;
            }
        }

        // è·å–è®°å¿†ç»Ÿè®¡
        async function getMemoryStats() {
            if (!checkApiKey()) return;
            
            if (!currentConversationId) {
                alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯');
                return;
            }
            
            try {
                logMemory('æ­£åœ¨è·å–å½“å‰å¯¹è¯çš„è®°å¿†ç»Ÿè®¡ä¿¡æ¯...', 'info');
                
                const baseUrl = getMemoryServiceUrl();
                const response = await fetch(`${baseUrl}/memory/stats`, {
                    method: 'POST',
                    headers: getMemoryHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logMemory('è®°å¿†ç»Ÿè®¡è·å–æˆåŠŸ', 'success');
                    
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const statsDiv = document.getElementById('memoryStats');
                    statsDiv.innerHTML = `
                        <div>
                            <h4>ğŸ“Š å½“å‰å¯¹è¯è®°å¿†ç»Ÿè®¡</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div>æ€»æ¶ˆæ¯æ•°: <strong>${data.total_messages}</strong></div>
                                <div>æ´»è·ƒæ¶ˆæ¯: <strong>${data.active_messages}</strong></div>
                                <div>å·²åˆ é™¤æ¶ˆæ¯: <strong>${data.deleted_messages}</strong></div>
                                <div>é‡è¦æ¶ˆæ¯: <strong>${data.important_messages}</strong></div>
                                <div>è®°å¿†æ€»ç»“: <strong>${data.memory_summaries}</strong></div>
                                <div>é¢„ä¼°Token: <strong>${data.estimated_tokens}</strong></div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px;">
                                <small>ğŸ’¡ å»ºè®®ï¼š${data.estimated_tokens > 1000 ? 'å½“å‰å¯¹è¯tokenè¾ƒå¤šï¼Œå»ºè®®è¿›è¡Œè®°å¿†ä¼˜åŒ–' : 'å½“å‰å¯¹è¯tokenä½¿ç”¨åˆç†'}</small>
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°ç»“æœæ˜¾ç¤º
                    document.getElementById('memoryResult').textContent = JSON.stringify(data, null, 2);
                } else {
                    throw new Error(data.message || 'è·å–è®°å¿†ç»Ÿè®¡å¤±è´¥');
                }
            } catch (error) {
                logMemory(`è·å–è®°å¿†ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
                
                const statsDiv = document.getElementById('memoryStats');
                statsDiv.innerHTML = `
                    <div style="color: #dc3545;">
                        <strong>âŒ è·å–è®°å¿†ç»Ÿè®¡å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // åˆ†æè®°å¿†
        async function analyzeMemory() {
            if (!checkApiKey()) return;
            
            if (!currentConversationId) {
                alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯');
                return;
            }
            
            if (memoryAnalysisInProgress) {
                alert('è®°å¿†åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            const confirmBeforeDelete = document.getElementById('confirmBeforeDelete').checked;
            if (confirmBeforeDelete && !confirm('ç¡®å®šè¦å¼€å§‹è®°å¿†åˆ†æå—ï¼Ÿæ­¤æ“ä½œå°†åˆ†æå½“å‰å¯¹è¯å¹¶å¯èƒ½åˆ é™¤å†—ä½™æ¶ˆæ¯ã€‚')) {
                return;
            }
            
            try {
                memoryAnalysisInProgress = true;
                document.getElementById('analyzeMemoryBtn').disabled = true;
                document.getElementById('stopMemoryBtn').disabled = false;
                
                logMemory('å¼€å§‹åˆ†æå½“å‰å¯¹è¯è®°å¿†...', 'analysis');
                logMemory(`å¯¹è¯ID: ${currentConversationId}`, 'info');
                
                const resultDiv = document.getElementById('memoryAnalysisResult');
                resultDiv.innerHTML = `
                    <div style="text-align: center; color: #007bff;">
                        <div>ğŸ§  è®°å¿†åˆ†æè¿›è¡Œä¸­...</div>
                        <div style="font-size: 12px; margin-top: 5px;">æ­£åœ¨ä½¿ç”¨AIåˆ†æå¯¹è¯å†å²ï¼Œè¯†åˆ«å†—ä½™å’Œå…³é”®ä¿¡æ¯</div>
                    </div>
                `;
                
                const baseUrl = getMemoryServiceUrl();
                const response = await fetch(`${baseUrl}/memory/analyze`, {
                    method: 'POST',
                    headers: getMemoryHeaders(),
                    body: JSON.stringify({
                        conversation_id: currentConversationId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logMemory('âœ… è®°å¿†åˆ†æå®Œæˆï¼', 'success');
                    
                    // ç»Ÿè®¡æ“ä½œç»“æœ
                    let deletedCount = 0;
                    let summariesAdded = 0;
                    let importantMarked = 0;
                    
                    if (data.operations_performed) {
                        data.operations_performed.forEach(op => {
                            if (op.tool === 'delete_message' && op.result.success) {
                                deletedCount++;
                                logMemory(`åˆ é™¤æ¶ˆæ¯: ${op.input.reason}`, 'info');
                            } else if (op.tool === 'add_memory_summary' && op.result.success) {
                                summariesAdded++;
                                logMemory(`æ·»åŠ è®°å¿†æ€»ç»“: ${op.input.summary_type}`, 'info');
                            } else if (op.tool === 'mark_important_message' && op.result.success) {
                                importantMarked++;
                                logMemory(`æ ‡è®°é‡è¦æ¶ˆæ¯: ${op.input.importance_level}`, 'info');
                            }
                        });
                    }
                    
                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    resultDiv.innerHTML = `
                        <div>
                            <h4>ğŸ‰ è®°å¿†åˆ†æå®Œæˆ</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0;">
                                <div style="text-align: center; padding: 8px; background: #fff3cd; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #856404;">${deletedCount}</div>
                                    <div style="font-size: 12px;">æ¶ˆæ¯å·²åˆ é™¤</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #d4edda; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #155724;">${summariesAdded}</div>
                                    <div style="font-size: 12px;">è®°å¿†æ€»ç»“</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #cce7ff; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #004085;">${importantMarked}</div>
                                    <div style="font-size: 12px;">é‡è¦æ¶ˆæ¯</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">
                                ${data.summary || 'è®°å¿†ä¼˜åŒ–å·²å®Œæˆï¼Œå¯¹è¯å†å²å·²ç²¾ç®€ã€‚'}
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°ç»“æœæ˜¾ç¤º
                    document.getElementById('memoryResult').textContent = JSON.stringify(data, null, 2);
                    
                    // åˆ·æ–°è®°å¿†ç»Ÿè®¡
                    setTimeout(() => {
                        getMemoryStats();
                        // åˆ·æ–°å½“å‰å¯¹è¯æ˜¾ç¤º
                        getCurrentConversation();
                    }, 1000);
                    
                } else {
                    throw new Error(data.message || 'è®°å¿†åˆ†æå¤±è´¥');
                }
                
            } catch (error) {
                logMemory(`è®°å¿†åˆ†æå¤±è´¥: ${error.message}`, 'error');
                
                const resultDiv = document.getElementById('memoryAnalysisResult');
                resultDiv.innerHTML = `
                    <div style="color: #dc3545;">
                        <strong>âŒ è®°å¿†åˆ†æå¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                memoryAnalysisInProgress = false;
                document.getElementById('analyzeMemoryBtn').disabled = false;
                document.getElementById('stopMemoryBtn').disabled = true;
            }
        }

        // åœæ­¢è®°å¿†åˆ†æ
        function stopMemoryAnalysis() {
            if (memoryAnalysisInProgress) {
                memoryAnalysisInProgress = false;
                document.getElementById('analyzeMemoryBtn').disabled = false;
                document.getElementById('stopMemoryBtn').disabled = true;
                logMemory('è®°å¿†åˆ†æå·²åœæ­¢', 'warning');
                
                const resultDiv = document.getElementById('memoryAnalysisResult');
                resultDiv.innerHTML = `
                    <div style="color: #ffc107;">
                        âš ï¸ è®°å¿†åˆ†æå·²è¢«ç”¨æˆ·åœæ­¢
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®°å¿†æœåŠ¡
        window.addEventListener('load', function() {
            // å»¶è¿Ÿæ£€æŸ¥è®°å¿†æœåŠ¡ï¼Œé¿å…ä¸ä¸»æœåŠ¡æ£€æŸ¥å†²çª
            setTimeout(() => {
                checkMemoryService();
            }, 2000);
        });


    </script>
</body>
</html>
    </script>
</body>
</html>
    </script>
</body>
</html>