<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ - å¼€å‘è€…æ§åˆ¶å°</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .markdown-content pre { background: #f6f8fa; padding: 1em; border-radius: 6px; overflow-x: auto; }
        .markdown-content code { background: #f6f8fa; padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; }
        .markdown-content pre code { padding: 0; background: transparent; }
        .dynamic-template-container { border: 2px dashed #3b82f6; padding: 20px; border-radius: 8px; background: white; margin-top: 20px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* æ¨¡æ‹ŸæŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .report-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .kpi { font-size: 24px; font-weight: bold; color: #1f2937; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background-color: #f9fafb; }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-white shadow rounded-lg p-4 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ</h1>
                <p class="text-sm text-gray-500">å¼€å‘è€…è°ƒè¯•æ§åˆ¶å° v3.0</p>
            </div>
            <div class="flex gap-2">
                <div class="text-right">
                    <div class="text-sm font-semibold">{{ config.username }}</div>
                    <div class="text-xs text-gray-500">{{ config.userId }}</div>
                </div>
                <button @click="showConfig = true" class="p-2 text-gray-600 hover:text-blue-600">
                    âš™ï¸ è®¾ç½®
                </button>
            </div>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="flex gap-6">
            <!-- å·¦ä¾§ä¾§è¾¹æ  -->
            <aside class="w-64 flex-shrink-0">
                <nav class="bg-white shadow rounded-lg overflow-hidden">
                    <a v-for="tab in tabs" :key="tab.id" 
                       @click="currentTab = tab.id"
                       :class="['block px-4 py-3 cursor-pointer hover:bg-gray-50 border-l-4 transition-colors', 
                                currentTab === tab.id ? 'border-blue-500 bg-blue-50 text-blue-700 font-medium' : 'border-transparent text-gray-600']">
                        {{ tab.name }}
                    </a>
                </nav>
                
                <!-- çŠ¶æ€é¢æ¿ -->
                <div class="mt-6 bg-white shadow rounded-lg p-4">
                    <h3 class="font-bold text-gray-700 mb-2">ç³»ç»ŸçŠ¶æ€</h3>
                    <div v-if="systemStatus" class="text-sm space-y-2">
                        <div class="flex justify-between">
                            <span>APIè¿æ¥:</span>
                            <span :class="systemStatus.api_status === 'connected' ? 'text-green-600' : 'text-red-600'">
                                {{ systemStatus.api_status === 'connected' ? 'æ­£å¸¸' : 'å¼‚å¸¸' }}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ•°æ®åº“:</span>
                            <span :class="systemStatus.database_connected ? 'text-green-600' : 'text-gray-500'">
                                {{ systemStatus.database_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
                            </span>
                        </div>
                        <div v-if="systemStatus.record_count" class="flex justify-between">
                            <span>è®°å½•æ•°:</span>
                            <span>{{ systemStatus.record_count }}</span>
                        </div>
                    </div>
                    <button @click="checkStatus" class="mt-3 w-full text-xs bg-gray-100 hover:bg-gray-200 py-1 rounded">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </aside>

            <!-- å³ä¾§å†…å®¹åŒº -->
            <main class="flex-1 bg-white shadow rounded-lg p-6 min-h-[600px]">
                
                <!-- 1. æ•°æ®ç®¡ç† -->
                <div v-if="currentTab === 'data'">
                    <h2 class="text-xl font-bold mb-4">æ•°æ®ä¸Šä¼ ä¸ç®¡ç†</h2>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors">
                        <input type="file" ref="fileInput" accept=".csv" class="hidden" @change="handleFileUpload">
                        <button @click="$refs.fileInput.click()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            é€‰æ‹© CSV æ–‡ä»¶
                        </button>
                        <p class="mt-2 text-gray-500 text-sm">æ”¯æŒ .csv æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
                    </div>

                    <div v-if="tables.length > 0" class="mt-8">
                        <h3 class="font-bold mb-2">å½“å‰ä¼šè¯æ•°æ®è¡¨</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">è¡¨å</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ¥æºæ–‡ä»¶</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">è¡Œæ•°</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr v-for="table in tables" :key="table.table_name">
                                        <td class="px-4 py-2 text-sm font-medium text-gray-900">{{ table.table_name }}</td>
                                        <td class="px-4 py-2 text-sm text-gray-500">{{ table.original_filename }}</td>
                                        <td class="px-4 py-2 text-sm text-gray-500">{{ table.row_count }}</td>
                                        <td class="px-4 py-2 text-sm">
                                            <button @click="deleteTable(table.table_name)" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. æ™ºèƒ½åˆ†æ -->
                <div v-if="currentTab === 'analysis'" class="flex flex-col h-[700px]">
                    <!-- èŠå¤©è®°å½•åŒº -->
                    <div class="flex-1 overflow-y-auto mb-4 border rounded p-4 space-y-4" ref="chatBox">
                        <div v-for="(msg, index) in chatMessages" :key="index" :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                            <div :class="['max-w-[80%] rounded-lg p-3 shadow-sm', 
                                        msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800']">
                                <div v-if="msg.type === 'text'" class="markdown-content" v-html="renderMarkdown(msg.content)"></div>
                                
                                <!-- åŠ¨æ€æ¨¡æ¿æ¸²æŸ“åŒºåŸŸ -->
                                <div v-if="msg.type === 'template_render'" class="mt-2 bg-white rounded p-2 border">
                                    <div class="text-xs text-gray-500 mb-1">åŠ¨æ€æ¨¡æ¿æ¸²æŸ“: {{ msg.templateName }}</div>
                                    <!-- åŠ¨æ€ç»„ä»¶æŒ‚è½½ç‚¹ -->
                                    <component :is="msg.component" :report_data="msg.data"></component>
                                </div>

                                <!-- ç”Ÿæˆæ¨¡æ¿æŒ‰é’® (ä»…é’ˆå¯¹ AI å›å¤) -->
                                <div v-if="msg.role === 'assistant' && msg.type === 'text'" class="mt-2 pt-2 border-t border-gray-200/20">
                                    <button @click="openTemplateGenerator(msg.content)" class="text-xs flex items-center gap-1 opacity-70 hover:opacity-100 transition-opacity">
                                        <span>ğŸ“</span> ä¿å­˜ä¸ºæ¨¡æ¿
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div v-if="isAnalyzing" class="flex justify-start">
                            <div class="bg-gray-100 rounded-lg p-3 text-gray-500 text-sm">
                                <span class="inline-block animate-bounce">â—</span>
                                <span class="inline-block animate-bounce delay-100">â—</span>
                                <span class="inline-block animate-bounce delay-200">â—</span>
                                {{ currentStatus }}
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒº -->
                    <div class="border-t pt-4">
                        <div v-if="activeTemplate" class="mb-2 bg-blue-50 p-2 rounded flex justify-between items-center text-sm text-blue-700">
                            <span>ğŸ“¦ æ­£åœ¨ä½¿ç”¨æ¨¡æ¿: <strong>{{ activeTemplate.name }}</strong></span>
                            <button @click="clearActiveTemplate" class="text-blue-500 hover:text-blue-700">å–æ¶ˆ</button>
                        </div>
                        <div class="flex gap-2">
                            <textarea v-model="userQuery" @keydown.enter.ctrl="startAnalysis"
                                      class="flex-1 border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none resize-none" 
                                      rows="3" 
                                      :placeholder="activeTemplate ? 'è¾“å…¥æ•°æ®èŒƒå›´æˆ–ç‰¹å®šè¦æ±‚ï¼ˆæ¨¡æ¿å·²åŒ…å«åˆ†æé€»è¾‘ï¼‰...' : 'è¾“å…¥åˆ†æéœ€æ±‚ï¼Œä¾‹å¦‚ï¼šåˆ†æä¸Šå­£åº¦çš„é”€å”®è¶‹åŠ¿...'"></textarea>
                            <button @click="startAnalysis" :disabled="isAnalyzing"
                                    class="bg-blue-600 text-white px-6 rounded hover:bg-blue-700 disabled:bg-gray-400 flex items-center">
                                <span v-if="!isAnalyzing">å‘é€</span>
                                <span v-else>åˆ†æä¸­...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. æ¨¡æ¿ç®¡ç† -->
                <div v-if="currentTab === 'templates'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">æŠ¥å‘Šæ¨¡æ¿åº“</h2>
                        <button @click="fetchTemplates" class="text-blue-600 hover:underline">åˆ·æ–°åˆ—è¡¨</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="tpl in templates" :key="tpl.id" class="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white relative group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">{{ tpl.name }}</h3>
                                    <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ tpl.description || 'æ— æè¿°' }}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button @click="viewTemplateDetail(tpl.id)" class="p-1 text-gray-400 hover:text-blue-600" title="æŸ¥çœ‹ä»£ç ">
                                        ğŸ“
                                    </button>
                                    <button @click="deleteTemplate(tpl.id)" class="p-1 text-gray-400 hover:text-red-600" title="åˆ é™¤">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-between items-center border-t pt-3">
                                <span class="text-xs text-gray-400">{{ formatDate(tpl.created_at) }}</span>
                                <button @click="useTemplate(tpl)" 
                                        class="bg-blue-50 text-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-100 font-medium">
                                    ä½¿ç”¨æ­¤æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç©ºçŠ¶æ€ -->
                        <div v-if="templates.length === 0" class="col-span-2 text-center py-10 text-gray-400 border-2 border-dashed rounded-lg">
                            <p>æš‚æ— æ¨¡æ¿</p>
                            <p class="text-sm mt-2">åœ¨æ™ºèƒ½åˆ†æçš„å¯¹è¯ä¸­ç‚¹å‡»â€œä¿å­˜ä¸ºæ¨¡æ¿â€å³å¯åˆ›å»º</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- å¼¹çª—ï¼šé…ç½® -->
        <div v-if="showConfig" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
                <h3 class="text-lg font-bold mb-4">ç³»ç»Ÿé…ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">API Key</label>
                        <input v-model="config.apiKey" type="password" class="mt-1 block w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">User ID</label>
                        <input v-model="config.userId" type="text" class="mt-1 block w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <input v-model="config.username" type="text" class="mt-1 block w-full border rounded px-3 py-2">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="showConfig = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                    <button @click="saveConfig" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—ï¼šç”Ÿæˆæ¨¡æ¿ç¡®è®¤ -->
        <div v-if="showTemplateGenerator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-[600px] shadow-xl max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">ç”Ÿæˆæ–°æ¨¡æ¿</h3>
                <div class="bg-gray-50 p-3 rounded mb-4 text-sm max-h-40 overflow-y-auto border">
                    <div class="font-bold mb-1 text-gray-500">æº HTML å†…å®¹ preview:</div>
                    <code>{{ templateSourceHtml.substring(0, 200) }}...</code>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡¥å……è¯´æ˜ (å¯é€‰)</label>
                    <textarea v-model="templateContext" placeholder="ä¾‹å¦‚ï¼šè¿™æ˜¯ä¸€ä»½åŒ…å«å­£åº¦æ”¶å…¥å’Œåˆ©æ¶¦çš„æŠ¥è¡¨..." 
                              class="w-full border rounded p-2 text-sm" rows="3"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showTemplateGenerator = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                    <button @click="confirmGenerateTemplate" 
                            :disabled="isGeneratingTemplate"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                        <span v-if="isGeneratingTemplate" class="animate-spin">âŒ›</span>
                        {{ isGeneratingTemplate ? 'AIç”Ÿæˆä¸­...' : 'å¼€å§‹ç”Ÿæˆ' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—ï¼šæ¨¡æ¿ä»£ç é¢„è§ˆ -->
        <div v-if="viewingTemplate" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-[800px] max-h-[90vh] overflow-y-auto shadow-xl flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">{{ viewingTemplate.name }}</h3>
                    <button @click="viewingTemplate = null" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-4">
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 mb-1">Vue Template</h4>
                        <pre class="bg-gray-800 text-white p-3 rounded text-sm overflow-x-auto"><code>{{ viewingTemplate.vue_template }}</code></pre>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 mb-1">Data Schema (JSON)</h4>
                        <pre class="bg-gray-800 text-white p-3 rounded text-sm overflow-x-auto"><code>{{ JSON.stringify(viewingTemplate.data_schema, null, 2) }}</code></pre>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, nextTick } = Vue;

        createApp({
            setup() {
                // é…ç½®
                const config = reactive({
                    apiKey: localStorage.getItem('apiKey') || '',
                    userId: localStorage.getItem('userId') || 'dev_user',
                    username: localStorage.getItem('username') || 'Developer'
                });
                const showConfig = ref(false);

                // çŠ¶æ€
                const currentTab = ref('analysis');
                const systemStatus = ref(null);
                const tables = ref([]);
                const templates = ref([]);
                
                // èŠå¤©ç›¸å…³
                const chatMessages = ref([
                    { role: 'assistant', type: 'text', content: 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ•°æ®åˆ†æåŠ©æ‰‹ã€‚è¯·ä¸Šä¼  CSV æ•°æ®ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ†æå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šã€‚' }
                ]);
                const userQuery = ref('');
                const isAnalyzing = ref(false);
                const currentStatus = ref('');
                const chatBox = ref(null);

                // æ¨¡æ¿ç›¸å…³
                const showTemplateGenerator = ref(false);
                const templateSourceHtml = ref('');
                const templateContext = ref('');
                const isGeneratingTemplate = ref(false);
                const viewingTemplate = ref(null);
                const activeTemplate = ref(null); // å½“å‰é€‰ä¸­çš„å¾…ä½¿ç”¨æ¨¡æ¿

                const tabs = [
                    { id: 'data', name: 'ğŸ“‚ æ•°æ®ç®¡ç†' },
                    { id: 'analysis', name: 'ğŸ¤– æ™ºèƒ½åˆ†æ' },
                    { id: 'templates', name: 'ğŸ“ æ¨¡æ¿ç®¡ç†' },
                ];

                // -----------------------------------------------------------
                // åŸºç¡€åŠŸèƒ½
                // -----------------------------------------------------------
                const saveConfig = () => {
                    localStorage.setItem('apiKey', config.apiKey);
                    localStorage.setItem('userId', config.userId);
                    localStorage.setItem('username', config.username);
                    showConfig.value = false;
                    checkStatus();
                };

                const getHeaders = () => ({
                    'Content-Type': 'application/json',
                    'X-User-ID': config.userId,
                    'X-Username': encodeURIComponent(config.username),
                    'X-API-Key': config.apiKey
                });

                const checkStatus = async () => {
                    try {
                        const res = await fetch('/api/status', { headers: getHeaders() });
                        const data = await res.json();
                        systemStatus.value = data;
                        if (data.database_connected) fetchTables();
                    } catch (e) {
                        console.error(e);
                    }
                };

                const fetchTables = async () => {
                    try {
                        const res = await fetch('/api/tables-info', { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            tables.value = data.data.tables;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);
                    // Headers for upload (no Content-Type, let browser set boundary)
                    const headers = getHeaders();
                    delete headers['Content-Type'];

                    try {
                        const res = await fetch('/api/upload', {
                            method: 'POST',
                            headers: headers,
                            body: formData
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('âœ… ä¸Šä¼ æˆåŠŸ');
                            fetchTables();
                        } else {
                            alert('âŒ ä¸Šä¼ å¤±è´¥: ' + data.message);
                        }
                    } catch (e) {
                        alert('âŒ ä¸Šä¼ å¼‚å¸¸: ' + e.message);
                    }
                };

                const deleteTable = async (tableName) => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤è¡¨ ${tableName} å—ï¼Ÿ`)) return;
                    try {
                        const res = await fetch('/api/tables/delete', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({ table_name: tableName })
                        });
                        const data = await res.json();
                        if (data.success) fetchTables();
                    } catch (e) {
                        alert(e.message);
                    }
                };

                // -----------------------------------------------------------
                // åˆ†æåŠŸèƒ½ (æ ¸å¿ƒ)
                // -----------------------------------------------------------
                const startAnalysis = async () => {
                    if (!userQuery.value.trim()) return;
                    
                    const query = userQuery.value;
                    chatMessages.value.push({ role: 'user', type: 'text', content: query });
                    userQuery.value = '';
                    isAnalyzing.value = true;
                    currentStatus.value = 'å‡†å¤‡ä¸­...';

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    await nextTick();
                    if (chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight;

                    try {
                        // æ„é€ è¯·æ±‚ä½“
                        let payload = {
                            query: query,
                            conversation_id: 'dev_console_conv_' + config.userId
                        };

                        // å¦‚æœæ¿€æ´»äº†æ¨¡æ¿ï¼Œæ³¨å…¥ System Prompt
                        if (activeTemplate.value) {
                            payload.system_prompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®è®¡ç®—å¼•æ“ã€‚è¯·æ ¹æ®ä»¥ä¸‹ Data Schema å®šä¹‰ï¼Œè®¡ç®—å¹¶è¿”å›ä¸¥æ ¼çš„ JSON æ•°æ®ã€‚

Data Schema:
${JSON.stringify(activeTemplate.value.data_schema, null, 2)}

è¦æ±‚ï¼š
1. ä»…è¿”å›åˆæ³•çš„ JSON å­—ç¬¦ä¸²ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
2. JSON ç»“æ„å¿…é¡»ä¸ Schema å®Œå…¨ä¸€è‡´ã€‚
3. é’ˆå¯¹ç”¨æˆ·å½“å‰çš„å…·ä½“æŸ¥è¯¢èŒƒå›´ï¼š${query}
`;
                        }

                        const response = await fetch('/api/analyze-stream', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify(payload)
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let aiResponseContent = '';
                        
                        // å¦‚æœæ˜¯æ¨¡æ¿æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦æ•è·æœ€ç»ˆçš„ JSON
                        let isTemplateMode = !!activeTemplate.value;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        if (data.type === 'status') {
                                            currentStatus.value = data.message;
                                        } else if (data.type === 'ai_response') {
                                            aiResponseContent += data.content;
                                            // æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯æµå¼æ˜¾ç¤ºæ–‡æœ¬ï¼‰
                                            // æš‚ä¸å®æ—¶æ›´æ–° UIï¼Œç­‰å®Œæˆåç»Ÿä¸€å¤„ç†ï¼Œæˆ–è€…ä½ å¯ä»¥å®ç°æ‰“å­—æœºæ•ˆæœ
                                        } else if (data.type === 'error') {
                                            chatMessages.value.push({ role: 'assistant', type: 'text', content: `âŒ é”™è¯¯: ${data.message}` });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }

                        // åˆ†æå®Œæˆ
                        if (isTemplateMode) {
                            // å°è¯•è§£æ JSON å¹¶åŠ¨æ€æ¸²æŸ“
                            try {
                                let jsonStr = aiResponseContent.trim();
                                // æ¸…ç†å¯èƒ½çš„ markdown
                                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.substring(7);
                                if (jsonStr.startsWith('```')) jsonStr = jsonStr.substring(3);
                                if (jsonStr.endsWith('```')) jsonStr = jsonStr.substring(0, jsonStr.length - 3);
                                
                                const jsonData = JSON.parse(jsonStr);
                                
                                // åˆ›å»ºåŠ¨æ€ç»„ä»¶
                                const DynamicReport = {
                                    template: activeTemplate.value.vue_template,
                                    props: ['report_data']
                                };

                                chatMessages.value.push({
                                    role: 'assistant',
                                    type: 'template_render',
                                    templateName: activeTemplate.value.name,
                                    component: DynamicReport,
                                    data: jsonData
                                });
                                
                                // æ¸…é™¤æ¿€æ´»çŠ¶æ€
                                activeTemplate.value = null;

                            } catch (e) {
                                console.error('JSONè§£æå¤±è´¥', e);
                                chatMessages.value.push({ role: 'assistant', type: 'text', content: 'âŒ æ¨¡æ¿æ¸²æŸ“å¤±è´¥ï¼ŒåŸå§‹æ•°æ®:\n' + aiResponseContent });
                            }
                        } else {
                            // æ™®é€šæ–‡æœ¬æ¨¡å¼
                            chatMessages.value.push({ role: 'assistant', type: 'text', content: aiResponseContent });
                        }

                    } catch (e) {
                        chatMessages.value.push({ role: 'assistant', type: 'text', content: `âŒ è¯·æ±‚å¼‚å¸¸: ${e.message}` });
                    } finally {
                        isAnalyzing.value = false;
                        currentStatus.value = '';
                        await nextTick();
                        if (chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight;
                    }
                };

                // -----------------------------------------------------------
                // æ¨¡æ¿ç®¡ç†åŠŸèƒ½
                // -----------------------------------------------------------
                const openTemplateGenerator = (htmlContent) => {
                    templateSourceHtml.value = htmlContent;
                    showTemplateGenerator.value = true;
                };

                const confirmGenerateTemplate = async () => {
                    isGeneratingTemplate.value = true;
                    try {
                        const res = await fetch('/api/templates/generate', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({
                                html_content: templateSourceHtml.value,
                                conversation_context: templateContext.value
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('âœ… æ¨¡æ¿ç”ŸæˆæˆåŠŸï¼');
                            showTemplateGenerator.value = false;
                            fetchTemplates(); // åˆ·æ–°åˆ—è¡¨
                        } else {
                            alert('âŒ ç”Ÿæˆå¤±è´¥: ' + data.message);
                        }
                    } catch (e) {
                        alert('âŒ å¼‚å¸¸: ' + e.message);
                    } finally {
                        isGeneratingTemplate.value = false;
                    }
                };

                const fetchTemplates = async () => {
                    try {
                        const res = await fetch('/api/templates', { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            templates.value = data.data;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const viewTemplateDetail = async (id) => {
                    try {
                        const res = await fetch(`/api/templates/${id}`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            viewingTemplate.value = data.data;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const deleteTemplate = async (id) => {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¨¡æ¿å—ï¼Ÿ')) return;
                    try {
                        const res = await fetch(`/api/templates/${id}`, { 
                            method: 'DELETE',
                            headers: getHeaders() 
                        });
                        const data = await res.json();
                        if (data.success) fetchTemplates();
                    } catch (e) {
                        alert(e.message);
                    }
                };

                const useTemplate = async (tpl) => {
                    // è·å–å®Œæ•´è¯¦æƒ…ä»¥æ‹¿åˆ° schema
                    try {
                        const res = await fetch(`/api/templates/${tpl.id}`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            activeTemplate.value = data.data;
                            currentTab.value = 'analysis'; // åˆ‡æ¢åˆ°åˆ†æé¡µ
                            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                            // alert(`å·²é€‰æ‹©æ¨¡æ¿ï¼š${tpl.name}\nè¯·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å…·ä½“çš„æ•°æ®èŒƒå›´ï¼ˆå¦‚ï¼š2024å¹´Q1ï¼‰`);
                        }
                    } catch (e) {
                        alert('æ— æ³•åŠ è½½æ¨¡æ¿è¯¦æƒ…');
                    }
                };

                const clearActiveTemplate = () => {
                    activeTemplate.value = null;
                };

                // å·¥å…·å‡½æ•°
                const formatDate = (str) => {
                    return new Date(str).toLocaleString();
                };

                const renderMarkdown = (text) => {
                    return marked.parse(text);
                };

                // åˆå§‹åŒ–
                onMounted(() => {
                    checkStatus();
                    fetchTemplates();
                });

                return {
                    config, showConfig, saveConfig,
                    currentTab, tabs, systemStatus, checkStatus,
                    tables, handleFileUpload, deleteTable,
                    chatMessages, userQuery, startAnalysis, isAnalyzing, currentStatus, chatBox,
                    renderMarkdown,
                    // æ¨¡æ¿ç›¸å…³
                    templates, fetchTemplates, deleteTemplate,
                    showTemplateGenerator, templateSourceHtml, templateContext, isGeneratingTemplate, openTemplateGenerator, confirmGenerateTemplate,
                    viewingTemplate, viewTemplateDetail,
                    useTemplate, activeTemplate, clearActiveTemplate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
