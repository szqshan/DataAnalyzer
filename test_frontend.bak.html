<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ - å¼€å‘è€…æ§åˆ¶å°</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .markdown-content pre { background: #f6f8fa; padding: 1em; border-radius: 6px; overflow-x: auto; }
        .markdown-content code { background: #f6f8fa; padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; }
        .markdown-content pre code { padding: 0; background: transparent; }
        .dynamic-template-container { border: 2px dashed #3b82f6; padding: 20px; border-radius: 8px; background: white; margin-top: 20px; }
        
        /* æ¨¡æ‹ŸæŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .report-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .kpi { font-size: 24px; font-weight: bold; color: #1f2937; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background-color: #f9fafb; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex-1 flex flex-col h-full">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-white shadow z-10 p-4 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-gray-800">ğŸ“Š æ™ºèƒ½æ•°æ®åº“åˆ†æç³»ç»Ÿ</h1>
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">v3.0 Dev Console</span>
            </div>
            <div class="flex gap-4 items-center">
                <!-- å¯¼èˆªTab -->
                <nav class="flex bg-gray-100 rounded p-1">
                    <button v-for="tab in tabs" :key="tab.id" 
                            @click="currentTab = tab.id"
                            :class="['px-4 py-1.5 text-sm rounded transition-colors', 
                                    currentTab === tab.id ? 'bg-white text-blue-600 shadow-sm font-medium' : 'text-gray-600 hover:text-gray-900']">
                        {{ tab.name }}
                    </button>
                </nav>

                <div class="h-6 w-px bg-gray-300 mx-2"></div>

                <div class="text-right">
                    <div class="text-sm font-semibold">{{ config.username }}</div>
                    <div class="text-xs text-gray-500 truncate w-24">{{ config.userId }}</div>
                </div>
                <button @click="showConfig = true" class="p-2 text-gray-600 hover:text-blue-600 rounded-full hover:bg-gray-100">
                    âš™ï¸
                </button>
            </div>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- 1. æ•°æ®ç®¡ç† -->
            <div v-if="currentTab === 'data'" class="flex-1 p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">æ•°æ®ä¸Šä¼ ä¸ç®¡ç†</h2>
                    
                    <!-- çŠ¶æ€å¡ç‰‡ -->
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <div class="text-gray-500 text-sm">APIè¿æ¥çŠ¶æ€</div>
                            <div class="text-lg font-bold flex items-center gap-2" :class="systemStatus?.api_status === 'connected' ? 'text-green-600' : 'text-red-600'">
                                <span class="w-2 h-2 rounded-full" :class="systemStatus?.api_status === 'connected' ? 'bg-green-600' : 'bg-red-600'"></span>
                                {{ systemStatus?.api_status === 'connected' ? 'æ­£å¸¸' : 'å¼‚å¸¸' }}
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <div class="text-gray-500 text-sm">æ•°æ®åº“è¿æ¥</div>
                            <div class="text-lg font-bold" :class="systemStatus?.database_connected ? 'text-green-600' : 'text-gray-500'">
                                {{ systemStatus?.database_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <div class="text-gray-500 text-sm">å½“å‰è¡¨è®°å½•æ•°</div>
                            <div class="text-lg font-bold text-gray-800">{{ systemStatus?.record_count || 0 }}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-8 mb-8">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center hover:border-blue-500 transition-colors bg-gray-50">
                            <input type="file" ref="fileInput" accept=".csv" class="hidden" @change="handleFileUpload">
                            <div class="text-4xl mb-4">ğŸ“‚</div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">ä¸Šä¼  CSV æ•°æ®æ–‡ä»¶</h3>
                            <p class="text-gray-500 text-sm mb-6">æ”¯æŒ .csv æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
                            <button @click="$refs.fileInput.click()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 shadow-sm transition-all">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                        </div>
                    </div>

                    <div v-if="tables.length > 0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800">å½“å‰ä¼šè¯æ•°æ®è¡¨</h3>
                            <button @click="fetchTables" class="text-sm text-blue-600 hover:underline">åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¡¨å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¥æºæ–‡ä»¶</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¡Œæ•°</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr v-for="table in tables" :key="table.table_name" class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ table.table_name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ table.original_filename }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ table.row_count }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button @click="deleteTable(table.table_name)" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. æ™ºèƒ½åˆ†æ (åŒ…å«ä¾§è¾¹æ ) -->
            <div v-if="currentTab === 'analysis'" class="flex-1 flex h-full overflow-hidden">
                <!-- å·¦ä¾§ï¼šå¯¹è¯åˆ—è¡¨ -->
                <aside class="w-72 bg-gray-50 border-r flex flex-col shrink-0">
                    <div class="p-4 border-b">
                        <button @click="createNewConversation" class="w-full bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 shadow-sm transition-all">
                            <span>+</span> æ–°å»ºå¯¹è¯
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-3 space-y-2">
                        <div v-if="conversations.length === 0" class="text-center text-gray-400 text-sm py-8">
                            æš‚æ— å†å²å¯¹è¯
                        </div>
                        <div v-for="conv in conversations" :key="conv.conversation_id" 
                             @click="switchConversation(conv.conversation_id)"
                             class="group p-3 rounded-lg cursor-pointer transition-all border relative"
                             :class="currentConversationId === conv.conversation_id ? 'bg-white border-blue-200 shadow-sm ring-1 ring-blue-200' : 'bg-transparent border-transparent hover:bg-gray-200/50'">
                            
                            <div class="font-medium text-sm text-gray-800 mb-1 truncate pr-6">{{ conv.conversation_name || 'æ–°å¯¹è¯' }}</div>
                            <div class="text-xs text-gray-500 truncate">{{ conv.last_message || conv.user_query || 'æ— å†…å®¹' }}</div>
                            <div class="text-xs text-gray-400 mt-1.5 flex justify-between">
                                <span>{{ formatTime(conv.last_activity || conv.start_time) }}</span>
                            </div>
                            
                            <!-- åˆ é™¤æŒ‰é’® -->
                            <button @click.stop="deleteConversation(conv.conversation_id)" 
                                    class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                Ã—
                            </button>
                        </div>
                    </div>
                </aside>

                <!-- ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ -->
                <main class="flex-1 flex flex-col bg-white min-w-0">
                    <!-- å¯¹è¯æ ‡é¢˜æ  -->
                    <div class="h-14 border-b flex items-center px-6 justify-between bg-white shrink-0">
                        <h3 class="font-bold text-gray-800 truncate">
                            {{ currentConversation?.conversation_name || 'æœªé€‰æ‹©å¯¹è¯' }}
                        </h3>
                        <div class="text-sm text-gray-500">
                            {{ currentConversationId ? (isAnalyzing ? 'æ­£åœ¨åˆ†æ...' : 'å°±ç»ª') : 'è¯·æ–°å»ºæˆ–é€‰æ‹©å¯¹è¯' }}
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                    <div class="flex-1 overflow-y-auto p-6 space-y-6" ref="chatBox">
                        <div v-if="chatMessages.length === 0" class="flex h-full items-center justify-center text-gray-400 flex-col gap-4">
                            <div class="text-6xl">ğŸ¤–</div>
                            <p>å¼€å§‹ä¸€ä¸ªæ–°çš„æ•°æ®åˆ†æå¯¹è¯</p>
                            <div class="flex gap-2 text-sm">
                                <button @click="quickStart('åˆ†æå½“å‰æ•°æ®çš„åŸºæœ¬æƒ…å†µ')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full border">åˆ†æåŸºæœ¬æƒ…å†µ</button>
                                <button @click="quickStart('ç»Ÿè®¡å„åˆ—çš„ç¼ºå¤±å€¼')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full border">æ£€æŸ¥ç¼ºå¤±å€¼</button>
                            </div>
                        </div>

                        <div v-for="(msg, index) in chatMessages" :key="index" :class="['flex w-full', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                            <div :class="['max-w-[85%] rounded-2xl p-4 shadow-sm', 
                                        msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']">
                                
                                <div v-if="msg.type === 'text'" class="markdown-content text-sm leading-relaxed" v-html="renderMarkdown(msg.content)"></div>
                                
                                <!-- åŠ¨æ€æ¨¡æ¿æ¸²æŸ“åŒºåŸŸ -->
                                <div v-if="msg.type === 'template_render'" class="mt-2 bg-white rounded-lg p-3 border shadow-sm">
                                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                                        <div class="text-xs text-gray-500 font-bold">ğŸ“Š {{ msg.templateName }}</div>
                                    </div>
                                    <!-- åŠ¨æ€ç»„ä»¶æŒ‚è½½ç‚¹ -->
                                    <component :is="msg.component" :report_data="msg.data"></component>
                                </div>

                                <!-- ç”Ÿæˆæ¨¡æ¿æŒ‰é’® (ä»…é’ˆå¯¹ AI å›å¤) -->
                                <div v-if="msg.role === 'assistant' && msg.type === 'text'" class="mt-3 pt-2 border-t border-gray-200/20 flex justify-end">
                                    <button @click="openTemplateGenerator(msg.content)" class="text-xs flex items-center gap-1 opacity-60 hover:opacity-100 transition-opacity bg-white/20 px-2 py-1 rounded">
                                        <span>ğŸ“</span> ä¿å­˜ä¸ºæ¨¡æ¿
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åŠ è½½åŠ¨ç”» -->
                        <div v-if="isAnalyzing" class="flex justify-start">
                            <div class="bg-gray-100 rounded-2xl rounded-bl-none p-4 text-gray-500 text-sm flex items-center gap-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                                <span>{{ currentStatus }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="p-4 border-t bg-white shrink-0">
                        <div v-if="activeTemplate" class="mb-2 bg-blue-50 p-2 rounded flex justify-between items-center text-sm text-blue-700 border border-blue-100">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded">æ¨¡æ¿æ¨¡å¼</span>
                                <strong>{{ activeTemplate.name }}</strong>
                            </div>
                            <button @click="clearActiveTemplate" class="text-blue-500 hover:text-blue-700 hover:bg-blue-100 rounded px-2">âœ• å–æ¶ˆ</button>
                        </div>

                        <!-- System Prompt é…ç½® -->
                        <div class="mb-2">
                            <button @click="useCustomSystemPrompt = !useCustomSystemPrompt" 
                                    class="text-xs text-gray-500 hover:text-blue-600 flex items-center gap-1">
                                <span>âš™ï¸</span> {{ useCustomSystemPrompt ? 'æ”¶èµ·ç³»ç»Ÿæç¤ºè¯è®¾ç½®' : 'è®¾ç½®ç³»ç»Ÿæç¤ºè¯' }}
                            </button>
                            <div v-if="useCustomSystemPrompt" class="mt-2 p-2 bg-gray-50 rounded border animate-fade-in">
                                <textarea v-model="customSystemPrompt" 
                                          class="w-full text-xs bg-white border rounded p-2 outline-none focus:border-blue-500" 
                                          rows="3" 
                                          placeholder="è¾“å…¥è‡ªå®šä¹‰ System Prompt... (å¯é€‰)"></textarea>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <textarea v-model="userQuery" @keydown.enter.ctrl="startAnalysis" @keydown.enter.exact.prevent="startAnalysis"
                                      class="w-full border rounded-xl p-3 pr-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none bg-gray-50 focus:bg-white transition-colors" 
                                      rows="3" 
                                      :placeholder="activeTemplate ? 'è¾“å…¥æ•°æ®èŒƒå›´ï¼ˆå¦‚ï¼š2023å¹´ç¬¬ä¸€å­£åº¦ï¼‰...' : 'è¾“å…¥åˆ†æéœ€æ±‚ï¼ŒæŒ‰ Enter å‘é€...'"
                                      :disabled="isAnalyzing"></textarea>
                            
                            <button @click="startAnalysis" :disabled="isAnalyzing || !userQuery.trim()"
                                    class="absolute bottom-3 right-3 bg-blue-600 text-white px-4 py-1.5 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors text-sm font-medium">
                                å‘é€
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-2 text-center">æŒ‰ Enter å‘é€ï¼ŒCtrl + Enter æ¢è¡Œ</div>
                    </div>
                </main>
            </div>

            <!-- 3. æ¨¡æ¿ç®¡ç† -->
            <div v-if="currentTab === 'templates'" class="flex-1 p-8 overflow-y-auto">
                <div class="max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">æŠ¥å‘Šæ¨¡æ¿åº“</h2>
                        <button @click="fetchTemplates" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded transition-colors">åˆ·æ–°åˆ—è¡¨</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="tpl in templates" :key="tpl.id" class="bg-white border rounded-xl p-5 hover:shadow-lg transition-all group relative flex flex-col h-64">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-lg text-gray-800 line-clamp-1" :title="tpl.name">{{ tpl.name }}</h3>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click="viewTemplateDetail(tpl.id)" class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50" title="æŸ¥çœ‹ä»£ç ">ğŸ“</button>
                                        <button @click="deleteTemplate(tpl.id)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 line-clamp-3 mb-4">{{ tpl.description || 'æ— æè¿°' }}</p>
                            </div>
                            
                            <div class="mt-auto pt-4 border-t flex justify-between items-center">
                                <span class="text-xs text-gray-400">{{ formatDate(tpl.created_at) }}</span>
                                <button @click="useTemplate(tpl)" 
                                        class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm hover:bg-blue-600 hover:text-white font-medium transition-colors">
                                    ä½¿ç”¨æ­¤æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç©ºçŠ¶æ€ -->
                        <div v-if="templates.length === 0" class="col-span-full py-20 text-center border-2 border-dashed rounded-xl bg-gray-50">
                            <div class="text-4xl mb-4">ğŸ“</div>
                            <p class="text-gray-500 font-medium">æš‚æ— æ¨¡æ¿</p>
                            <p class="text-sm text-gray-400 mt-2">åœ¨æ™ºèƒ½åˆ†æçš„å¯¹è¯ä¸­ç‚¹å‡»â€œä¿å­˜ä¸ºæ¨¡æ¿â€å³å¯åˆ›å»º</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—ï¼šé…ç½® -->
        <div v-if="showConfig" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-96 shadow-2xl transform transition-all scale-100">
                <h3 class="text-lg font-bold mb-4">ç³»ç»Ÿé…ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input v-model="config.apiKey" type="password" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                        <input v-model="config.userId" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input v-model="config.username" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="showConfig = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                    <button @click="saveConfig" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—ï¼šç”Ÿæˆæ¨¡æ¿ç¡®è®¤ -->
        <div v-if="showTemplateGenerator" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-[600px] shadow-2xl max-h-[80vh] flex flex-col">
                <h3 class="text-lg font-bold mb-4">ç”Ÿæˆæ–°æ¨¡æ¿</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-sm flex-1 overflow-y-auto border font-mono">
                    <div class="font-bold mb-2 text-gray-500 sticky top-0 bg-gray-50 pb-2 border-b">æº HTML å†…å®¹ preview:</div>
                    <div class="whitespace-pre-wrap break-all text-xs">{{ templateSourceHtml.substring(0, 500) }}...</div>
                </div>
                <div class="mb-6 shrink-0">
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¡¥å……è¯´æ˜ (å¯é€‰)</label>
                    <textarea v-model="templateContext" placeholder="ä¾‹å¦‚ï¼šè¿™æ˜¯ä¸€ä»½åŒ…å«å­£åº¦æ”¶å…¥å’Œåˆ©æ¶¦çš„æŠ¥è¡¨..." 
                              class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" rows="3"></textarea>
                </div>
                <div class="flex justify-end gap-3 shrink-0">
                    <button @click="showTemplateGenerator = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                    <button @click="confirmGenerateTemplate" 
                            :disabled="isGeneratingTemplate"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 disabled:opacity-50">
                        <span v-if="isGeneratingTemplate" class="animate-spin">âŒ›</span>
                        {{ isGeneratingTemplate ? 'AIç”Ÿæˆä¸­...' : 'å¼€å§‹ç”Ÿæˆ' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- å¼¹çª—ï¼šæ¨¡æ¿ä»£ç é¢„è§ˆ -->
        <div v-if="viewingTemplate" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-[900px] max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h3 class="text-lg font-bold">{{ viewingTemplate.name }}</h3>
                    <button @click="viewingTemplate = null" class="text-gray-500 hover:text-gray-700 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">âœ•</button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold text-gray-700">Vue Template</h4>
                            <button class="text-xs text-blue-600 hover:underline">å¤åˆ¶</button>
                        </div>
                        <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>{{ viewingTemplate.vue_template }}</code></pre>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold text-gray-700">Data Schema (JSON)</h4>
                        </div>
                        <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>{{ JSON.stringify(viewingTemplate.data_schema, null, 2) }}</code></pre>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, nextTick, watch } = Vue;

        createApp({
            setup() {
                // é…ç½®
                const config = reactive({
                    apiKey: localStorage.getItem('apiKey') || '',
                    userId: localStorage.getItem('userId') || 'dev_user',
                    username: localStorage.getItem('username') || 'Developer'
                });
                const showConfig = ref(false);

                // çŠ¶æ€
                const currentTab = ref('analysis');
                const systemStatus = ref(null);
                const tables = ref([]);
                const templates = ref([]);
                
                // èŠå¤©ç›¸å…³
                const conversations = ref([]);
                const currentConversationId = ref(null);
                const currentConversation = computed(() => 
                    conversations.value.find(c => c.conversation_id === currentConversationId.value)
                );
                const chatMessages = ref([]);
                const userQuery = ref('');
                const isAnalyzing = ref(false);
                const currentStatus = ref('');
                const chatBox = ref(null);

                // æ¨¡æ¿ç›¸å…³
                const showTemplateGenerator = ref(false);
                const templateSourceHtml = ref('');
                const templateContext = ref('');
                const isGeneratingTemplate = ref(false);
                const viewingTemplate = ref(null);
                const activeTemplate = ref(null); // å½“å‰é€‰ä¸­çš„å¾…ä½¿ç”¨æ¨¡æ¿

                const useCustomSystemPrompt = ref(false);
                const customSystemPrompt = ref('');

                const API_BASE = 'http://localhost:5000'; // åç«¯åœ°å€

                const tabs = [
                    { id: 'data', name: 'ğŸ“‚ æ•°æ®ç®¡ç†' },
                    { id: 'analysis', name: 'ğŸ¤– æ™ºèƒ½åˆ†æ' },
                    { id: 'templates', name: 'ğŸ“ æ¨¡æ¿åº“' },
                ];

                // -----------------------------------------------------------
                // åŸºç¡€åŠŸèƒ½
                // -----------------------------------------------------------
                const saveConfig = () => {
                    localStorage.setItem('apiKey', config.apiKey);
                    localStorage.setItem('userId', config.userId);
                    localStorage.setItem('username', config.username);
                    showConfig.value = false;
                    checkStatus();
                    fetchConversations();
                };

                const getHeaders = () => ({
                    'Content-Type': 'application/json',
                    'X-User-ID': config.userId,
                    'X-Username': encodeURIComponent(config.username),
                    'X-API-Key': config.apiKey
                });

                const checkStatus = async () => {
                    if (!config.apiKey) return;
                    try {
                        const res = await fetch(`${API_BASE}/api/status`, { headers: getHeaders() });
                        const data = await res.json();
                        systemStatus.value = data;
                        if (data.database_connected) fetchTables();
                    } catch (e) {
                        console.error(e);
                    }
                };

                const fetchTables = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/tables-info`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            tables.value = data.data.tables;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);
                    const headers = getHeaders();
                    delete headers['Content-Type'];

                    try {
                        const res = await fetch(`${API_BASE}/api/upload`, {
                            method: 'POST',
                            headers: headers,
                            body: formData
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('âœ… ä¸Šä¼ æˆåŠŸ');
                            fetchTables();
                        } else {
                            alert('âŒ ä¸Šä¼ å¤±è´¥: ' + data.message);
                        }
                    } catch (e) {
                        alert('âŒ ä¸Šä¼ å¼‚å¸¸: ' + e.message);
                    }
                };

                const deleteTable = async (tableName) => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤è¡¨ ${tableName} å—ï¼Ÿ`)) return;
                    try {
                        const res = await fetch(`${API_BASE}/api/tables/delete`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({ table_name: tableName })
                        });
                        const data = await res.json();
                        if (data.success) fetchTables();
                    } catch (e) {
                        alert(e.message);
                    }
                };

                // -----------------------------------------------------------
                // å¯¹è¯ç®¡ç†
                // -----------------------------------------------------------
                const fetchConversations = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/conversations?limit=20`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            conversations.value = data.conversations;
                        }
                    } catch (e) {
                        console.error("è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥", e);
                    }
                };

                const createNewConversation = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/conversations/create`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({ description: 'New Analysis Session' })
                        });
                        const data = await res.json();
                        if (data.success) {
                            await fetchConversations();
                            switchConversation(data.conversation.conversation_id);
                        }
                    } catch (e) {
                        alert('åˆ›å»ºå¯¹è¯å¤±è´¥: ' + e.message);
                    }
                };

                const switchConversation = async (id) => {
                    if (currentConversationId.value === id) return;
                    
                    try {
                        // 1. åˆ‡æ¢åç«¯çŠ¶æ€
                        const res = await fetch(`${API_BASE}/api/conversations/switch`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({ conversation_id: id })
                        });
                        
                        if (res.ok) {
                            currentConversationId.value = id;
                            loadConversationHistory(id);
                        }
                    } catch (e) {
                        console.error("åˆ‡æ¢å¯¹è¯å¤±è´¥", e);
                    }
                };

                const loadConversationHistory = async (id) => {
                    try {
                        const res = await fetch(`${API_BASE}/api/conversations/${id}`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            // è§£ææ¶ˆæ¯å†å²
                            let messages = [];
                            try {
                                if (data.conversation.messages) {
                                    // å…¼å®¹ä¸åŒçš„å­˜å‚¨æ ¼å¼
                                    messages = typeof data.conversation.messages === 'string' 
                                        ? JSON.parse(data.conversation.messages) 
                                        : data.conversation.messages;
                                }
                            } catch (e) {
                                console.error("è§£ææ¶ˆæ¯å†å²å¤±è´¥", e);
                            }
                            
                            // è½¬æ¢æ¶ˆæ¯æ ¼å¼é€‚é… UI
                            chatMessages.value = messages.map(msg => {
                                // ç®€åŒ–å¤„ç†ï¼Œå–ç¬¬ä¸€ä¸ª text å†…å®¹
                                let content = "";
                                if (Array.isArray(msg.content)) {
                                    content = msg.content.find(c => c.type === 'text')?.text || "";
                                } else {
                                    content = msg.content;
                                }
                                
                                return {
                                    role: msg.role,
                                    type: 'text', // é»˜è®¤ textï¼Œåç»­å¯ä»¥å¢å¼ºæ”¯æŒ tool_use
                                    content: content
                                };
                            });
                            
                            await nextTick();
                            scrollToBottom();
                        }
                    } catch (e) {
                        console.error("åŠ è½½å†å²è¯¦æƒ…å¤±è´¥", e);
                    }
                };

                const deleteConversation = async (id) => {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤å¯¹è¯è®°å½•å—ï¼Ÿ')) return;
                    try {
                        const res = await fetch(`${API_BASE}/api/conversations/${id}`, {
                            method: 'DELETE',
                            headers: getHeaders()
                        });
                        if (res.ok) {
                            if (currentConversationId.value === id) {
                                currentConversationId.value = null;
                                chatMessages.value = [];
                            }
                            fetchConversations();
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                };

                // -----------------------------------------------------------
                // åˆ†æåŠŸèƒ½ (æ ¸å¿ƒ)
                // -----------------------------------------------------------
                const quickStart = (text) => {
                    userQuery.value = text;
                    startAnalysis();
                };

                const startAnalysis = async () => {
                    if (!userQuery.value.trim()) return;
                    
                    // 1. å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œå…ˆåˆ›å»º
                    if (!currentConversationId.value) {
                        try {
                            const res = await fetch(`${API_BASE}/api/conversations/create`, {
                                method: 'POST',
                                headers: getHeaders(),
                                body: JSON.stringify({ description: 'New Chat' })
                            });
                            const data = await res.json();
                            if (data.success) {
                                await fetchConversations();
                                currentConversationId.value = data.conversation.conversation_id;
                                // ç­‰å¾…ä¸€ç‚¹æ—¶é—´ç¡®ä¿çŠ¶æ€åŒæ­¥
                                await new Promise(r => setTimeout(r, 100));
                            } else {
                                throw new Error("æ— æ³•è‡ªåŠ¨åˆ›å»ºå¯¹è¯");
                            }
                        } catch (e) {
                            alert("åˆ›å»ºæ–°å¯¹è¯å¤±è´¥: " + e.message);
                            return;
                        }
                    }

                    const query = userQuery.value;
                    // ä¹è§‚æ›´æ–° UI
                    chatMessages.value.push({ role: 'user', type: 'text', content: query });
                    userQuery.value = '';
                    isAnalyzing.value = true;
                    currentStatus.value = 'AI æ€è€ƒä¸­...';

                    await nextTick();
                    scrollToBottom();

                    try {
                        let payload = {
                            query: query,
                            conversation_id: currentConversationId.value
                        };

                        // å¦‚æœæ¿€æ´»äº†æ¨¡æ¿ï¼Œæ³¨å…¥ System Prompt
                        if (activeTemplate.value) {
                            payload.system_prompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®è®¡ç®—å¼•æ“ã€‚è¯·æ ¹æ®ä»¥ä¸‹ Data Schema å®šä¹‰ï¼Œè®¡ç®—å¹¶è¿”å›ä¸¥æ ¼çš„ JSON æ•°æ®ã€‚

Data Schema:
${JSON.stringify(activeTemplate.value.data_schema, null, 2)}

è¦æ±‚ï¼š
1. ä»…è¿”å›åˆæ³•çš„ JSON å­—ç¬¦ä¸²ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
2. JSON ç»“æ„å¿…é¡»ä¸ Schema å®Œå…¨ä¸€è‡´ã€‚
3. é’ˆå¯¹ç”¨æˆ·å½“å‰çš„å…·ä½“æŸ¥è¯¢èŒƒå›´ï¼š${query}
`;
                        } else if (useCustomSystemPrompt.value && customSystemPrompt.value.trim()) {
                            // è‡ªå®šä¹‰ System Prompt
                            payload.system_prompt = customSystemPrompt.value.trim();
                        }

                        const response = await fetch(`${API_BASE}/api/analyze-stream`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify(payload)
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let aiResponseContent = '';
                        let isTemplateMode = !!activeTemplate.value;
                        
                        // åˆå§‹åŒ– AI å›å¤æ¶ˆæ¯
                        if (!isTemplateMode) {
                            chatMessages.value.push({ role: 'assistant', type: 'text', content: '' });
                        }

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        if (data.type === 'status') {
                                            currentStatus.value = data.message;
                                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                            await nextTick();
                                            scrollToBottom();
                                        } else if (data.type === 'ai_response') {
                                            aiResponseContent += data.content;
                                            
                                            // å®æ—¶æ‰“å­—æœºæ•ˆæœ (éæ¨¡æ¿æ¨¡å¼)
                                            if (!isTemplateMode) {
                                                const lastMsg = chatMessages.value[chatMessages.value.length - 1];
                                                if (lastMsg.role === 'assistant' && lastMsg.type === 'text') {
                                                    lastMsg.content = aiResponseContent;
                                                }
                                                await nextTick();
                                                scrollToBottom();
                                            }
                                        } else if (data.type === 'tool_result') {
                                            // æ˜¾ç¤ºå·¥å…·è°ƒç”¨ç»“æœ
                                            chatMessages.value.push({ 
                                                role: 'system', 
                                                type: 'tool_result', 
                                                content: `ğŸ› ï¸ å·¥å…·è°ƒç”¨ç»“æœ [${data.tool}]:\n` + '```json\n' + JSON.stringify(data.result, null, 2) + '\n```'
                                            });
                                            // å¦‚æœæ˜¯éæ¨¡æ¿æ¨¡å¼ï¼Œéœ€è¦é‡æ–°è¿½åŠ ä¸€ä¸ªç©ºçš„ assistant æ¶ˆæ¯ç”¨äºåç»­æ–‡æœ¬
                                            if (!isTemplateMode) {
                                                chatMessages.value.push({ role: 'assistant', type: 'text', content: '' });
                                                // é‡ç½®ç´¯ç§¯å†…å®¹ï¼Œå› ä¸ºæ–°çš„æ–‡æœ¬æ˜¯æ–°çš„æ®µè½
                                                // æ³¨æ„ï¼šè¿™é‡Œå–å†³äºåç«¯æ˜¯è¿½åŠ è¿˜æ˜¯å…¨æ–°çš„ contentã€‚åç«¯é€»è¾‘æ˜¯è¿½åŠ ã€‚
                                                // ç®€å•å¤„ç†ï¼šä¸é‡ç½® aiResponseContentï¼Œä½† UI ä¸Šå¯èƒ½ä¼šæœ‰æ–­å±‚ã€‚
                                                // æ›´å¥½çš„åšæ³•ï¼šå·¥å…·ç»“æœåªä½œä¸ºæ’å…¥æ¶ˆæ¯ï¼Œä¸å½±å“ aiResponseContent çš„ç´¯ç§¯ã€‚
                                                // ä½†å› ä¸ºæˆ‘ä»¬å·²ç» push äº†æ–°æ¶ˆæ¯ï¼Œä¹‹å‰çš„ assistant æ¶ˆæ¯å°±å®šæ ¼äº†ã€‚
                                                // ä¿®æ­£ç­–ç•¥ï¼šä¿æŒ aiResponseContent ç´¯ç§¯ï¼Œå¹¶åœ¨æ–°çš„ assistant æ¶ˆæ¯ä¸­åªæ˜¾ç¤ºæ–°å¢éƒ¨åˆ†ï¼Ÿ
                                                // æˆ–è€…ï¼Œç®€å•ç‚¹ï¼Œå·¥å…·ç»“æœä¸æ‰“æ–­ assistant æ¶ˆæ¯æµï¼Œè€Œæ˜¯ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯æ’å…¥ï¼Ÿ
                                                // ä½† UI åˆ—è¡¨æ˜¯çº¿æ€§çš„ã€‚
                                                // æš‚æ—¶ç­–ç•¥ï¼šå·¥å…·ç»“æœä½œä¸º system æ¶ˆæ¯æ’å…¥ï¼Œåç»­ AI æ–‡æœ¬ç»§ç»­è¿½åŠ åˆ°æœ€æ–°çš„ assistant æ¶ˆæ¯ä¸­ã€‚
                                                // å¦‚æœä¸Šä¸€æ¡æ˜¯ systemï¼Œåˆ™æ–°å»º assistantã€‚
                                                
                                                // é‡æ–°å®šä½åˆ°æœ€æ–°çš„ assistant æ¶ˆæ¯
                                                // aiResponseContent åŒ…å«äº†å…¨éƒ¨å†å²ï¼Ÿä¸ï¼Œæ˜¯å¢é‡ã€‚
                                                // å®é™…ä¸Šåç«¯è¿”å›çš„æ˜¯å¢é‡ contentã€‚
                                                // aiResponseContent æ˜¯æˆ‘ä»¬åœ¨å‰ç«¯ç´¯ç§¯çš„ã€‚
                                                
                                                // å¦‚æœæ’å…¥äº† tool_resultï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„å®¹å™¨æ¥æ‰¿è½½åç»­çš„ AI æ–‡æœ¬
                                                // ä½† aiResponseContent å·²ç»åŒ…å«äº†ä¹‹å‰çš„æ–‡æœ¬ã€‚
                                                // è¿™æ˜¯ä¸€ä¸ªå¤æ‚ç‚¹ã€‚
                                                // ç®€åŒ–æ–¹æ¡ˆï¼šå·¥å…·ç»“æœåªåœ¨æ§åˆ¶å°æˆ–çŠ¶æ€æ æ˜¾ç¤ºï¼Œæˆ–è€…ä»¥ç‰¹æ®Š UI åµŒå…¥ã€‚
                                                // è¿™é‡Œä¸ºäº†æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œæˆ‘ä»¬ä½œä¸º system æ¶ˆæ¯æ’å…¥ã€‚
                                                // å¹¶ä¸”æ¸…ç©º aiResponseContentï¼Œå‡è®¾å·¥å…·è°ƒç”¨åçš„æ–‡æœ¬æ˜¯æ–°çš„å“åº”é˜¶æ®µã€‚
                                                aiResponseContent = ''; 
                                            }
                                        } else if (data.type === 'error') {
                                            chatMessages.value.push({ role: 'assistant', type: 'text', content: `âŒ é”™è¯¯: ${data.message}` });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }

                        // åˆ†æå®Œæˆ
                        if (isTemplateMode) {
                            try {
                                let jsonStr = aiResponseContent.trim();
                                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.substring(7);
                                if (jsonStr.startsWith('```')) jsonStr = jsonStr.substring(3);
                                if (jsonStr.endsWith('```')) jsonStr = jsonStr.substring(0, jsonStr.length - 3);
                                
                                const jsonData = JSON.parse(jsonStr);
                                const DynamicReport = {
                                    template: activeTemplate.value.vue_template,
                                    props: ['report_data']
                                };

                                chatMessages.value.push({
                                    role: 'assistant',
                                    type: 'template_render',
                                    templateName: activeTemplate.value.name,
                                    component: DynamicReport,
                                    data: jsonData
                                });
                                activeTemplate.value = null;

                            } catch (e) {
                                console.error('JSONè§£æå¤±è´¥', e);
                                chatMessages.value.push({ role: 'assistant', type: 'text', content: 'âŒ æ¨¡æ¿æ¸²æŸ“å¤±è´¥ï¼ŒåŸå§‹æ•°æ®:\n' + aiResponseContent });
                            }
                        } else {
                            // æ™®é€šæ¨¡å¼ä¸‹ï¼Œæœ€åå¯èƒ½éœ€è¦å¤„ç†ä¸€äº›æ”¶å°¾å·¥ä½œï¼Œä½†å†…å®¹å·²ç»æµå¼è¾“å‡ºäº†
                            // å¦‚æœ aiResponseContent ä¸ºç©ºï¼ˆå¯èƒ½æ˜¯çº¯å·¥å…·è°ƒç”¨ï¼‰ï¼Œå¯ä»¥ä¸åšå¤„ç†
                        }
                        
                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨ä»¥æ›´æ–°æ‘˜è¦
                        fetchConversations();

                    } catch (e) {
                        chatMessages.value.push({ role: 'assistant', type: 'text', content: `âŒ è¯·æ±‚å¼‚å¸¸: ${e.message}` });
                    } finally {
                        isAnalyzing.value = false;
                        currentStatus.value = '';
                        await nextTick();
                        scrollToBottom();
                    }
                };

                // -----------------------------------------------------------
                // æ¨¡æ¿ç®¡ç†åŠŸèƒ½
                // -----------------------------------------------------------
                const openTemplateGenerator = (htmlContent) => {
                    templateSourceHtml.value = htmlContent;
                    showTemplateGenerator.value = true;
                };

                const confirmGenerateTemplate = async () => {
                    isGeneratingTemplate.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/api/templates/generate`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({
                                html_content: templateSourceHtml.value,
                                conversation_context: templateContext.value,
                                conversation_id: currentConversationId.value
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('âœ… æ¨¡æ¿ç”ŸæˆæˆåŠŸï¼');
                            showTemplateGenerator.value = false;
                            fetchTemplates();
                        } else {
                            alert('âŒ ç”Ÿæˆå¤±è´¥: ' + data.message);
                        }
                    } catch (e) {
                        alert('âŒ å¼‚å¸¸: ' + e.message);
                    } finally {
                        isGeneratingTemplate.value = false;
                    }
                };

                const fetchTemplates = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/templates`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            templates.value = data.data;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const viewTemplateDetail = async (id) => {
                    try {
                        const res = await fetch(`${API_BASE}/api/templates/${id}`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            viewingTemplate.value = data.data;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const deleteTemplate = async (id) => {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¨¡æ¿å—ï¼Ÿ')) return;
                    try {
                        const res = await fetch(`${API_BASE}/api/templates/${id}`, { 
                            method: 'DELETE',
                            headers: getHeaders() 
                        });
                        const data = await res.json();
                        if (data.success) fetchTemplates();
                    } catch (e) {
                        alert(e.message);
                    }
                };

                const useTemplate = async (tpl) => {
                    try {
                        const res = await fetch(`${API_BASE}/api/templates/${tpl.id}`, { headers: getHeaders() });
                        const data = await res.json();
                        if (data.success) {
                            activeTemplate.value = data.data;
                            currentTab.value = 'analysis';
                            
                            // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯
                            if (!currentConversationId.value) {
                                createNewConversation();
                            }
                        }
                    } catch (e) {
                        alert('æ— æ³•åŠ è½½æ¨¡æ¿è¯¦æƒ…');
                    }
                };

                const clearActiveTemplate = () => {
                    activeTemplate.value = null;
                };

                // å·¥å…·å‡½æ•°
                const formatDate = (str) => {
                    if (!str) return '';
                    return new Date(str).toLocaleString();
                };
                
                const formatTime = (str) => {
                    if (!str) return '';
                    const date = new Date(str);
                    const now = new Date();
                    if (date.toDateString() === now.toDateString()) {
                        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    return date.toLocaleDateString([], {month: 'numeric', day: 'numeric'});
                };

                const renderMarkdown = (text) => {
                    if (!text) return '';
                    return marked.parse(text);
                };
                
                const scrollToBottom = () => {
                    if (chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight;
                };

                // åˆå§‹åŒ–
                onMounted(() => {
                    // å¦‚æœæœ‰ä¿å­˜çš„ Keyï¼Œè‡ªåŠ¨åˆå§‹åŒ–
                    if (config.apiKey) {
                        checkStatus();
                        fetchConversations();
                        fetchTemplates();
                    } else {
                        showConfig.value = true;
                    }
                });

                return {
                    config, showConfig, saveConfig,
                    currentTab, tabs, systemStatus, checkStatus,
                    tables, handleFileUpload, deleteTable, fetchTables,
                    // èŠå¤©
                    conversations, currentConversationId, currentConversation, createNewConversation, switchConversation, deleteConversation,
                    chatMessages, userQuery, startAnalysis, isAnalyzing, currentStatus, chatBox, quickStart,
                    useCustomSystemPrompt, customSystemPrompt,
                    renderMarkdown, formatTime, formatDate,
                    // æ¨¡æ¿
                    templates, fetchTemplates, deleteTemplate,
                    showTemplateGenerator, templateSourceHtml, templateContext, isGeneratingTemplate, openTemplateGenerator, confirmGenerateTemplate,
                    viewingTemplate, viewTemplateDetail,
                    useTemplate, activeTemplate, clearActiveTemplate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
